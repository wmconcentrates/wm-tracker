<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Mousse Production Tracker - Cloud Sync</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;700&display=swap');

        :root {
            /* Electric Forest - Laser show vibes */
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #141414;
            --accent-purple: #bf00ff;
            --accent-green: #39ff14;
            --accent-blue: #00f0ff;
            --accent-orange: #ff6b00;
            --accent-red: #ff0055;
            --accent-pink: #ff10f0;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border: #222222;
            --glow-green: 0 0 20px rgba(57, 255, 20, 0.5);
            --glow-pink: 0 0 20px rgba(255, 16, 240, 0.5);
            --glow-blue: 0 0 20px rgba(0, 240, 255, 0.5);
            --glow-purple: 0 0 20px rgba(191, 0, 255, 0.5);
            font-size: 18px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            font-size: 1.1rem; /* Increased base font size */
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
        }
        
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
        }
        
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid var(--accent-orange);
            color: var(--accent-orange);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Celebration animations */
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes celebration-pop {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes bounce-in {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .celebration-content {
            text-align: center;
            animation: celebration-pop 0.5s ease-out;
            max-width: 500px;
            padding: 40px;
        }

        .celebration-emoji {
            font-size: 5rem;
            animation: bounce-in 0.6s ease-out;
            margin-bottom: 20px;
        }

        .celebration-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue), var(--accent-pink), var(--accent-green));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
            text-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
        }

        .celebration-message {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .celebration-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .celebration-stat {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid var(--accent-green);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3), inset 0 0 20px rgba(57, 255, 20, 0.05);
        }

        .celebration-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
        }

        .celebration-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .celebration-btn {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            border: 2px solid var(--accent-pink);
            padding: 15px 40px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 20px rgba(255, 16, 240, 0.4);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .celebration-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 16, 240, 0.6), 0 0 60px rgba(191, 0, 255, 0.4);
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -20px;
            animation: confetti-fall linear forwards;
            z-index: 999999;
        }

        .header {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple), var(--accent-blue));
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 40px rgba(255, 16, 240, 0.4), 0 0 80px rgba(0, 240, 255, 0.2);
            border: 1px solid rgba(255, 16, 240, 0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .header-logo {
            width: 80px;
            height: 60px;
            flex-shrink: 0;
        }

        .header-logo svg {
            width: 100%;
            height: 100%;
        }

        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .setup-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid var(--border);
        }
        
        .setup-section h2 {
            color: var(--accent-orange);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .setup-section.hidden {
            display: none;
        }
        
        .credentials-form {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: 'Work Sans', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-group select option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.05);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .help-text {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 5px;
            font-style: italic;
        }
        
        .user-login {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid var(--border);
        }
        
        .user-login h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--accent-green);
        }
        
        .user-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .user-btn {
            padding: 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .user-btn:hover {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
        }
        
        .user-btn.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }
        
        .current-user {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-green);
            font-weight: 600;
        }
        
        .station-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .station-tab {
            padding: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .station-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .station-tab.active {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
        }
        
        .station-tab h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .station-tab .icon {
            font-size: 2rem;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .badge {
            position: absolute;
            top: -8px;
            right: -12px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.3);
            display: none;
        }
        
        .badge.has-count {
            display: inline-block;
        }
        
        .station-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .station-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--border);
        }
        
        .form-section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-purple);
            font-family: 'Space Mono', monospace;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            background: rgba(147, 51, 234, 0.1);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 15px 30px;
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .batch-list {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--border);
        }
        
        .batch-list h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-green);
            font-family: 'Space Mono', monospace;
        }
        
        .batch-item {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-purple);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .batch-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .batch-id {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-purple);
        }
        
        .batch-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-intake { background: var(--accent-blue); }
        .status-extraction { background: var(--accent-orange); }
        .status-finishing { background: var(--accent-green); }
        .status-packaging { background: var(--accent-red); }
        .status-complete { background: #6b7280; }
        
        .batch-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .batch-detail {
            display: flex;
            flex-direction: column;
        }
        
        .batch-detail-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .batch-detail-value {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 1rem;
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-small:hover {
            background: #7c3aed;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            border-color: var(--accent-purple);
        }
        
        .filter-btn.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 15px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-purple);
            border: 2px solid var(--bg-primary);
        }
        
        .timeline-content {
            background: rgba(147, 51, 234, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-purple);
        }
        
        .timeline-user {
            font-weight: 600;
            color: var(--accent-purple);
        }
        
        .timeline-date {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--border);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-purple);
            font-family: 'Space Mono', monospace;
        }
        
        .stat-label {
            font-size: 1.05rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        
        .leaflink-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--accent-blue);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .leaflink-section h3 {
            color: var(--accent-blue);
            margin-bottom: 15px;
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .analytics-table th {
            background: var(--bg-tertiary);
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 1rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .analytics-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 1.05rem;
        }

        .analytics-table tr:hover {
            background: rgba(147, 51, 234, 0.05);
        }

        .profit-positive {
            color: var(--accent-green);
            font-weight: 600;
        }

        .profit-negative {
            color: var(--accent-red);
            font-weight: 600;
        }

        /* METRC Manifest hover effects */
        #manifestsContainer > div:hover {
            background: rgba(147, 51, 234, 0.1) !important;
            border-color: var(--accent-purple) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(147, 51, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="connection-status connecting" id="connectionStatus">
        <div class="status-dot"></div>
        <span id="statusText">Connecting...</span>
    </div>
    
    <button id="myStatsBtn" onclick="openPersonalStatsModal()" style="position: fixed; top: 20px; left: 20px; z-index: 999; background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3); transition: all 0.3s ease; display: none;">
        üë§ My Workload
    </button>

    <!-- Setup Section -->
    <div class="setup-section" id="setupSection">
        <h2>‚öôÔ∏è Supabase Configuration</h2>
        <p style="margin-bottom: 20px; color: var(--text-secondary);">
            Enter your Supabase credentials once. They'll be saved securely in your browser.
        </p>
        <form class="credentials-form" id="credentialsForm">
            <div class="form-group">
                <label>Supabase Project URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" required>
                <div class="help-text">Found in Project Settings ‚Üí API ‚Üí Project URL</div>
            </div>
            <div class="form-group">
                <label>Supabase Anon/Public Key</label>
                <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
                <div class="help-text">Found in Project Settings ‚Üí API ‚Üí Project API keys ‚Üí anon public</div>
            </div>
            <button type="submit" class="btn">Connect to Supabase</button>
        </form>
        <div style="margin-top: 20px; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-orange);">
            <strong>First Time Setup:</strong> After connecting, I'll automatically create the required database table for you.
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-content">
                <div class="header-logo">
                    <svg viewBox="0 0 120 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 5 5 L 25 65 L 40 15 L 55 65 L 70 15 L 90 65 L 115 5"
                              stroke="white"
                              stroke-width="7"
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                    </svg>
                </div>
                <div>
                    <h1>White Mousse Production Tracker</h1>
                    <p>Complete trim-to-product workflow tracking ‚Ä¢ Cloud synced across all stations</p>
                </div>
            </div>
        </div>

        <div class="user-login" id="userLogin">
            <h2>üîê Enter Your PIN</h2>
            <form id="pinForm" style="max-width: 300px; margin: 0 auto;" onsubmit="event.preventDefault(); login();">
                <input type="password" 
                       id="pinInput" 
                       maxlength="4" 
                       pattern="[0-9]{4}" 
                       placeholder="Enter 4-digit PIN"
                       inputmode="numeric"
                       autocomplete="off"
                       style="width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 10px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 10px; color: var(--text-primary); font-family: 'Space Mono', monospace; margin-bottom: 15px;">
                <button type="submit" id="loginBtn" style="width: 100%; padding: 15px; background: var(--accent-purple); border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer;">Login</button>
                <div id="loginError" style="color: var(--accent-red); text-align: center; margin-top: 10px; display: none;">Invalid PIN</div>
            </form>
            <div class="current-user" id="currentUser" style="display: none; margin-top: 15px;">
                Logged in as: <span id="userName"></span>
                <button onclick="logout()" style="margin-left: 15px; padding: 8px 15px; background: var(--accent-red); border: none; border-radius: 5px; color: white; cursor: pointer;">Logout</button>
            </div>
        </div>

        <div id="appContent" style="display: none;">
        <div class="station-tabs">
            <div class="station-tab active" data-station="intake">
                <div class="icon">üì¶</div>
                <h3>Intake</h3>
                <p>Log trim batches</p>
            </div>
            <div class="station-tab" data-station="extraction">
                <div class="icon">‚öóÔ∏è<span class="badge" id="badge-extraction">0</span></div>
                <h3>Extraction</h3>
                <p>Process batches</p>
            </div>
            <div class="station-tab" data-station="finishing">
                <div class="icon">‚ú®<span class="badge" id="badge-finishing">0</span></div>
                <h3>Post Extraction</h3>
                <p>Bulk weight & splitting</p>
            </div>
            <div class="station-tab" data-station="packaging">
                <div class="icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><ellipse cx="6" cy="6" rx="4" ry="2"/><path d="M6 8c-2.2 0-4-.9-4-2v0M10 6c0 1.1-1.8 2-4 2"/><line x1="8" y1="7" x2="16" y2="15"/><path d="M14 17c0-1.5 1.5-3 4-3s4 1.5 4 3v2c0 1.1-1.8 2-4 2s-4-.9-4-2v-2z"/><path d="M12 13l-1 2"/><path d="M13 14l-1 2"/></svg><span class="badge" id="badge-packaging">0</span></div>
                <h3>Packaging</h3>
                <p>Final count & listing</p>
            </div>
            <div class="station-tab" data-station="testing">
                <div class="icon">üß™<span class="badge" id="badge-testing">0</span></div>
                <h3>Testing</h3>
                <p>Test results entry</p>
            </div>
            <div class="station-tab" data-station="labeling">
                <div class="icon">üè∑Ô∏è<span class="badge" id="badge-labeling">0</span></div>
                <h3>Labeling</h3>
                <p>Print & apply labels</p>
            </div>
            <div class="station-tab" data-station="analytics">
                <div class="icon">üí∞</div>
                <h3>Analytics</h3>
                <p>Yield & Cost</p>
            </div>
            <div class="station-tab" data-station="performance">
                <div class="icon">üë•</div>
                <h3>Performance</h3>
                <p>Employee Stats</p>
            </div>
            <div class="station-tab" data-station="dashboard">
                <div class="icon">üìà</div>
                <h3>Dashboard</h3>
                <p>View all batches</p>
            </div>
        </div>

        <!-- Intake Station -->
        <div class="station-content active" id="intake">
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üì¶ New Trim Intake</h2>
                    <button type="button" class="btn" style="background: var(--accent-blue);" onclick="openMetrcImport()">
                        üìã Import from METRC Manifest
                    </button>
                </div>
                <form id="intakeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Batch ID (Auto-Generated)</label>
                            <input type="text" id="batchId" readonly>
                        </div>
                        <div class="form-group">
                            <label>Strain Name</label>
                            <input type="text" id="strainName" required>
                        </div>
                        <div class="form-group">
                            <label>Trim Weight (grams)</label>
                            <input type="number" id="trimWeight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Cost of Material ($)</label>
                            <input type="number" id="materialCost" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Material Agreement Type</label>
                            <select id="materialAgreement" required>
                                <option value="">Select Type</option>
                                <option value="Wholesale">Wholesale Purchase (100% owned)</option>
                                <option value="50-50 Split">50/50 Split (customer gets 50% yield)</option>
                                <option value="Custom Buyback">Custom Buyback</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pre-Sift Before BHO?</label>
                            <select id="preSift" required>
                                <option value="no">No - Direct to BHO</option>
                                <option value="yes">Yes - Sift first</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cultivation License # (Grower)</label>
                            <input type="text" id="cultivationLicense" placeholder="403R-01007 or 404R-00000" required>
                            <div class="help-text">Grower's license number (cultivation or manufacturing)</div>
                        </div>
                        <div class="form-group">
                            <label>Grower Name (Optional)</label>
                            <input type="text" id="growerName" placeholder="Farm/supplier name">
                        </div>
                        <div class="form-group">
                            <label>METRC Tag Numbers (last 4-5 digits)</label>
                            <input type="text" id="metrcTags" placeholder="e.g., 12345, 67890, 11223">
                            <div class="help-text">Multiple tags separated by commas. Use last 4-5 digits only.</div>
                        </div>
                        <div class="form-group">
                            <label>Intake Date</label>
                            <input type="date" id="intakeDate" required>
                        </div>
                        <div class="form-group">
                            <label>Strain Type</label>
                            <select id="strainType" required>
                                <option value="">Select Type</option>
                                <option value="Indica">Indica (Blue Lid)</option>
                                <option value="Sativa">Sativa (Red Lid)</option>
                                <option value="Hybrid">Hybrid (Green Lid)</option>
                                <option value="Dealer's Choice">Dealer's Choice (Decide at Testing)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Planned Products</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Live Resin Carts">
                                <span>Live Resin Carts</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Wax">
                                <span>Wax</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Sugar Wax">
                                <span>Sugar Wax</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Shatter">
                                <span>Shatter</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Extractor's Choice">
                                <span>Extractor's Choice</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Brick Hash" id="brickHash">
                                <span>Brick Hash</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="Hash Hits" id="hashHits">
                                <span>Hash Hits</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="products" value="RSO Syringes">
                                <span>RSO Syringes</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="intakeNotes" placeholder="Any special notes about this batch..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-purple)); flex: 1;" onclick="testPrintBatchLabel()">
                            üñ®Ô∏è Print Label
                        </button>
                        <button type="submit" class="btn" style="flex: 2;">Submit Intake</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Extraction Station -->
        <div class="station-content" id="extraction">
            <div class="form-section">
                <h2>‚öóÔ∏è Extraction Processing</h2>
                
                <!-- Gas Tracking Button -->
                <div style="margin-bottom: 25px;">
                    <button class="btn" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); padding: 20px; width: 100%; font-size: 1.1rem;" onclick="openSuppliesModal()">
                        <div style="font-weight: 700; margin-bottom: 10px;">üõ¢Ô∏è Extraction Supplies</div>
                        <div style="display: flex; justify-content: center; gap: 30px; font-size: 0.95rem;">
                            <span>Butane: <strong id="btnButaneDisplay">0 lbs</strong></span>
                            <span>Nitrogen: <strong id="btnNitrogenDisplay">0 tanks</strong></span>
                        </div>
                    </button>
                </div>
                
                <!-- Machine Status Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button class="btn" style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); padding: 20px; text-align: left;" onclick="openMachineModal('left')">
                        <div style="font-weight: 700; margin-bottom: 8px;">‚öóÔ∏è Left Machine</div>
                        <div id="leftMachineStatus" style="font-size: 0.85rem; opacity: 0.9;">
                            <div>Col A: <span id="leftColumnBatch">Empty</span></div>
                            <div>Col B: <span id="leftColumnBBatch">Empty</span></div>
                            <div>Pot: <span id="leftPotBatch">Empty</span></div>
                            <div>Filter: <span id="leftFilterStatus">Not loaded</span></div>
                        </div>
                    </button>
                    <button class="btn" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); padding: 20px; text-align: left;" onclick="openMachineModal('right')">
                        <div style="font-weight: 700; margin-bottom: 8px;">‚öóÔ∏è Right Machine</div>
                        <div id="rightMachineStatus" style="font-size: 0.85rem; opacity: 0.9;">
                            <div>Col A: <span id="rightColumnBatch">Empty</span></div>
                            <div>Col B: <span id="rightColumnBBatch">Empty</span></div>
                            <div>Pot: <span id="rightPotBatch">Empty</span></div>
                            <div>Filter: <span id="rightFilterStatus">Not loaded</span></div>
                        </div>
                    </button>
                </div>
                
                <!-- Pull Batch Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                    <button class="btn" style="background: var(--accent-green); padding: 15px; font-weight: 600;" onclick="openPullBatchModal('left')">
                        ü´ô Pull Batch (Left)
                    </button>
                    <button class="btn" style="background: var(--accent-green); padding: 15px; font-weight: 600;" onclick="openPullBatchModal('right')">
                        ü´ô Pull Batch (Right)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Finishing Station -->
        <!-- Post Extraction Station -->
        <div class="station-content" id="finishing">
            <div class="form-section">
                <h2>‚ú® Post Extraction & Batch Splitting</h2>
                <div class="form-group">
                    <label>Select Batch to Finish</label>
                    <select id="finishingBatchSelect" required>
                        <option value="">Select a batch...</option>
                    </select>
                </div>
                
                <div id="finishingForm" style="display: none;">
                    <div id="batchInfo" style="background: var(--bg-tertiary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Batch Details</h3>
                        <div id="batchInfoContent"></div>
                    </div>

                    <div class="form-group">
                        <label>Split this batch into multiple products?</label>
                        <select id="splitBatch" required>
                            <option value="no">No - Single product batch</option>
                            <option value="yes">Yes - Split into sub-batches</option>
                        </select>
                    </div>

                    <!-- Single Product Finishing -->
                    <div id="singleFinishing">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Finishing Date</label>
                                <input type="date" id="finishingDate" required>
                            </div>
                            <div class="form-group">
                                <label>Final Bulk Weight (grams)</label>
                                <input type="number" id="finalWeight" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label>Sample Weight Pulled (grams)</label>
                                <input type="number" id="sampleWeight" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>QC Notes</label>
                            <textarea id="finishingNotes" placeholder="Quality observations, color, consistency, issues..."></textarea>
                        </div>
                        
                        <button type="button" class="btn" onclick="submitFinishing()">Complete Finishing</button>
                    </div>

                    <!-- Split Batch Finishing -->
                    <div id="splitFinishing" style="display: none;">
                        <h3 style="color: var(--accent-green); margin: 20px 0 15px 0; font-size: 1.2rem;">Divide Batch Into Products</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Specify how much material goes to each product. System will create sub-batches.</p>
                        
                        <div id="splitProducts">
                            <div class="split-product-item" style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                                <h4 style="color: var(--accent-purple); margin-bottom: 15px;">Product 1</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Product Type</label>
                                        <select class="splitProductType" required>
                                            <option value="">Select Product</option>
                                            <option value="Wax">Wax</option>
                                            <option value="Sugar Wax">Sugar Wax</option>
                                            <option value="Shatter">Shatter</option>
                                            <option value="Live Resin Oil">Live Resin Oil (Carts)</option>
                                            <option value="Brick Hash">Brick Hash</option>
                                            <option value="Hash Hits">Hash Hits</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Weight Allocated (grams)</label>
                                        <input type="number" class="splitWeight" step="0.1" required>
                                    </div>
                                </div>
                            </div>

                            <div class="split-product-item" style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                                <h4 style="color: var(--accent-purple); margin-bottom: 15px;">Product 2</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Product Type</label>
                                        <select class="splitProductType" required>
                                            <option value="">Select Product</option>
                                            <option value="Wax">Wax</option>
                                            <option value="Sugar Wax">Sugar Wax</option>
                                            <option value="Shatter">Shatter</option>
                                            <option value="Live Resin Oil">Live Resin Oil (Carts)</option>
                                            <option value="Brick Hash">Brick Hash</option>
                                            <option value="Hash Hits">Hash Hits</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Weight Allocated (grams)</label>
                                        <input type="number" class="splitWeight" step="0.1" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn" style="background: var(--accent-blue); margin-right: 10px;" onclick="addSplitProduct()">+ Add Another Product</button>
                        <button type="button" class="btn" onclick="submitSplitBatch()">Create Sub-Batches</button>
                        
                        <div id="splitValidation" style="margin-top: 15px; padding: 15px; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packaging Station -->
        <div class="station-content" id="packaging">
            <div class="form-section">
                <h2>üìä Packaging & Listing</h2>
                <div class="form-group">
                    <label>Select Batch to Package</label>
                    <select id="packagingBatchSelect" required>
                        <option value="">Select a batch...</option>
                    </select>
                </div>
                
                <div id="packagingForm" style="display: none;">
                    <!-- Strain Type Indicator for Lid Color -->
                    <div id="strainTypeAlert" style="display: none; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 4px solid;">
                        <div style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">LID COLOR</div>
                        <div id="strainTypeName" style="font-size: 2.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px;"></div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Packaging Date</label>
                            <input type="date" id="packagingDate" required>
                        </div>
                        <div class="form-group">
                            <label>Primary Product Type</label>
                            <select id="packagedProductType" required>
                                <option value="">Select Type</option>
                                <option value="Live Resin Carts">Live Resin Carts (.5g)</option>
                                <option value="Live AIO">Live All-In-One (AIO)</option>
                                <option value="Wax/Sugar">Wax/Sugar Wax (1g & 4g)</option>
                                <option value="Shatter">Shatter (1g)</option>
                                <option value="Brick Hash">Brick Hash (1g & 4g)</option>
                                <option value="Hash Hits">Hash Hits (2-pack & 5-pack)</option>
                                <option value="RSO Syringe">RSO Syringes</option>
                                <option value="Bulk Sale">üéØ Bulk Sale (Skip Labeling)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Multi-size packaging section -->
                    <div id="multiSizeSection" style="display: none;">
                        <h3 style="color: var(--accent-green); margin: 20px 0 15px 0; font-size: 1.2rem;">Package Sizes</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>1g Units</label>
                                <input type="number" id="units1g" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>4g Units</label>
                                <input type="number" id="units4g" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Total Grams Calculated</label>
                                <input type="number" id="totalGramsCalc" readonly style="background: var(--bg-primary); color: var(--accent-green); font-weight: 700;">
                            </div>
                            <div class="form-group">
                                <label>Total Units (Combined)</label>
                                <input type="number" id="totalUnitsCalc" readonly style="background: var(--bg-primary); color: var(--accent-green); font-weight: 700;">
                            </div>
                        </div>
                    </div>

                    <!-- Single size packaging section -->
                    <div id="singleSizeSection">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Total Units/Eaches</label>
                                <input type="number" id="unitsPackaged" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="display: none;">
                        <input type="number" id="wholesalePrice" step="0.01" min="0" value="0" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label>Packaging Notes</label>
                        <textarea id="packagingNotes" placeholder="Any issues, special packaging notes..."></textarea>
                    </div>
                    
                    <!-- Bulk Sale Alert -->
                    <div id="bulkSaleAlert" style="display: none; background: rgba(16, 185, 129, 0.15); border-left: 4px solid var(--accent-green); padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong>üéØ Bulk Sale Selected</strong>
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary);">
                            This batch will be marked as complete and will skip the labeling process. It will not appear in the labeling queue.
                        </p>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.15); border-left: 4px solid var(--accent-blue); padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong>üí° Workflow Options:</strong>
                        <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                            <li><strong>Start Packaging:</strong> Mark batch as in-progress (tracking only, can finish later)</li>
                            <li><strong>Pause/Resume:</strong> Temporarily pause work (breaks, end of shift, equipment issues)</li>
                            <li><strong>Complete Packaging:</strong> Finish packaging (skips "start" if single session)</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn" style="background: var(--accent-blue); flex: 1; min-width: 200px;" onclick="startPackaging()">‚ñ∂Ô∏è Start Packaging</button>
                        <button type="button" class="btn" id="pausePackagingBtn" style="background: var(--accent-orange); flex: 1; min-width: 200px; display: none;" onclick="togglePausePackaging()">‚è∏Ô∏è Pause</button>
                        <button type="button" class="btn" style="background: var(--accent-green); flex: 1; min-width: 200px;" onclick="submitPackaging()">‚úÖ Complete Packaging</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing Station -->
        <div class="station-content" id="testing">
            <div class="form-section">
                <h2>üß™ Test Results Entry</h2>
                <div class="form-group">
                    <label>Select Batch for Test Results</label>
                    <select id="testingBatchSelect" required>
                        <option value="">Select a batch...</option>
                    </select>
                </div>
                
                <div id="testingForm" style="display: none;">
                    <div id="currentTestInfo" style="background: var(--bg-tertiary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Current Batch Info</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: var(--accent-orange);">Current Batch ID:</strong> 
                                <span id="currentBatchIdDisplay" style="font-family: 'Space Mono', monospace; font-size: 1.2rem; font-weight: 700; color: var(--accent-green);"></span>
                            </div>
                        </div>
                        <div id="testBatchDetails"></div>
                    </div>

                    <!-- Batch ID Reassignment -->
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(147, 51, 234, 0.15)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-orange);">
                        <h3 style="color: var(--accent-orange); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span>üìã</span> Assign New Batch Number
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; line-height: 1.5;">
                            Protocol: M.D.XXXX (expiration month.day.last 4 of METRC tag)
                        </p>
                        <div class="form-grid">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Last 4 Digits of New METRC Tag</label>
                                <input type="text" id="metrcLast4" maxlength="4" placeholder="e.g., 5678" style="font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700;">
                                <div class="help-text">From the testing package tag</div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Generated Batch ID</label>
                                <input type="text" id="newBatchId" readonly placeholder="Auto-generated from expiration date" style="font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; background: var(--bg-primary); color: var(--accent-green);">
                                <div class="help-text">Format: M.D.XXXX (e.g., 3.21.1234)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Name Section -->
                    <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(59, 130, 246, 0.15)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-purple);">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span>üè∑Ô∏è</span> Final Product Name & Classification
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; line-height: 1.5;">
                            This will become the batch's display name and lid color. The original strain info is preserved in notes for compliance.
                        </p>
                        <div id="dealersChoiceAlert" style="display: none; background: rgba(245, 158, 11, 0.2); border: 2px solid var(--accent-orange); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong style="color: var(--accent-orange);">üé≤ Dealer's Choice Batch</strong>
                            <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">This batch was marked for dealer's choice at intake. Select the final strain type below.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Product Name</label>
                                <input type="text" id="finalProductName" placeholder="e.g., Blue Dream Live Resin, Gelato Sugar Wax" required>
                                <div class="help-text">Becomes the batch name in all views</div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Strain Type (Lid Color)</label>
                                <select id="finalStrainType" required>
                                    <option value="Indica">Indica (Blue Lid)</option>
                                    <option value="Sativa">Sativa (Red Lid)</option>
                                    <option value="Hybrid">Hybrid (Green Lid)</option>
                                </select>
                                <div class="help-text">Redesignate if needed for wholesale variety</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date Submitted to Lab</label>
                            <input type="date" id="testSubmittedDate" required>
                        </div>
                        <div class="form-group">
                            <label>Expiration Date</label>
                            <input type="date" id="testExpirationDate" required>
                        </div>
                        <div class="form-group">
                            <label>Test Results Received Date</label>
                            <input type="date" id="testResultsReceivedDate" required>
                        </div>
                        <div class="form-group">
                            <label>RTA (Full Panel)?</label>
                            <select id="isRTA" required>
                                <option value="no">No - Standard Potency Only</option>
                                <option value="yes">Yes - Full Panel RTA</option>
                            </select>
                            <div class="help-text">Full panel RTA required once per month</div>
                        </div>
                        <div class="form-group">
                            <label>THC % (if results received)</label>
                            <input type="number" id="testThcPercent" step="0.01" placeholder="Enter when results arrive">
                        </div>
                        <div class="form-group">
                            <label>CBD % (if results received)</label>
                            <input type="number" id="testCbdPercent" step="0.01" placeholder="Enter when results arrive">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Test Results Notes</label>
                        <textarea id="testResultsNotes" placeholder="Any issues, terpene highlights, pass/fail status..."></textarea>
                    </div>
                    
                    <button type="button" class="btn" onclick="submitTestResults()">Save Test Results</button>
                </div>

                <!-- RTA Reminder -->
                <div id="rtaReminder" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Labeling Station -->
        <div class="station-content" id="labeling">
            <div class="form-section">
                <h2>üè∑Ô∏è Label Printing & Application</h2>
                
                <div class="form-group">
                    <label>Select Batch to Label</label>
                    <select id="labelingBatchSelect" required>
                        <option value="">Select a batch...</option>
                    </select>
                </div>
                
                <div id="labelingForm" style="display: none;">
                    <!-- Batch Info Display -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--accent-purple);">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Label Information</h3>
                        <div id="labelPreview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- Auto-populated from batch data -->
                        </div>
                    </div>

                    <!-- Weight Verification -->
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--accent-green);">
                        <h3 style="color: var(--accent-green); margin-bottom: 15px;">üìä Total Grams Labeled</h3>
                        
                        <div class="form-group">
                            <label>Total Grams Labeled (weighed after labeling)</label>
                            <input type="number" id="gramsLabeled" step="0.1" placeholder="Total weight with labels" required>
                            <div class="help-text">Actual weight after all labels applied</div>
                        </div>

                        <!-- Expected Weight Display -->
                        <div id="expectedWeightDisplay" style="padding: 15px; background: var(--bg-primary); border-radius: 8px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Expected Weight (from packaging)</div>
                                    <div id="expectedWeight" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-blue); font-family: 'Space Mono', monospace;">-</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Actual Weight Labeled</div>
                                    <div id="actualWeight" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green); font-family: 'Space Mono', monospace;">-</div>
                                </div>
                            </div>
                            <div id="discrepancyAlert" style="display: none; margin-top: 15px; padding: 15px; background: rgba(239, 68, 68, 0.2); border: 2px solid var(--accent-red); border-radius: 8px;">
                                <div style="color: var(--accent-red); font-weight: 700; margin-bottom: 10px;">‚ö†Ô∏è Weight Discrepancy Detected</div>
                                <div id="discrepancyDetails" style="color: var(--text-primary); margin-bottom: 15px;"></div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="acceptDiscrepancy" style="width: 20px; height: 20px;">
                                    <span style="font-weight: 600;">I verify this weight is correct and accept the discrepancy</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Mark as Labeled -->
                    <div class="form-group">
                        <label>Labeling Notes</label>
                        <textarea id="labelingNotes" placeholder="Any issues with labeling, printer problems, etc..."></textarea>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.15); border-left: 4px solid var(--accent-blue); padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong>üí° Workflow Options:</strong>
                        <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                            <li><strong>Print Labels:</strong> Open printable label page (use browser print)</li>
                            <li><strong>Start Labeling:</strong> Mark batch as in-progress (tracking only, can finish later)</li>
                            <li><strong>Pause/Resume:</strong> Temporarily pause work (breaks, end of shift, equipment issues)</li>
                            <li><strong>Complete Labeling:</strong> Finish labeling with weight verification</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); flex: 1; min-width: 200px;" onclick="openPrintableLabels()">üñ®Ô∏è Print Labels</button>
                        <button type="button" class="btn" style="background: var(--accent-blue); flex: 1; min-width: 200px;" onclick="startLabeling()">‚ñ∂Ô∏è Start Labeling</button>
                        <button type="button" class="btn" id="pauseLabelingBtn" style="background: var(--accent-orange); flex: 1; min-width: 200px; display: none;" onclick="togglePauseLabeling()">‚è∏Ô∏è Pause</button>
                        <button type="button" class="btn" style="background: var(--accent-green); flex: 1; min-width: 200px;" onclick="markAsLabeled()">‚úÖ Complete Labeling</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics -->
        <div class="station-content" id="analytics">
            <h2 style="margin-bottom: 30px;">üìä Completed Batches Analytics</h2>
            
            <!-- Summary Stats -->
            <div class="stats-grid" style="margin-bottom: 40px;">
                <div class="stat-card">
                    <div class="stat-value" id="avgYield">0%</div>
                    <div class="stat-label">Average Yield</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgThc">0%</div>
                    <div class="stat-label">Average THC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgProcessingTime">0d</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgCostPerGram">$0</div>
                    <div class="stat-label">Avg Cost Per Gram</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar" style="margin-bottom: 30px;">
                <button class="filter-btn active" data-filter-analytics="all" onclick="filterAnalytics('all')">All Completed</button>
                <button class="filter-btn" data-filter-analytics="thisMonth" onclick="filterAnalytics('thisMonth')">This Month</button>
                <button class="filter-btn" data-filter-analytics="lastMonth" onclick="filterAnalytics('lastMonth')">Last Month</button>
            </div>

            <!-- Batch Cards Grid -->
            <div id="completedBatchesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;"></div>
        </div>

        <!-- Batch Details Modal -->
        <div id="batchDetailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto;">
            <div style="max-width: 1000px; margin: 50px auto; background: var(--bg-secondary); border-radius: 16px; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 id="modalBatchId" style="color: var(--accent-green); font-family: 'Space Mono', monospace;">WM-1001</h2>
                    <button onclick="closeBatchDetails()" style="background: none; border: none; color: var(--text-primary); font-size: 2.5rem; cursor: pointer; padding: 0; width: 50px; height: 50px; line-height: 40px;">&times;</button>
                </div>
                
                <!-- Batch Overview -->
                <div id="modalBatchOverview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;"></div>
                
                <!-- Processing Timeline Visualization -->
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 20px;">‚è±Ô∏è Processing Timeline</h3>
                    <div id="modalTimeline"></div>
                </div>
                
                <!-- Performance Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--accent-green); margin-bottom: 15px;">üí∞ Economics</h4>
                        <div id="modalEconomics"></div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--accent-blue); margin-bottom: 15px;">üß™ Testing Results</h4>
                        <div id="modalTesting"></div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--accent-orange); margin-bottom: 15px;">üì¶ Production</h4>
                        <div id="modalProduction"></div>
                    </div>
                </div>
                
                <!-- Team Members -->
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üë• Team Members</h3>
                    <div id="modalTeam"></div>
                </div>
            </div>
        </div>

        <!-- Performance Station -->
        <div class="station-content" id="performance">
            <div class="form-section">
                <h2>üë• Employee Performance Analytics</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Production tracking ‚Ä¢ Real-time staffing insights</p>
                
                <!-- Today's Production Summary -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2)); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-green);">
                    <h3 style="color: var(--accent-green); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; font-size: 1.5rem;">
                        <span>üìä</span>
                        <span>Today's Production Summary</span>
                        <span id="todayDate" style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 400; margin-left: auto;"></span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-orange);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">‚öóÔ∏è Trim Extracted</div>
                            <div id="todayTrimExtracted" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-orange); font-family: 'Space Mono', monospace;">0g</div>
                            <div id="todayTrimBatches" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0 batches</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üî• Post-Processing Finished</div>
                            <div id="todayFinished" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue); font-family: 'Space Mono', monospace;">0g</div>
                            <div id="todayFinishedBatches" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0 batches</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-purple);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üì¶ Units Packaged</div>
                            <div id="todayPackaged" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-purple); font-family: 'Space Mono', monospace;">0</div>
                            <div id="todayPackagedWeight" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0g total</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üè∑Ô∏è Units Labeled</div>
                            <div id="todayLabeled" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); font-family: 'Space Mono', monospace;">0</div>
                            <div id="todayLabeledWeight" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0g total</div>
                        </div>
                    </div>
                </div>
                
                <!-- Login Activity Tracker -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-blue);">
                    <h3 style="color: var(--accent-blue); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üë•</span>
                        <span>Team Activity & Login Tracker</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--accent-green); margin-bottom: 10px;">üü¢ Currently Active</div>
                            <div id="activeUsers" style="font-size: 0.9rem; color: var(--text-primary);">Loading...</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--accent-blue); margin-bottom: 10px;">üìÖ Recent Logins (Last 24h)</div>
                            <div id="recentLogins" style="font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto;">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Time Period Selector -->
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>Time Period:</label>
                        <select id="performanceTimeRange" onchange="renderPerformanceAnalytics()">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>Filter by Employee:</label>
                        <select id="performanceFilter" onchange="renderPerformanceAnalytics()">
                            <option value="all">All Employees</option>
                            <option value="Ryan (Admin)">Ryan (Admin) - PIN: 1827</option>
                            <option value="Alex">Alex - PIN: 1980</option>
                            <option value="Paige">Paige - PIN: 1992</option>
                            <option value="Donald">Donald - PIN: 1425</option>
                            <option value="Andrew">Andrew - PIN: 2817</option>
                            <option value="Tobias">Tobias - PIN: 4200</option>
                            <option value="Jeremy">Jeremy - PIN: 0710</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>View Mode:</label>
                        <select id="performanceViewMode" onchange="renderPerformanceAnalytics()">
                            <option value="overview">Production Overview</option>
                            <option value="packaging">Packaging Detail</option>
                            <option value="labeling">Labeling Detail</option>
                            <option value="extraction">Extraction Detail</option>
                        </select>
                    </div>
                </div>

                <!-- Company-Wide Production Summary (respects time range) -->
                <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2)); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-orange);">
                    <h3 style="color: var(--accent-orange); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; font-size: 1.5rem;">
                        <span>üè¢</span>
                        <span>Company Production Summary</span>
                        <span id="companyPeriodRange" style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 400; margin-left: auto;"></span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-orange);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">‚öóÔ∏è Trim Extracted</div>
                            <div id="companyTrimExtracted" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-orange); font-family: 'Space Mono', monospace;">0g</div>
                            <div id="companyTrimBatches" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0 batches</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üî• Post-Processing Finished</div>
                            <div id="companyFinished" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue); font-family: 'Space Mono', monospace;">0g</div>
                            <div id="companyFinishedBatches" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0 batches</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-purple);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üì¶ Units Packaged</div>
                            <div id="companyPackaged" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-purple); font-family: 'Space Mono', monospace;">0</div>
                            <div id="companyPackagedWeight" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0g total</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">üè∑Ô∏è Units Labeled</div>
                            <div id="companyLabeled" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); font-family: 'Space Mono', monospace;">0</div>
                            <div id="companyLabeledWeight" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0g total</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>View Mode:</label>
                        <select id="performanceViewMode" onchange="renderPerformanceAnalytics()">
                            <option value="overview">Production Overview</option>
                            <option value="packaging">Packaging Detail</option>
                            <option value="labeling">Labeling Detail</option>
                            <option value="extraction">Extraction Detail</option>
                        </select>
                    </div>
                </div>

                <!-- Individual Performance Cards -->
                <div id="performanceStats" style="margin-top: 30px;"></div>
                
                <!-- Staffing Recommendations -->
                <div id="staffingRecommendations" style="margin-top: 40px;"></div>
            </div>

            <div class="form-section">
                <h2>üéØ Production Targets & Capacity Planning</h2>
                <div id="targetSettings" style="margin-bottom: 30px;">
                    <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 15px; border: 2px solid var(--accent-orange);">
                        <h3 style="color: var(--accent-orange); margin-bottom: 20px;">Set Daily Production Targets</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Packaging Target (units/day):</label>
                                <input type="number" id="targetPackagingUnits" value="200" min="0" style="width: 100%; padding: 12px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem;" onchange="saveTargets(); renderPerformanceAnalytics();">
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">Per employee daily goal</div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Labeling Target (units/day):</label>
                                <input type="number" id="targetLabelingUnits" value="300" min="0" style="width: 100%; padding: 12px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem;" onchange="saveTargets(); renderPerformanceAnalytics();">
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">Per employee daily goal</div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Extraction Trim Target (grams/day):</label>
                                <input type="number" id="targetExtractionTrim" value="11200" min="0" step="100" style="width: 100%; padding: 12px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem;" onchange="saveTargets(); renderPerformanceAnalytics();">
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">Per employee daily trim processing goal</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="capacityPlanning"></div>
            </div>

            <div class="form-section">
                <h2>üìä Detailed Activity Timeline</h2>
                <div id="activityLog"></div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="station-content" id="dashboard">
            <!-- Personal Quick Stats -->
            <div id="personalStats" style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(59, 130, 246, 0.2)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-purple);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: var(--accent-purple); margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span>üë§</span>
                        <span id="personalStatsTitle">Your Workload</span>
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" style="background: var(--accent-orange); padding: 10px 20px;" onclick="recalculateAllSubBatchYields()">
                            üîÑ Fix Sub-Batch Yields
                        </button>
                        <button class="btn" style="background: var(--accent-green); padding: 10px 20px;" onclick="showDailyReportPopup()">
                            üìä Daily Report
                        </button>
                    </div>
                </div>
                <div id="personalStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- System-Wide Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalBatches">0</div>
                    <div class="stat-label">Total Batches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeBatches">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedBatches">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalGramsIn">0g</div>
                    <div class="stat-label">Total Trim In</div>
                </div>
                <div class="stat-card" id="weightDiscrepancyCard" style="display: none;">
                    <div class="stat-value" id="totalWeightLoss" style="color: var(--accent-orange);">0g</div>
                    <div class="stat-label">‚ö†Ô∏è Weight Loss (Bulk‚ÜíLabel)</div>
                </div>
            </div>

            <div class="batch-list">
                <h2>üìã All Production Batches</h2>
                <div class="filter-bar">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="intake">Intake</button>
                    <button class="filter-btn" data-filter="extraction">Extraction</button>
                    <button class="filter-btn" data-filter="finishing">Post Extraction</button>
                    <button class="filter-btn" data-filter="packaging">Packaging</button>
                    <button class="filter-btn" data-filter="testing">Testing</button>
                    <button class="filter-btn" data-filter="labeling">Labeling</button>
                    <button class="filter-btn" data-filter="complete">Complete</button>
                    <div class="search-box">
                        <input type="text" id="searchBatches" placeholder="Search batches...">
                    </div>
                </div>
                <div id="batchesList"></div>
            </div>
        </div>
        </div><!-- end appContent -->
    </div>

    <!-- Edit Batch Modal -->
    <div id="editBatchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 800px; margin: 50px auto; background: var(--bg-secondary); border-radius: 16px; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--accent-orange);">‚úèÔ∏è Edit Batch</h2>
                <button onclick="closeEditBatch()" style="background: none; border: none; color: var(--text-primary); font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px;">&times;</button>
            </div>
            
            <div id="editBatchForm">
                <input type="hidden" id="originalBatchId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Batch ID</label>
                        <input type="text" id="editBatchId" style="font-family: 'Space Mono', monospace; font-weight: 700; font-size: 1.2rem;">
                        <div class="help-text">Format: M.D.XXXX (e.g., 9.15.5678)</div>
                    </div>
                </div>
                
                <!-- Auto-Parsed Information -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--accent-green);">
                    <h3 style="color: var(--accent-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üîÑ</span> Auto-Parsed from Batch ID
                    </h3>
                    <div class="form-grid">
                        <div class="form-group" style="margin: 0;">
                            <label>METRC Last 4 Digits</label>
                            <input type="text" id="parsedMetrcLast4" readonly style="background: var(--bg-primary); color: var(--accent-green); font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; text-align: center;">
                            <div class="help-text">Extracted from batch ID</div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expiration Date</label>
                            <input type="date" id="parsedExpirationDate" readonly style="background: var(--bg-primary); color: var(--accent-green); font-size: 1.1rem; font-weight: 700;">
                            <div class="help-text">Calculated from batch ID month.day</div>
                        </div>
                    </div>
                </div>
                
                <!-- Strain Name at Top -->
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid var(--accent-purple);">
                    <div class="form-group" style="margin: 0;">
                        <label>Strain Name</label>
                        <input type="text" id="editStrainName" style="font-size: 1.4rem; font-weight: 700; padding: 16px;">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Strain Type</label>
                        <select id="editStrainType">
                            <option value="Indica">Indica (Blue Lid)</option>
                            <option value="Sativa">Sativa (Red Lid)</option>
                            <option value="Hybrid">Hybrid (Green Lid)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trim Weight (g)</label>
                        <input type="number" id="editTrimWeight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Material Cost ($)</label>
                        <input type="number" id="editMaterialCost" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Cultivation License</label>
                        <input type="text" id="editCultivationLicense">
                    </div>
                    <div class="form-group">
                        <label>Grower Name</label>
                        <input type="text" id="editGrowerName">
                    </div>
                    <div class="form-group">
                        <label>METRC Tags</label>
                        <input type="text" id="editMetrcTags" placeholder="12345, 67890">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Edit Notes (Why are you making this change?)</label>
                    <textarea id="editNotes" placeholder="Explain what you're changing and why..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" style="background: var(--accent-green); flex: 1;" onclick="saveEditedBatch()">üíæ Save Changes</button>
                    <button class="btn" style="background: var(--bg-tertiary); flex: 1;" onclick="closeEditBatch()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Sub-Batch Modal -->
    <div id="createSubBatchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 800px; margin: 50px auto; background: var(--bg-secondary); border-radius: 16px; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--accent-green);">‚ûï Create Retroactive Sub-Batch</h2>
                <button onclick="closeCreateSubBatch()" style="background: none; border: none; color: var(--text-primary); font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px;">&times;</button>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.15); border-left: 4px solid var(--accent-blue); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>‚ÑπÔ∏è About Retroactive Sub-Batches:</strong>
                <p style="margin: 8px 0 0 0; line-height: 1.6;">
                    Use this when a batch was split into multiple products, but wasn't recorded as sub-batches during production. 
                    This creates a new sub-batch with its own ID, product type, and weight from the parent batch's final weight.
                </p>
            </div>

            <div id="subBatchParentInfo" style="background: var(--bg-tertiary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Parent Batch Info</h3>
                <div id="subBatchParentDetails"></div>
            </div>
            
            <div id="createSubBatchForm">
                <input type="hidden" id="subBatchParentId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Sub-Batch ID</label>
                        <input type="text" id="newSubBatchId" readonly style="background: var(--bg-primary); font-family: 'Space Mono', monospace; font-weight: 700; color: var(--accent-green);">
                        <div class="help-text">Auto-generated from parent batch</div>
                    </div>
                    <div class="form-group">
                        <label>Product Type</label>
                        <select id="subBatchProductType" required>
                            <option value="">Select Product Type</option>
                            <option value="Wax">Wax</option>
                            <option value="Sugar Wax">Sugar Wax</option>
                            <option value="Shatter">Shatter</option>
                            <option value="Live Resin Oil">Live Resin Oil (Carts)</option>
                            <option value="Brick Hash">Brick Hash</option>
                            <option value="Hash Hits">Hash Hits</option>
                            <option value="RSO">RSO</option>
                        </select>
                        <div class="help-text">What product was this portion made into?</div>
                    </div>
                </div>
                
                <div style="background: rgba(245, 158, 11, 0.2); border-left: 4px solid var(--accent-orange); padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <strong style="color: var(--accent-orange);">‚öôÔ∏è Post-Processing Required</strong>
                    <p style="margin: 8px 0 0 0; color: var(--text-secondary);">
                        This sub-batch will be created at <strong>extraction</strong> status. The post-processor must complete it on the <strong>Post Extraction</strong> page to enter weights and finish it properly.
                    </p>
                </div>
                
                <div class="form-group">
                    <label>Notes / Reason for Retroactive Creation</label>
                    <textarea id="subBatchNotes" placeholder="Why is this sub-batch being created retroactively? What happened?" required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" style="background: var(--accent-green); flex: 1;" onclick="saveSubBatch()">‚úÖ Create Sub-Batch (Needs Post-Processing)</button>
                    <button class="btn" style="background: var(--bg-tertiary); flex: 1;" onclick="closeCreateSubBatch()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- METRC Manifest Import Modal -->
    <div id="metrcImportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 30px auto; background: var(--bg-secondary); border-radius: 20px; padding: 40px; border: 3px solid var(--accent-blue);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: var(--accent-blue); margin-bottom: 5px;">üìã Import from METRC Manifest</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Pull incoming transfers and select tags for batch intake</p>
                </div>
                <button onclick="closeMetrcImport()" style="background: none; border: none; color: var(--text-primary); font-size: 2.5rem; cursor: pointer; padding: 0; width: 50px; height: 50px; line-height: 40px;">&times;</button>
            </div>
            
            <!-- METRC API Configuration -->
            <div id="metrcConfigSection" style="background: rgba(59, 130, 246, 0.1); border: 2px solid var(--accent-blue); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: var(--accent-blue); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span>üîë</span> METRC API Credentials
                    <span id="metrcConfigStatus" style="margin-left: auto; font-size: 0.85rem; padding: 5px 12px; border-radius: 15px;"></span>
                </h3>
                
                <div style="background: rgba(59, 130, 246, 0.15); border-left: 4px solid var(--accent-blue); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>üìò METRC Requires Two API Keys:</strong>
                    <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Integrator/Software API Key</strong> - Your company's key from METRC Connect
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 3px;">This stays the same for all users</div>
                        </li>
                        <li><strong>User API Key</strong> - Created by the user in their METRC account
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 3px;">Settings ‚Üí Integrations ‚Üí User API Keys</div>
                        </li>
                    </ol>
                </div>

                <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--accent-red); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Browser CORS Limitation:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                        <li>Direct API calls from browsers are blocked by CORS security</li>
                        <li>Even with correct keys, browser connections will likely fail</li>
                        <li><strong>Recommended:</strong> Use Manual Entry tab or set up a server proxy</li>
                    </ul>
                </div>

                <form id="metrcCredentialsForm" onsubmit="event.preventDefault(); saveMetrcConfig();">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Integrator API Key (Software Key)</label>
                            <input type="password" id="metrcIntegratorKey" placeholder="Your White Mousse integrator key" autocomplete="off">
                            <div class="help-text">From METRC Connect - stays the same for all users</div>
                        </div>
                        <div class="form-group">
                            <label>User API Key</label>
                            <input type="password" id="metrcUserKey" placeholder="Individual user's API key" autocomplete="off">
                            <div class="help-text">Created in METRC: Settings ‚Üí Integrations ‚Üí User API Keys</div>
                        </div>
                        <div class="form-group">
                            <label>Manufacturing License Number</label>
                            <input type="text" id="metrcLicenseNumber" value="404R-00016" readonly style="opacity: 0.7; background: var(--bg-tertiary);">
                            <div class="help-text">Your White Mousse manufacturing license (locked)</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="submit" class="btn" style="background: var(--accent-blue); flex: 1;">
                            üíæ Save Credentials
                        </button>
                        <button type="button" class="btn" style="background: var(--accent-green); flex: 1;" onclick="testMetrcConnection()">
                            üî¨ Test Connection
                        </button>
                    </div>
                </form>
                <div id="metrcTestResult" style="margin-top: 15px; display: none;"></div>
            </div>

            <!-- Tab switcher for API vs Manual -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border);">
                <button class="metrc-tab-btn" data-tab="api" onclick="switchMetrcTab('api')" 
                        style="flex: 1; padding: 15px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    üîå API Import (Advanced)
                </button>
                <button class="metrc-tab-btn active" data-tab="manual" onclick="switchMetrcTab('manual')"
                        style="flex: 1; padding: 15px; background: none; border: none; border-bottom: 3px solid var(--accent-purple); color: var(--accent-purple); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    ‚úçÔ∏è Manual Entry (Recommended)
                </button>
            </div>

            <!-- API Load Section -->
            <div id="metrcLoadSection" style="display: none;">
                <div style="display: flex; gap: 15px; margin-bottom: 25px; align-items: end;">
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label>Start Date</label>
                        <input type="date" id="metrcStartDate" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label>End Date</label>
                        <input type="date" id="metrcEndDate" style="width: 100%;">
                    </div>
                    <button class="btn" style="background: var(--accent-green); white-space: nowrap;" onclick="loadMetrcManifests()">
                        üîÑ Load Incoming Transfers
                    </button>
                </div>

                <div id="metrcLoadingIndicator" style="display: none; text-align: center; padding: 40px; color: var(--accent-blue);">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚è≥</div>
                    <div>Loading manifests from METRC...</div>
                </div>

                <div id="metrcError" style="display: none; background: rgba(239, 68, 68, 0.2); border: 2px solid var(--accent-red); color: var(--accent-red); padding: 20px; border-radius: 10px; margin-bottom: 20px;"></div>

                <!-- Manifests List -->
                <div id="metrcManifestsList" style="display: none;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 20px;">Select a Manifest to Import</h3>
                    <div id="manifestsContainer"></div>
                </div>

                <!-- Selected Manifest Details -->
                <div id="manifestDetailsSection" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(59, 130, 246, 0.15)); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--accent-purple);">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üì¶ Manifest Details</h3>
                        <div id="manifestInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;"></div>
                    </div>

                    <h3 style="color: var(--accent-green); margin-bottom: 20px;">Select Tags for Batch</h3>
                    <div id="tagsContainer" style="display: grid; gap: 10px; margin-bottom: 25px;"></div>

                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h4 style="color: var(--accent-orange); margin-bottom: 15px;">Selected Tags Summary</h4>
                        <div id="selectedTagsSummary"></div>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button class="btn" style="background: var(--accent-green); flex: 1;" onclick="importManifestToBatch()">
                            ‚úÖ Import to Batch Intake Form
                        </button>
                        <button class="btn" style="background: var(--bg-tertiary); flex: 1;" onclick="clearManifestSelection()">
                            ‚Ü©Ô∏è Back to Manifests
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Section -->
            <div id="metrcManualSection">
                <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid var(--accent-green); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: var(--accent-green); margin-bottom: 10px;">‚úÖ Recommended Method</h3>
                    <p style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                        This is the most reliable way to import manifest data. Simply open METRC in another tab, 
                        view your incoming transfer, and copy the information here. Fast, simple, and always works!
                    </p>
                </div>

                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Manifest Number</label>
                        <input type="text" id="manualManifestNumber" placeholder="e.g., 0000123456">
                    </div>
                    <div class="form-group">
                        <label>Received Date</label>
                        <input type="date" id="manualReceivedDate">
                    </div>
                    <div class="form-group">
                        <label>Shipper Facility Name</label>
                        <input type="text" id="manualShipperName" placeholder="e.g., ABC Cultivation">
                    </div>
                    <div class="form-group">
                        <label>Shipper License (403R/404R)</label>
                        <input type="text" id="manualShipperLicense" placeholder="403R-00000 or 404R-00000">
                    </div>
                </div>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: var(--accent-green); margin-bottom: 15px;">Add Package Tags</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                        Enter each package tag from the manifest. You can add multiple packages.
                    </p>
                    
                    <div id="manualPackagesContainer">
                        <div class="manual-package-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;">
                            <div class="form-group" style="margin: 0;">
                                <label>METRC Tag Number</label>
                                <input type="text" class="manual-tag-number" placeholder="1A4060300001234567890">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>Weight (g)</label>
                                <input type="number" class="manual-tag-weight" step="0.1" placeholder="0">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>Strain/Product</label>
                                <input type="text" class="manual-tag-strain" placeholder="OG Kush Trim">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" style="background: var(--accent-green); margin-top: 10px;" onclick="addManualPackageRow()">
                        ‚ûï Add Another Package
                    </button>
                </div>

                <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: var(--accent-orange); margin-bottom: 10px;">Summary</h4>
                    <div id="manualSummary" style="color: var(--text-secondary); font-style: italic;">
                        Enter package details above to see summary
                    </div>
                </div>

                <button class="btn" style="background: var(--accent-purple); width: 100%;" onclick="importManualManifest()">
                    ‚úÖ Import Manual Entry to Batch Form
                </button>
            </div>
        </div>
    </div>

    <!-- Personal Stats Modal -->
    <div id="personalStatsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; overflow-y: auto;">
        <div style="max-width: 1000px; margin: 30px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(147, 51, 234, 0.4);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="color: white; margin: 0 0 10px 0; font-size: 2rem;">
                            üë§ <span id="modalPersonalStatName">Your Workload</span>
                        </h2>
                        <p style="color: rgba(255,255,255,0.9); margin: 0;">Your tasks and progress for today</p>
                    </div>
                    <button onclick="closePersonalStatsModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px; transition: all 0.3s ease;">&times;</button>
                </div>
            </div>
            
            <!-- Content -->
            <div style="padding: 30px;">
                <!-- What's Next Section -->
                <div id="whatsNextSection" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2)); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-green);">
                    <h3 style="color: var(--accent-green); margin: 0 0 15px 0; font-size: 1.3rem;">‚ö° What's Next</h3>
                    <div id="whatsNextContent">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Today's Progress -->
                <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(59, 130, 246, 0.2)); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid var(--accent-purple);">
                    <h3 style="color: var(--accent-purple); margin: 0 0 15px 0; font-size: 1.3rem;">üìä Today's Progress</h3>
                    <div id="todayProgressContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Quick Time Selector -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="personal-time-btn active" data-period="today" onclick="updatePersonalStats('today')">Today</button>
                    <button class="personal-time-btn" data-period="week" onclick="updatePersonalStats('week')">This Week</button>
                    <button class="personal-time-btn" data-period="month" onclick="updatePersonalStats('month')">This Month</button>
                    <button class="personal-time-btn" data-period="all" onclick="updatePersonalStats('all')">All Time</button>
                </div>
                
                <!-- Stats Grid -->
                <div id="personalStatsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Populated dynamically -->
                </div>
                
                <!-- My Current Batches -->
                <div id="myBatchesSection" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border);">
                    <h3 style="color: var(--accent-blue); margin-bottom: 20px; font-size: 1.3rem;">üìã My Current Batches</h3>
                    <div id="myBatchesList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Personal Records -->
                <div id="personalRecords" style="padding-top: 30px; border-top: 2px solid var(--border); margin-top: 30px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 20px; text-align: center; font-size: 1.5rem;">üèÜ Your Best Days</h3>
                    <div id="personalRecordsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inventory Management Modal -->
    <div id="inventoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(245, 158, 11, 0.4);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="color: white; margin: 0 0 10px 0; font-size: 2rem;">
                            üì¶ Update Supply Inventory
                        </h2>
                        <p style="color: rgba(255,255,255,0.9); margin: 0;">Track butane and nitrogen levels</p>
                    </div>
                    <button onclick="closeInventoryModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px; transition: all 0.3s ease;">&times;</button>
                </div>
            </div>
            
            <!-- Content -->
            <div style="padding: 30px;">
                <p style="text-align: center; color: var(--text-secondary);">Use the Gas Logging button in the Extraction tab to manage butane.</p>
            </div>
        </div>
    </div>
    
    <!-- Pull Batch Modal -->
    <div id="pullBatchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10003; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(16, 185, 129, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;" id="pullBatchModalTitle">ü´ô Pull Batch from Pot</h2>
                    <button onclick="closePullBatchModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <!-- Current Pot Info -->
                <div id="pullBatchInfo" style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 25px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Batch in Pot</div>
                    <div id="pullBatchNumber" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 10px;">-</div>
                    <div id="pullBatchRuns" style="font-size: 1.2rem; color: var(--text-primary);">0 runs collected</div>
                </div>
                
                <form id="pullBatchForm" onsubmit="event.preventDefault(); submitPullBatch();">
                    <!-- Product Type Selection -->
                    <div class="form-group">
                        <label>Product Type Pulled</label>
                        <select id="pullProductType" required onchange="updatePullFields()">
                            <option value="">Select product type...</option>
                            <option value="shatter">Shatter (count slabs)</option>
                            <option value="wax">Wax (count bowls)</option>
                            <option value="sugar_wax">Sugar Wax (count bowls)</option>
                        </select>
                    </div>
                    
                    <!-- Shatter Fields -->
                    <div id="shatterFields" style="display: none;">
                        <div class="form-group">
                            <label>Number of Slabs</label>
                            <input type="number" id="pullSlabs" min="0" placeholder="0">
                            <div class="help-text">How many slabs of shatter were pulled?</div>
                        </div>
                    </div>
                    
                    <!-- Wax/Sugar Wax Fields -->
                    <div id="waxFields" style="display: none;">
                        <div class="form-group">
                            <label>Number of Bowls</label>
                            <input type="number" id="pullBowls" min="0" placeholder="0">
                            <div class="help-text">How many bowls of wax/sugar wax were pulled?</div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="pullNotes" placeholder="Consistency, color, any observations..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="background: var(--accent-green); width: 100%; font-size: 1.1rem;">
                        ‚úÖ Record Pull & Empty Pot
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Machine Status Modal -->
    <div id="machineModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10003; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(147, 51, 234, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;" id="machineModalTitle">‚öóÔ∏è Machine Status</h2>
                    <button onclick="closeMachineModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <form id="machineForm" onsubmit="event.preventDefault(); saveMachineStatus();">
                    <!-- Columns Status -->
                    <div style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--accent-blue); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--accent-blue); margin: 0 0 15px 0;">üì¶ Columns</h3>
                        <div class="form-group">
                            <label>Column A Batch</label>
                            <select id="machineColumnBatch">
                                <option value="">Empty / Not Loaded</option>
                            </select>
                            <div class="help-text">Batch packed in Column A</div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Column B Batch</label>
                            <select id="machineColumnBBatch">
                                <option value="">Empty / Not Loaded</option>
                            </select>
                            <div class="help-text">Batch packed in Column B (can be same or different)</div>
                        </div>
                    </div>
                    
                    <!-- Pot Status -->
                    <div style="background: rgba(147, 51, 234, 0.1); border-left: 4px solid var(--accent-purple); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--accent-purple); margin: 0 0 15px 0;">ü´ô Pot</h3>
                        <div class="form-group">
                            <label>Batch in Pot</label>
                            <select id="machinePotBatch">
                                <option value="">Empty / Not Loaded</option>
                            </select>
                            <div class="help-text">Which batch is currently in the pot? (Can be same as column or different)</div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Runs in Pot</label>
                            <input type="number" id="machinePotRuns" min="0" placeholder="0">
                            <div class="help-text">How many runs have been collected in the pot for this batch?</div>
                        </div>
                    </div>
                    
                    <!-- Filter Status -->
                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--accent-green); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--accent-green); margin: 0 0 15px 0;">üî¨ Filter Column</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Clay (cups)</label>
                                <input type="number" id="machineFilterClay" step="0.5" min="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Silica (cups)</label>
                                <input type="number" id="machineFilterSilica" step="0.5" min="0" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Runs Through Filter</label>
                            <input type="number" id="machineFilterRuns" min="0" placeholder="0">
                            <div class="help-text">How many runs have been processed through this filter?</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" class="btn" style="background: var(--accent-red);" onclick="clearMachineStatus()">üóëÔ∏è Clear All</button>
                        <button type="submit" class="btn" style="background: var(--accent-green);">‚úÖ Save Status</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Extraction Supplies Modal -->
    <div id="suppliesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto;">
        <div style="max-width: 700px; margin: 50px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(245, 158, 11, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;">üõ¢Ô∏è Extraction Supplies</h2>
                    <button onclick="closeSuppliesModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <!-- Current Levels -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="text-align: center; background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">üõ¢Ô∏è Butane Bulk Tank</div>
                        <div id="modalButaneDisplay" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue);">0 lbs</div>
                    </div>
                    <div style="text-align: center; background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">üí® Nitrogen Tanks</div>
                        <div id="modalNitrogenDisplay" style="font-size: 2.5rem; font-weight: 700; color: var(--accent-purple);">0</div>
                    </div>
                </div>
                
                <!-- Withdraw Section -->
                <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--accent-red); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: var(--accent-red); margin: 0 0 15px 0;">üì§ Withdraw Supplies</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Butane (lbs)</label>
                            <input type="number" id="modalWithdrawButane" step="0.1" min="0" placeholder="0.0" style="width: 100%; padding: 12px; font-size: 1.1rem; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); margin-bottom: 10px;">
                            <button class="btn" style="background: var(--accent-red); padding: 12px; width: 100%;" onclick="withdrawButaneFromModal()">Take</button>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nitrogen (tanks)</label>
                            <input type="number" id="modalWithdrawNitrogen" step="0.5" min="0" placeholder="0.0" style="width: 100%; padding: 12px; font-size: 1.1rem; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); margin-bottom: 10px;">
                            <button class="btn" style="background: var(--accent-red); padding: 12px; width: 100%;" onclick="withdrawNitrogenFromModal()">Take</button>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="btn" style="background: var(--accent-green); padding: 12px 10px; font-size: 0.9rem;" onclick="openAddButaneModal()">‚ûï Add Butane</button>
                    <button class="btn" style="background: var(--accent-green); padding: 12px 10px; font-size: 0.9rem;" onclick="openAddNitrogenModal()">‚ûï Add N‚ÇÇ</button>
                    <button class="btn" style="background: var(--accent-orange); padding: 12px 10px; font-size: 0.9rem;" onclick="openEditButaneModal()">üîß Edit Butane</button>
                    <button class="btn" style="background: var(--accent-orange); padding: 12px 10px; font-size: 0.9rem;" onclick="openEditNitrogenModal()">üîß Edit N‚ÇÇ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Shipment Modal (Butane) -->
    <div id="addShipmentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(16, 185, 129, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;">‚ûï Add Butane Shipment</h2>
                    <button onclick="closeAddButaneModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <form onsubmit="event.preventDefault(); addButaneShipment();">
                    <div class="form-group">
                        <label>Butane Received (lbs)</label>
                        <input type="number" id="butaneShipmentAmount" step="0.1" min="0" placeholder="110" required autofocus style="font-size: 1.2rem; padding: 15px;">
                        <div class="help-text">Typically 110 lbs per tank</div>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="butaneShipmentNotes" placeholder="Delivery info, vendor, etc..."></textarea>
                    </div>
                    <button type="submit" class="btn" style="background: var(--accent-green); width: 100%; font-size: 1.1rem;">
                        ‚úÖ Add to Bulk Tank
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Bulk Weight Modal (Butane) -->
    <div id="editBulkModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(245, 158, 11, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;">üîß Edit Butane Tank Weight</h2>
                    <button onclick="closeEditButaneModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-red);">
                    <strong>‚ö†Ô∏è Use with caution</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">Only use this to correct errors or set initial inventory</p>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Current Bulk Tank</div>
                    <div id="editButaneCurrentDisplay" style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">0 lbs</div>
                </div>
                <form onsubmit="event.preventDefault(); setButaneWeight();">
                    <div class="form-group">
                        <label>Set Bulk Tank To (lbs)</label>
                        <input type="number" id="butaneSetAmount" step="0.1" min="0" placeholder="Enter exact amount" required autofocus style="font-size: 1.2rem; padding: 15px;">
                    </div>
                    <div class="form-group">
                        <label>Reason for Change</label>
                        <textarea id="butaneSetNotes" placeholder="Why are you manually changing this?" required></textarea>
                    </div>
                    <button type="submit" class="btn" style="background: var(--accent-orange); width: 100%; font-size: 1.1rem;">
                        ‚úÖ Update Bulk Tank
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Nitrogen Modal -->
    <div id="addNitrogenModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(147, 51, 234, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;">‚ûï Add Nitrogen Tanks</h2>
                    <button onclick="closeAddNitrogenModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <form onsubmit="event.preventDefault(); addNitrogenShipment();">
                    <div class="form-group">
                        <label>Nitrogen Tanks Received</label>
                        <input type="number" id="nitrogenShipmentAmount" step="0.5" min="0" placeholder="Number of tanks" required autofocus style="font-size: 1.2rem; padding: 15px;">
                        <div class="help-text">Full or partial tanks (e.g., 5, 2.5, 10)</div>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="nitrogenShipmentNotes" placeholder="Delivery info, vendor, etc..."></textarea>
                    </div>
                    <button type="submit" class="btn" style="background: var(--accent-purple); width: 100%; font-size: 1.1rem;">
                        ‚úÖ Add Tanks
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Nitrogen Modal -->
    <div id="editNitrogenModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--bg-secondary); border-radius: 20px; padding: 0; box-shadow: 0 20px 60px rgba(245, 158, 11, 0.4);">
            <div style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); padding: 30px; border-radius: 20px 20px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem;">üîß Edit Nitrogen Inventory</h2>
                    <button onclick="closeEditNitrogenModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 15px; border-radius: 10px;">&times;</button>
                </div>
            </div>
            <div style="padding: 30px;">
                <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-red);">
                    <strong>‚ö†Ô∏è Use with caution</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">Only use this to correct errors or set initial inventory</p>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Current Nitrogen Tanks</div>
                    <div id="editNitrogenCurrentDisplay" style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">0 tanks</div>
                </div>
                <form onsubmit="event.preventDefault(); setNitrogenAmount();">
                    <div class="form-group">
                        <label>Set Nitrogen To (tanks)</label>
                        <input type="number" id="nitrogenSetAmount" step="0.5" min="0" placeholder="Enter exact amount" required autofocus style="font-size: 1.2rem; padding: 15px;">
                    </div>
                    <div class="form-group">
                        <label>Reason for Change</label>
                        <textarea id="nitrogenSetNotes" placeholder="Why are you manually changing this?" required></textarea>
                    </div>
                    <button type="submit" class="btn" style="background: var(--accent-orange); width: 100%; font-size: 1.1rem;">
                        ‚úÖ Update Nitrogen Inventory
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <style>
        .personal-time-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .personal-time-btn:hover {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .personal-time-btn.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }
        
        .stat-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .stat-box:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .record-box {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-green);
        }
        
        #myStatsBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Role configuration with PINs and permissions
        const ROLES = {
            ryan: {
                name: 'Ryan (Admin)',
                pin: '1827',
                tabs: ['dashboard', 'intake', 'extraction', 'finishing', 'packaging', 'testing', 'labeling', 'analytics', 'performance'],
                access: ['dashboard', 'intake', 'extraction', 'finishing', 'packaging', 'testing', 'labeling', 'analytics', 'performance'],
                readOnly: false
            },
            paige: {
                name: 'Paige',
                pin: '1992',
                tabs: ['intake', 'extraction', 'packaging', 'labeling'],
                access: ['intake', 'extraction', 'packaging', 'labeling'],
                readOnly: false
            },
            alex: {
                name: 'Alex',
                pin: '1980',
                tabs: ['dashboard', 'intake', 'extraction', 'finishing', 'packaging', 'testing', 'labeling', 'analytics'],
                access: ['dashboard', 'intake', 'extraction', 'finishing', 'packaging', 'testing', 'labeling', 'analytics'],
                readOnly: false
            },
            donald: {
                name: 'Donald',
                pin: '1425',
                tabs: ['finishing', 'packaging', 'labeling'],
                access: ['finishing', 'packaging', 'labeling'],
                readOnly: false
            },
            andrew: {
                name: 'Andrew',
                pin: '2817',
                tabs: ['packaging', 'labeling'],
                access: ['packaging', 'labeling'],
                readOnly: false
            },
            tobias: {
                name: 'Tobias',
                pin: '4200',
                tabs: ['intake', 'extraction', 'finishing'],
                access: ['intake', 'extraction', 'finishing'],
                readOnly: false
            },
            jeremy: {
                name: 'Jeremy',
                pin: '0710',
                tabs: ['extraction', 'finishing'],
                access: ['extraction', 'finishing'],
                readOnly: false
            }
        };

        let supabaseClient = null;
        let batches = [];
        let currentRole = null;
        let currentMachine = null; // 'left' or 'right' for machine modal
        let currentPullMachine = null; // 'left' or 'right' for pull batch modal
        let batchCounter = 1000;
        let realtimeChannel = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup PIN login
            const pinInput = document.getElementById('pinInput');
            const loginBtn = document.getElementById('loginBtn');
            
            if (pinInput) {
                pinInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
            
            // Check for existing session
            const savedRole = localStorage.getItem('wmRole');
            const sessionTime = localStorage.getItem('wmSession');
            
            // Session expires after 12 hours
            if (savedRole && sessionTime && (Date.now() - parseInt(sessionTime)) < 12 * 60 * 60 * 1000) {
                currentRole = ROLES[savedRole];
                if (currentRole) {
                    document.getElementById('userName').textContent = currentRole.name;
                    document.getElementById('currentUser').style.display = 'block';
                    document.getElementById('pinInput').style.display = 'none';
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('myStatsBtn').style.display = 'block'; // Show My Stats button
                    applyRolePermissions();
                }
            }
            
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            // Auto-connect with hardcoded credentials
            const SUPABASE_URL = 'https://nspmwcpvukehaqswaewt.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcG13Y3B2dWtlaGFxc3dhZXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzE2NDQsImV4cCI6MjA3NzA0NzY0NH0.JGYZ4223nhgO_Er619DkB0tOXrIJzfldG9yNkaHCdtI';
            
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_KEY !== 'YOUR_SUPABASE_KEY_HERE') {
                // Use hardcoded credentials
                connectSupabase(SUPABASE_URL, SUPABASE_KEY);
            } else if (savedUrl && savedKey) {
                // Fallback to saved credentials
                connectSupabase(savedUrl, savedKey);
            } else {
                // Show setup form
                document.getElementById('setupSection').classList.remove('hidden');
            }
        });

        // Credentials form
        document.getElementById('credentialsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            await connectSupabase(url, key);
        });

        async function connectSupabase(url, key) {
            try {
                updateConnectionStatus('connecting', 'Connecting...');
                
                supabaseClient = window.supabase.createClient(url, key);
                
                // Test connection and setup table
                try {
                    await setupDatabase();
                } catch (dbError) {
                    console.error('Database setup error:', dbError);
                    throw new Error('Database setup failed: ' + dbError.message);
                }
                
                // Load batches
                try {
                    await loadBatches();
                    updateMachineDisplays(); // Load machine status
                    updateSuppliesButton(); // Load inventory levels
                } catch (loadError) {
                    console.error('Load batches error:', loadError);
                    throw new Error('Failed to load batches: ' + loadError.message);
                }
                
                // Setup realtime subscription
                setupRealtime();
                
                // Show app
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                
                updateConnectionStatus('connected', 'Connected');
                
                // Initialize app
                initializeApp();
                
            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('disconnected', 'Connection Failed');
                alert('Failed to connect to Supabase.\n\nError: ' + error.message + '\n\nPlease check:\n1. URL is correct (https://xxxxx.supabase.co)\n2. Anon key is correct\n3. Project is not paused');
            }
        }

        async function setupDatabase() {
            // Check if table exists by trying to query it
            const { data, error } = await supabaseClient
                .from('wm_batches')
                .select('id')
                .limit(1);
            
            if (error && error.code === '42P01') {
                // Table doesn't exist, create it
                console.log('Creating wm_batches table...');
                
                // We can't create tables via JS client, so show instructions
                const createTableSQL = `
CREATE TABLE wm_batches (
    id TEXT PRIMARY KEY,
    strain TEXT NOT NULL,
    strain_type TEXT NOT NULL,
    trim_weight DECIMAL(10,2) NOT NULL,
    material_cost DECIMAL(10,2) NOT NULL,
    material_agreement TEXT,
    cultivation_license TEXT NOT NULL,
    grower_name TEXT,
    metrc_tags TEXT,
    intake_date DATE NOT NULL,
    planned_products JSONB NOT NULL,
    intake_notes TEXT,
    status TEXT NOT NULL DEFAULT 'intake',
    intake_user TEXT NOT NULL,
    timeline JSONB NOT NULL DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Extraction fields
    extraction_date DATE,
    extraction_method TEXT,
    extraction_machine TEXT,
    extraction_runs INTEGER,
    extraction_slabs INTEGER,
    extraction_bowls INTEGER,
    extraction_notes TEXT,
    butane_used DECIMAL(10,2),
    nitrogen_tanks_used DECIMAL(5,2),
    product_made TEXT,
    crude_weight DECIMAL(10,2),
    extraction_user TEXT,
    extraction_yield DECIMAL(5,2),
    extraction_paused BOOLEAN DEFAULT FALSE,
    bulk_jars_count INTEGER,
    shatter_slabs_count INTEGER,
    sift_weight DECIMAL(10,2),
    adjusted_trim_weight DECIMAL(10,2),
    sift_sub_batch_created BOOLEAN DEFAULT FALSE,
    sift_sub_batch_id TEXT,
    parent_batch_id TEXT,
    is_sub_batch BOOLEAN DEFAULT FALSE,
    pre_sift TEXT,
    
    -- Finishing fields
    finishing_date DATE,
    final_weight DECIMAL(10,2),
    sample_weight DECIMAL(10,2),
    test_results_expected_date DATE,
    finishing_notes TEXT,
    finishing_user TEXT,
    net_weight DECIMAL(10,2),
    
    -- Test results fields
    test_results_received_date DATE,
    test_thc_percent DECIMAL(5,2),
    test_cbd_percent DECIMAL(5,2),
    test_lab_name TEXT,
    test_sample_id TEXT,
    test_results_notes TEXT,
    
    -- Packaging fields
    packaging_date DATE,
    packaged_product_type TEXT,
    units_packaged INTEGER,
    units_1g INTEGER,
    units_4g INTEGER,
    total_grams_packaged DECIMAL(10,2),
    packaging_breakdown TEXT,
    packaging_paused BOOLEAN DEFAULT FALSE,
    thc_percent DECIMAL(5,2),
    cbd_percent DECIMAL(5,2),
    ready_to_list TEXT,
    wholesale_price DECIMAL(10,2),
    leaflink_description TEXT,
    packaging_notes TEXT,
    packaging_user TEXT,
    
    -- Labeling fields
    labeling_paused BOOLEAN DEFAULT FALSE,
    
    completed_at TIMESTAMP WITH TIME ZONE
);

-- Enable realtime
ALTER PUBLICATION supabase_realtime ADD TABLE wm_batches;
                `;
                
                alert(`Please run this SQL in your Supabase SQL Editor:\n\n${createTableSQL}\n\nThen refresh this page.`);
                throw new Error('Table setup required');
            }
            
            // Get the highest batch number
            const { data: maxBatch } = await supabaseClient
                .from('wm_batches')
                .select('id')
                .order('id', { ascending: false })
                .limit(1);
            
            if (maxBatch && maxBatch.length > 0) {
                const lastId = maxBatch[0].id;
                const num = parseInt(lastId.split('-')[1]);
                batchCounter = num + 1;
            }
        }

        // Update pause button visibility and text based on current batch selection
        function updatePauseButtons() {
            // Update extraction pause button
            const extractionBatchId = document.getElementById('extractionBatchSelect')?.value;
            const extractionBatch = batches.find(b => b.id === extractionBatchId);
            const extractionPauseBtn = document.getElementById('pauseExtractionBtn');
            
            if (extractionPauseBtn && extractionBatch) {
                // Show button only if batch has been started (has extraction_method or timeline entry)
                const hasStarted = extractionBatch.extraction_method || 
                                  (extractionBatch.timeline || []).some(t => t.stage === 'extraction');
                
                if (hasStarted && extractionBatch.status === 'intake') {
                    extractionPauseBtn.style.display = 'block';
                    const isPaused = extractionBatch.extraction_paused || false;
                    extractionPauseBtn.innerHTML = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
                    extractionPauseBtn.style.background = isPaused ? 'var(--accent-blue)' : 'var(--accent-orange)';
                } else {
                    extractionPauseBtn.style.display = 'none';
                }
            }
            
            // Update packaging pause button
            const packagingBatchId = document.getElementById('packagingBatchSelect')?.value;
            const packagingBatch = batches.find(b => b.id === packagingBatchId);
            const packagingPauseBtn = document.getElementById('pausePackagingBtn');
            
            if (packagingPauseBtn && packagingBatch) {
                const hasStarted = packagingBatch.product_type || 
                                  (packagingBatch.timeline || []).some(t => t.stage === 'packaging');
                
                if (hasStarted && packagingBatch.status === 'finishing') {
                    packagingPauseBtn.style.display = 'block';
                    const isPaused = packagingBatch.packaging_paused || false;
                    packagingPauseBtn.innerHTML = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
                    packagingPauseBtn.style.background = isPaused ? 'var(--accent-blue)' : 'var(--accent-orange)';
                } else {
                    packagingPauseBtn.style.display = 'none';
                }
            }
            
            // Update labeling pause button
            const labelingBatchId = document.getElementById('labelingBatchSelect')?.value;
            const labelingBatch = batches.find(b => b.id === labelingBatchId);
            const labelingPauseBtn = document.getElementById('pauseLabelingBtn');
            
            if (labelingPauseBtn && labelingBatch) {
                const hasStarted = (labelingBatch.timeline || []).some(t => t.stage === 'labeling');
                
                if (hasStarted && labelingBatch.status === 'packaged') {
                    labelingPauseBtn.style.display = 'block';
                    const isPaused = labelingBatch.labeling_paused || false;
                    labelingPauseBtn.innerHTML = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
                    labelingPauseBtn.style.background = isPaused ? 'var(--accent-blue)' : 'var(--accent-orange)';
                } else {
                    labelingPauseBtn.style.display = 'none';
                }
            }
        }

        async function loadBatches() {
            const { data, error } = await supabaseClient
                .from('wm_batches')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading batches:', error);
                return;
            }
            
            batches = data || [];
            updateDashboard();
            renderBatches();
            updateSuppliesButton(); // Update supplies button display
            updateMachineDisplays(); // Update machine status displays
            
            // Initialize dropdown search filters (only once)
            if (!window.searchFiltersInitialized) {
                setTimeout(() => {
                    addDropdownSearchFilters();
                    window.searchFiltersInitialized = true;
                }, 500);
            }
        }

        function setupRealtime() {
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
            }
            
            realtimeChannel = supabaseClient
                .channel('wm_batches_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'wm_batches' },
                    () => {
                        loadBatches(); // Reload on any change
                    }
                )
                .subscribe();
        }

        // Celebration function for completed tasks
        function showCelebration(options = {}) {
            // Remove any existing celebrations first
            document.querySelectorAll('.celebration-overlay').forEach(el => el.remove());
            document.querySelectorAll('.confetti-piece').forEach(el => el.remove());

            const {
                emoji = 'üéâ',
                title = 'Great Job!',
                message = 'Task completed successfully!',
                stats = [],
                confettiCount = 50,
                buttonText = 'Awesome!'
            } = options;

            // Create confetti - neon laser colors
            const colors = ['#39ff14', '#00f0ff', '#ff10f0', '#bf00ff', '#ff0055', '#ff6b00'];
            const shapes = ['square', 'circle'];

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                const color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = color;
                confetti.style.boxShadow = `0 0 6px ${color}, 0 0 10px ${color}`;
                confetti.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)] === 'circle' ? '50%' : '2px';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(confetti);

                // Remove confetti after animation
                setTimeout(() => confetti.remove(), 4500);
            }

            // Build stats HTML
            let statsHtml = '';
            if (stats.length > 0) {
                statsHtml = `<div class="celebration-stats">
                    ${stats.map(s => `
                        <div class="celebration-stat">
                            <div class="celebration-stat-value">${s.value}</div>
                            <div class="celebration-stat-label">${s.label}</div>
                        </div>
                    `).join('')}
                </div>`;
            }

            // Create celebration overlay
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.innerHTML = `
                <div class="celebration-content">
                    <div class="celebration-emoji">${emoji}</div>
                    <div class="celebration-title">${title}</div>
                    <div class="celebration-message">${message}</div>
                    ${statsHtml}
                    <button class="celebration-btn" onclick="this.closest('.celebration-overlay').remove()">
                        ${buttonText}
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            // Auto-close after 10 seconds
            setTimeout(() => {
                if (overlay.parentNode) overlay.remove();
            }, 10000);

            // Close on overlay click (not content)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('statusText');
            
            statusEl.className = `connection-status ${status}`;
            textEl.textContent = text;
        }

        // PIN Login
        function login() {
            const pin = document.getElementById('pinInput').value;
            const errorMsg = document.getElementById('loginError');
            
            if (pin.length !== 4) {
                errorMsg.textContent = 'Please enter a 4-digit PIN';
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
                return;
            }
            
            // Find role by PIN
            const roleKey = Object.keys(ROLES).find(key => ROLES[key].pin === pin);
            
            if (roleKey) {
                // Successful login
                currentRole = ROLES[roleKey];
                localStorage.setItem('wmRole', roleKey);
                const sessionId = Date.now();
                localStorage.setItem('wmSession', sessionId);
                localStorage.setItem('wmSessionId', sessionId); // Store session ID for logout tracking
                
                document.getElementById('userName').textContent = currentRole.name;
                document.getElementById('currentUser').style.display = 'block';
                document.getElementById('pinInput').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                document.getElementById('myStatsBtn').style.display = 'block'; // Show My Stats button
                errorMsg.style.display = 'none';
                
                // Log login to database
                supabaseClient
                    .from('wm_login_history')
                    .insert({
                        user_name: currentRole.name,
                        login_time: new Date().toISOString()
                    })
                    .then(({ data, error }) => {
                        if (error) {
                            console.error('Error logging login:', error);
                        } else if (data && data.length > 0) {
                            // Store the login record ID for logout tracking
                            localStorage.setItem('wmLoginRecordId', data[0].id);
                        }
                    });
                
                applyRolePermissions();

                // Welcome celebration with random messages
                const welcomeMessages = [
                    // Original messages
                    "Ready to crush it today? Let's get to work!",
                    "Time to make some magic happen! ‚ú®",
                    "Another day, another dab! üí®",
                    "May your yields be high and your temps be low! üå°Ô∏è",
                    "Time to turn trim into triumph! üèÜ",
                    // Movie quotes
                    "I'm kind of a big deal. ‚Äî Anchorman",
                    "That's what she said. ‚Äî The Office",
                    "I'm not even supposed to be here today! ‚Äî Clerks",
                    "Alright, alright, alright. ‚Äî Dazed and Confused",
                    "I'm gonna need you to come in on Saturday. ‚Äî Office Space",
                    "So you're telling me there's a chance? ‚Äî Dumb and Dumber",
                    "The Dude abides. ‚Äî The Big Lebowski",
                    "Did we just become best friends?! ‚Äî Step Brothers",
                    "Life moves pretty fast. If you don't stop and look around once in a while, you could miss it. ‚Äî Ferris Bueller",
                    "I've got a fever, and the only prescription is more cowbell! ‚Äî SNL",
                    "It's showtime! ‚Äî Beetlejuice",
                    "Be excellent to each other. ‚Äî Bill & Ted",
                    "You're gonna need a bigger boat. ‚Äî Jaws",
                    "I ain't afraid of no ghosts! ‚Äî Ghostbusters",
                    "Cinderella story, outta nowhere! ‚Äî Caddyshack",
                    "How do you like them apples? ‚Äî Good Will Hunting",
                    "I'm walkin' here! ‚Äî Midnight Cowboy",
                    "You had me at hello. ‚Äî Jerry Maguire",
                    "Just keep swimming. ‚Äî Finding Nemo",
                    "To infinity and beyond! ‚Äî Toy Story"
                ];
                const welcomeButtons = [
                    "Hell yes!",
                    "Let's gooo!",
                    "I'm ready!",
                    "Heck yeah!",
                    "Let's crush it!",
                    "Born ready!",
                    "LFG! üöÄ",
                    "Oh yeahhh!",
                    "Groovy!",
                    "Excellent!",
                    "Alrighty then!",
                    "I'm on it!",
                    "Let's do this!",
                    "Party on!",
                    "Cowabunga!"
                ];
                const randomMessage = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                const randomButton = welcomeButtons[Math.floor(Math.random() * welcomeButtons.length)];

                showCelebration({
                    emoji: 'üëã',
                    title: `Welcome, ${currentRole.name}!`,
                    message: randomMessage,
                    stats: [],
                    confettiCount: 30,
                    buttonText: randomButton
                });
            } else {
                // Failed login
                errorMsg.textContent = 'Invalid PIN. Please try again.';
                errorMsg.style.display = 'block';
                document.getElementById('pinInput').value = '';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }

        function logout() {
            // Cleanup realtime subscription
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
                realtimeChannel = null;
            }

            const loginRecordId = localStorage.getItem('wmLoginRecordId');
            const sessionStart = parseInt(localStorage.getItem('wmSession'));

            const clearAndReload = () => {
                localStorage.removeItem('wmRole');
                localStorage.removeItem('wmSession');
                localStorage.removeItem('wmSessionId');
                localStorage.removeItem('wmLoginRecordId');
                location.reload();
            };

            if (loginRecordId && sessionStart) {
                const sessionDuration = Math.floor((Date.now() - sessionStart) / 1000 / 60); // minutes

                // Update logout time and duration
                supabaseClient
                    .from('wm_login_history')
                    .update({
                        logout_time: new Date().toISOString(),
                        session_duration: sessionDuration
                    })
                    .eq('id', loginRecordId)
                    .then(clearAndReload)
                    .catch(err => {
                        console.error('Logout update failed:', err);
                        clearAndReload();
                    });
            } else {
                clearAndReload();
            }
        }

        function applyRolePermissions() {
            if (!currentRole) return;
            
            // Show/hide tabs based on role
            document.querySelectorAll('.station-tab').forEach(tab => {
                const station = tab.dataset.station;
                if (currentRole.tabs.includes(station)) {
                    tab.style.display = '';
                } else {
                    tab.style.display = 'none';
                }
            });
            
            // Show first available tab
            const firstTab = document.querySelector('.station-tab[style=""]') || document.querySelector('.station-tab:not([style*="display: none"])');
            if (firstTab) {
                firstTab.click();
            }
        }

        // Station tabs
        document.querySelectorAll('.station-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const station = this.dataset.station;
                
                document.querySelectorAll('.station-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.station-content').forEach(c => c.classList.remove('active'));
                document.getElementById(station).classList.add('active');
                
                if (station === 'dashboard') {
                    updateDashboard();
                    renderBatches();
                } else if (station === 'analytics') {
                    updateAnalytics();
                } else if (station === 'performance') {
                    renderPerformanceAnalytics();
                } else if (station === 'extraction') {
                    
                } else if (station === 'finishing') {
                    populateFinishingSelect();
                } else if (station === 'packaging') {
                    populatePackagingSelect();
                } else if (station === 'testing') {
                    populateTestingSelect();
                    checkRTAStatus();
                } else if (station === 'labeling') {
                    populateLabelingSelect();
                }
            });
        });

        // Intake form submission
        document.getElementById('intakeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const products = Array.from(document.querySelectorAll('input[name="products"]:checked'))
                .map(cb => cb.value);
            
            if (products.length === 0) {
                alert('Please select at least one planned product!');
                return;
            }
            
            // Validate pre-sift requires hash products
            const preSift = document.getElementById('preSift').value;
            if (preSift === 'yes') {
                const hasHashProducts = products.some(p => p === 'Brick Hash' || p === 'Hash Hits');
                if (!hasHashProducts) {
                    alert('Pre-sift requires at least one hash product!\n\nPlease select:\n‚Ä¢ Brick Hash, or\n‚Ä¢ Hash Hits, or\n‚Ä¢ Both');
                    return;
                }
            }
            
            const batch = {
                id: `WM-${batchCounter}`,
                strain: document.getElementById('strainName').value,
                strain_type: document.getElementById('strainType').value,
                trim_weight: parseFloat(document.getElementById('trimWeight').value),
                material_cost: parseFloat(document.getElementById('materialCost').value),
                material_agreement: document.getElementById('materialAgreement').value,
                pre_sift: document.getElementById('preSift').value,
                cultivation_license: document.getElementById('cultivationLicense').value,
                grower_name: document.getElementById('growerName').value || document.getElementById('cultivationLicense').value,
                metrc_tags: document.getElementById('metrcTags').value || null,
                intake_date: document.getElementById('intakeDate').value,
                planned_products: products,
                intake_notes: document.getElementById('intakeNotes').value,
                status: 'intake',
                intake_user: currentRole ? currentRole.name : "Unknown",
                parent_batch_id: null,
                is_sub_batch: false,
                timeline: [{
                    stage: 'intake',
                    user: currentRole ? currentRole.name : "Unknown",
                    date: new Date().toISOString(),
                    action: `Batch created - ${document.getElementById('materialAgreement').value} - Cultivated by ${document.getElementById('cultivationLicense').value}`
                }],
                created_at: new Date().toISOString()
            };
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .insert([batch]);
            
            if (error) {
                console.error('Error creating batch:', error);
                alert('Error creating batch. Please try again.');
                return;
            }
            
            batchCounter++;
            
            // Show option to print batch tracking label
            const printLabel = confirm(`Batch ${batch.id} created successfully!\n\nPrint batch tracking label now?`);
            if (printLabel) {
                printIntakeBatchLabel(batch);
            }
            
            // Save fields we want to keep after reset
            const savedLicense = document.getElementById('cultivationLicense').value;
            const savedGrowerName = document.getElementById('growerName').value;
            const savedIntakeDate = document.getElementById('intakeDate').value;
            
            // Reset form
            this.reset();
            
            // Restore saved fields
            document.getElementById('cultivationLicense').value = savedLicense;
            document.getElementById('growerName').value = savedGrowerName;
            document.getElementById('intakeDate').value = savedIntakeDate;
            
            // Update batch ID for next submission
            document.getElementById('batchId').value = `WM-${batchCounter}`;
            
            await loadBatches();
        });

        // Test print batch label with current form data (no batch creation)
        function testPrintBatchLabel() {
            // Gather data from form - using correct field IDs
            const batchId = document.getElementById('batchId')?.value || 'WM-TEST';
            const strain = document.getElementById('strainName')?.value || 'Test Strain';
            const strainType = document.getElementById('strainType')?.value || 'Hybrid';
            const trimWeight = document.getElementById('trimWeight')?.value || '100';
            const intakeDate = document.getElementById('intakeDate')?.value || new Date().toISOString().split('T')[0];
            const cultivationLicense = document.getElementById('cultivationLicense')?.value || '403R-01007';
            const materialAgreement = document.getElementById('materialAgreement')?.value || 'Wholesale';
            
            // Get planned products
            const checkboxes = document.querySelectorAll('input[name="products"]:checked');
            const products = Array.from(checkboxes).map(cb => ({ type: cb.value }));
            
            // Create test batch object
            const testBatch = {
                id: batchId,
                strain: strain,
                strain_type: strainType,
                trim_weight: trimWeight,
                intake_date: intakeDate,
                cultivation_license: cultivationLicense,
                material_agreement: materialAgreement,
                planned_products: products
            };
            
            // Print directly to static IP
            printIntakeLabelDirectly(testBatch);
        }

        // Print directly to Zebra printer via IP
        async function printIntakeLabelDirectly(batch) {
            const printerIP = '10.1.10.95'; // Static IP for Zebra ZT230
            const zpl = generateIntakeBatchLabelZPL(batch);
            
            try {
                const response = await fetch(`http://${printerIP}:9100`, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: zpl
                });
                
                alert(`‚úÖ Label sent to printer!\n\nBatch: ${batch.id}`);
            } catch (error) {
                console.error('Print error:', error);
                alert(`‚ö†Ô∏è Could not connect to printer at ${printerIP}\n\nError: ${error.message}\n\nTry downloading the ZPL file instead.`);
                
                // Offer to download instead
                if (confirm('Download ZPL file instead?')) {
                    downloadIntakeLabelZPL(batch);
                }
            }
        }

        // Download ZPL file for intake label
        function downloadIntakeLabelZPL(batch) {
            const zpl = generateIntakeBatchLabelZPL(batch);
            
            // Create blob and download
            const blob = new Blob([zpl], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch-label-${batch.id}.zpl`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`ZPL file downloaded: batch-label-${batch.id}.zpl\n\nTo print:\n1. Open Zebra Setup Utilities\n2. Go to Tools ‚Üí Send File\n3. Select the .zpl file\n4. Click Send`);
        }

        // Open printable intake batch label
        function openPrintableIntakeLabel(batch) {
            // Format date
            const date = new Date(batch.intake_date).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
            
            // Get planned products as string
            let plannedProducts = 'See notes';
            if (batch.planned_products && batch.planned_products.length > 0) {
                plannedProducts = batch.planned_products.join(', ');
            }

            // Truncate products if too long
            if (plannedProducts.length > 20) {
                plannedProducts = plannedProducts.substring(0, 17) + '...';
            }
            
            // Create popup window
            const popup = window.open('', 'PrintIntakeLabel', 'width=700,height=600');
            popup.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>Print Batch Label - ${batch.id}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @page {
            size: 2in 1.5in landscape;
            margin: 0mm;
        }
        
        @media print {
            html, body {
                width: 2in;
                height: 1.5in;
                margin: 0;
                padding: 0;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page-wrapper {
                width: 2in;
                height: 1.5in;
                position: relative;
                page-break-after: avoid;
            }
            
            .batch-label {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .no-print {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .no-print h1 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 20px;
        }
        
        .no-print button {
            background: #9333ea;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        .no-print button:hover {
            background: #7c2db8;
        }
        
        .page-wrapper {
            width: 2in;
            height: 1.5in;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .batch-label {
            width: 100%;
            height: 100%;
            border: 3px solid #000;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .strain-name {
            font-size: 20pt;
            font-weight: bold;
            text-align: left;
            line-height: 0.9;
            text-transform: uppercase;
            border-bottom: 2px solid #000;
            padding-bottom: 2px;
            margin-bottom: 2px;
        }
        
        .batch-id {
            font-size: 16pt;
            font-weight: bold;
            text-align: left;
            border-bottom: 2px solid #000;
            padding: 2px 0;
            margin-bottom: 4px;
        }
        
        .details-row {
            display: grid;
            grid-template-columns: 0.9in 1.1in;
            gap: 0;
            font-size: 8pt;
            line-height: 1.4;
            flex: 1;
        }
        
        .left-col, .right-col {
            text-align: left;
        }
        
        .details-row div {
            margin: 0.5px 0;
        }
    </style>
</head>
<body>
    <div class="no-print">
        <h1>Intake Batch Label - ${batch.id}</h1>
        <p>Size: 2" √ó 1.5" (Horizontal)</p>
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ff9800;">
            <strong>‚ö†Ô∏è Important Print Settings:</strong>
            <ol style="text-align: left; margin: 10px 0 0 20px;">
                <li>In print dialog, click "More settings"</li>
                <li>Set <strong>Margins</strong> to "None"</li>
                <li>Set <strong>Scale</strong> to "Default" (100%)</li>
                <li>Uncheck "Headers and footers"</li>
                <li>Make sure orientation is <strong>Landscape</strong></li>
            </ol>
        </div>
        <button onclick="window.print()">üñ®Ô∏è Print Label</button>
        <button onclick="window.close()">Close</button>
    </div>
    
    <div class="page-wrapper">
        <div class="batch-label">
            <div class="strain-name">${batch.strain.toUpperCase()}</div>
            <div class="batch-id">BATCH: ${batch.id}</div>
            <div class="details-row">
                <div class="left-col">
                    <div><strong>Type:</strong> ${batch.strain_type}</div>
                    <div><strong>Weight:</strong> ${batch.trim_weight}g</div>
                    <div><strong>Date:</strong> ${date}</div>
                </div>
                <div class="right-col">
                    <div><strong>Grower:</strong></div>
                    <div>${batch.cultivation_license}</div>
                    <div><strong>Products:</strong></div>
                    <div>${plannedProducts}</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
            `);
            popup.document.close();
        }

        // Generate ZPL for intake batch tracking label (2" x 1.5" horizontal)
        function generateIntakeBatchLabelZPL(batch) {
            // 2" x 1.5" label at 203dpi = 406 x 305 dots (horizontal)
            const width = 406;
            const height = 305;
            
            // Format date
            const date = new Date(batch.intake_date).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
            
            // Get planned products as string
            let plannedProducts = 'See notes';
            if (batch.planned_products && batch.planned_products.length > 0) {
                plannedProducts = batch.planned_products.join(', ');
            }

            // Truncate if too long
            if (plannedProducts.length > 20) {
                plannedProducts = plannedProducts.substring(0, 17) + '...';
            }
            
            const zpl = `^XA
^MMT
^PW${width}
^LL${height}
^LS0

~SD20

^FO0,0^GB${width},${height},3^FS

^CF0,40
^FO10,10^FD${batch.strain.toUpperCase()}^FS

^FO10,55^GB386,2,2^FS

^CF0,32
^FO10,65^FDBATCH: ${batch.id}^FS

^FO10,105^GB386,2,2^FS

^CF0,16
^FO10,115^FDType: ${batch.strain_type}^FS
^FO10,135^FDWeight: ${batch.trim_weight}g^FS
^FO10,155^FDDate: ${date}^FS

^CF0,16
^FO210,115^FDGrower:^FS
^FO210,135^FD${batch.cultivation_license}^FS
^FO210,155^FDProducts:^FS
^FO210,175^FD${plannedProducts}^FS

^XZ`;
            
            return zpl;
        }

        // Print intake batch tracking label
        async function printIntakeBatchLabel(batch) {
            const zpl = generateIntakeBatchLabelZPL(batch);
            
            // Try print server first
            const printServerURL = localStorage.getItem('printServerURL') || 'http://localhost:3000/print';
            
            try {
                const response = await fetch(printServerURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zpl: zpl })
                });
                
                if (response.ok) {
                    console.log('Batch tracking label sent to printer');
                    return;
                }
            } catch (error) {
                console.log('Print server not available:', error.message);
            }
            
            // Fallback to Browser Print
            if (window.BrowserPrint) {
                try {
                    const printer = await window.BrowserPrint.getDefaultDevice('printer');
                    printer.send(zpl, undefined, (error) => {
                        if (error) {
                            alert('Print failed. Check printer connection.');
                        }
                    });
                } catch (error) {
                    alert('Printer not available. Make sure Zebra printer is connected.');
                }
            } else {
                alert('Printer not available. Make sure Zebra printer is connected or print server is running.');
            }
        }

        // Extraction functions
        
        // Finishing functions
        function populateFinishingSelect() {
            const select = document.getElementById('finishingBatchSelect');
            // Include both regular batches AND sub-batches that are at extraction status
            // (Sub-batches can be retroactively created and need post-processing)
            const extractionBatches = batches.filter(b => b.status === 'extraction');
            
            select.innerHTML = '<option value="">Select a batch...</option>';
            extractionBatches.forEach(batch => {
                let label;
                
                if (batch.is_sub_batch) {
                    label = `${batch.id} - ${batch.strain} - ${batch.product_made} (SUB-BATCH)`;
                } else {
                    // Build label with jar/slab counts from pull batch
                    let counts = [];
                    if (batch.extraction_slabs && batch.extraction_slabs > 0) {
                        counts.push(`${batch.extraction_slabs} slabs`);
                    }
                    if (batch.extraction_bowls && batch.extraction_bowls > 0) {
                        counts.push(`${batch.extraction_bowls} bowls`);
                    }
                    // Fallback to old fields if they exist
                    if (!counts.length && batch.bulk_jars_count && batch.bulk_jars_count > 0) {
                        counts.push(`${batch.bulk_jars_count} jars`);
                    }
                    if (!counts.length && batch.shatter_slabs_count && batch.shatter_slabs_count > 0) {
                        counts.push(`${batch.shatter_slabs_count} slabs`);
                    }
                    
                    const countText = counts.length > 0 ? counts.join(', ') : 'no counts';
                    label = `${batch.id} - ${batch.strain} - ${batch.product_made} (${countText})`;
                }
                
                select.innerHTML += `<option value="${batch.id}">${label}</option>`;
            });
        }

        document.getElementById('finishingBatchSelect').addEventListener('change', function() {
            const form = document.getElementById('finishingForm');
            form.style.display = this.value ? 'block' : 'none';
            
            if (this.value) {
                const batch = batches.find(b => b.id === this.value);
                document.getElementById('finishingDate').value = new Date().toISOString().split('T')[0];
                
                // Show batch info
                let info = `
                    <p><strong>Strain:</strong> ${batch.strain} (${batch.strain_type})</p>
                    <p><strong>Product Type:</strong> ${batch.product_made}</p>
                    <p><strong>Material Agreement:</strong> ${batch.material_agreement}</p>
                `;
                
                // Show counts from pull batch
                if (batch.extraction_slabs && batch.extraction_slabs > 0) {
                    info += `<p style="background: rgba(245, 158, 11, 0.2); padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent-orange); margin-top: 10px;">
                        <strong>üî∂ Shatter Slabs to Process:</strong> <span style="font-size: 1.3rem; font-weight: 700; color: var(--accent-orange);">${batch.extraction_slabs}</span>
                    </p>`;
                }
                
                if (batch.extraction_bowls && batch.extraction_bowls > 0) {
                    const productName = batch.product_type === 'Sugar Wax' ? 'Sugar Wax' : 'Wax';
                    info += `<p style="background: rgba(147, 51, 234, 0.2); padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent-purple); margin-top: 10px;">
                        <strong>üì¶ ${productName} Bowls to Process:</strong> <span style="font-size: 1.3rem; font-weight: 700; color: var(--accent-purple);">${batch.extraction_bowls}</span>
                    </p>`;
                }
                
                // Fallback to old fields if they exist (for legacy batches)
                if (batch.bulk_jars_count && batch.bulk_jars_count > 0 && !batch.extraction_bowls) {
                    info += `<p style="background: rgba(147, 51, 234, 0.2); padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent-purple); margin-top: 10px;">
                        <strong>üì¶ Bulk Jars to Process:</strong> <span style="font-size: 1.3rem; font-weight: 700; color: var(--accent-purple);">${batch.bulk_jars_count}</span>
                    </p>`;
                }
                
                if (batch.shatter_slabs_count && batch.shatter_slabs_count > 0 && !batch.extraction_slabs) {
                    info += `<p style="background: rgba(245, 158, 11, 0.2); padding: 10px; border-radius: 8px; border-left: 4px solid var(--accent-orange); margin-top: 10px;">
                        <strong>üî∂ Shatter Slabs to Process:</strong> <span style="font-size: 1.3rem; font-weight: 700; color: var(--accent-orange);">${batch.shatter_slabs_count}</span>
                    </p>`;
                }
                
                if (batch.is_sub_batch) {
                    info += `<p style="color: var(--accent-purple); font-weight: 700;"><strong>‚ö° RETROACTIVE SUB-BATCH</strong> of ${batch.parent_batch_id}</p>`;
                    info += `<p style="color: var(--accent-orange);"><strong>Note:</strong> Enter the actual weight of this separated material</p>`;
                } else {
                    if (batch.sift_weight) {
                        info += `<p><strong>Pre-Sift Collected:</strong> ${batch.sift_weight}g</p>`;
                    }
                    info += `<p style="color: var(--accent-orange);"><strong>Note:</strong> Actual weight will be entered below or when splitting</p>`;
                }
                
                document.getElementById('batchInfoContent').innerHTML = info;
            }
        });

        document.getElementById('splitBatch').addEventListener('change', function() {
            const singleSection = document.getElementById('singleFinishing');
            const splitSection = document.getElementById('splitFinishing');
            
            if (this.value === 'yes') {
                singleSection.style.display = 'none';
                splitSection.style.display = 'block';
                // Make single fields not required
                document.getElementById('finalWeight').required = false;
                document.getElementById('sampleWeight').required = false;
                
                // Update split weight listeners
                updateSplitValidation();
            } else {
                singleSection.style.display = 'block';
                splitSection.style.display = 'none';
                document.getElementById('finalWeight').required = true;
                document.getElementById('sampleWeight').required = true;
            }
        });

        function addSplitProduct() {
            const container = document.getElementById('splitProducts');
            const count = container.children.length + 1;
            
            const newProduct = document.createElement('div');
            newProduct.className = 'split-product-item';
            newProduct.style.cssText = 'background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;';
            newProduct.innerHTML = `
                <h4 style="color: var(--accent-purple); margin-bottom: 15px;">Product ${count}</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Product Type</label>
                        <select class="splitProductType" required>
                            <option value="">Select Product</option>
                            <option value="Wax">Wax</option>
                            <option value="Sugar Wax">Sugar Wax</option>
                            <option value="Shatter">Shatter</option>
                            <option value="Live Resin Oil">Live Resin Oil (Carts)</option>
                            <option value="Brick Hash">Brick Hash</option>
                            <option value="Hash Hits">Hash Hits</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Weight Allocated (grams)</label>
                        <input type="number" class="splitWeight" step="0.1" required>
                    </div>
                </div>
            `;
            container.appendChild(newProduct);
            
            // Add listeners to new inputs
            newProduct.querySelector('.splitWeight').addEventListener('input', updateSplitValidation);
        }

        function updateSplitValidation() {
            const weights = Array.from(document.querySelectorAll('.splitWeight'))
                .map(input => parseFloat(input.value) || 0);
            
            const totalAllocated = weights.reduce((sum, w) => sum + w, 0);
            
            const validationDiv = document.getElementById('splitValidation');
            
            if (totalAllocated > 0) {
                validationDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                validationDiv.style.border = '2px solid var(--accent-green)';
                validationDiv.innerHTML = `
                    <strong style="color: var(--accent-green);">‚úì Total weight to allocate:</strong><br>
                    ${totalAllocated.toFixed(1)}g across ${weights.filter(w => w > 0).length} products
                `;
            } else {
                validationDiv.style.background = 'rgba(245, 158, 11, 0.2)';
                validationDiv.style.border = '2px solid var(--accent-orange)';
                validationDiv.innerHTML = `
                    <strong style="color: var(--accent-orange);">Enter weights for each product</strong>
                `;
            }
        }

        // Add listeners to initial split weight inputs
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.splitWeight').forEach(input => {
                input.addEventListener('input', updateSplitValidation);
            });
        });

        async function submitSplitBatch() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('finishingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) return;
            
            // Collect split data
            const splitItems = document.querySelectorAll('.split-product-item');
            const splits = [];
            
            splitItems.forEach(item => {
                const productType = item.querySelector('.splitProductType').value;
                const weight = parseFloat(item.querySelector('.splitWeight').value) || 0;
                
                if (productType && weight > 0) {
                    splits.push({ productType, weight });
                }
            });
            
            if (splits.length < 2) {
                alert('Please specify at least 2 products to split the batch');
                return;
            }
            
            const totalAllocated = splits.reduce((sum, s) => sum + s.weight, 0);
            
            // Calculate overall yield percentage from parent batch
            const parentTrimWeight = parseFloat(batch.trim_weight) || 0;
            const overallYieldPercent = parentTrimWeight > 0 ? (totalAllocated / parentTrimWeight) * 100 : 0;
            
            if (!confirm(`Create ${splits.length} sub-batches from ${batchId}?\n\nParent Trim: ${parentTrimWeight.toFixed(1)}g\nTotal Yield: ${totalAllocated.toFixed(1)}g\nYield %: ${overallYieldPercent.toFixed(2)}%\n\n${splits.map((s, i) => `${String.fromCharCode(65 + i)}: ${s.weight}g ‚Üí ${s.productType}`).join('\n')}`)) {
                return;
            }
            
            // Create sub-batches
            const subBatches = [];
            const parentTimeline = batch.timeline || [];
            
            parentTimeline.push({
                stage: 'finishing',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `Split into ${splits.length} sub-batches: ${splits.map(s => s.productType).join(', ')} - Total yield: ${overallYieldPercent.toFixed(2)}%`
            });
            
            for (let i = 0; i < splits.length; i++) {
                const split = splits[i];
                const subBatchId = `${batchId}-${String.fromCharCode(65 + i)}`;
                
                // Calculate proportional trim weight based on this sub-batch's contribution to total yield
                // If overall yield is 18% and this sub-batch is 50g, then it used (50 / 0.18) = 277.8g of trim
                const subBatchTrimWeight = overallYieldPercent > 0 
                    ? (split.weight / overallYieldPercent) * 100
                    : parentTrimWeight * (split.weight / totalAllocated);
                
                const subBatch = {
                    id: subBatchId,
                    parent_batch_id: batchId,
                    is_sub_batch: true,
                    strain: batch.strain,
                    strain_type: batch.strain_type,
                    trim_weight: subBatchTrimWeight, // Proportional trim weight based on actual yield
                    material_cost: batch.material_cost * (split.weight / totalAllocated), // Proportional cost
                    material_agreement: batch.material_agreement,
                    pre_sift: batch.pre_sift,
                    cultivation_license: batch.cultivation_license,
                    grower_name: batch.grower_name,
                    intake_date: batch.intake_date,
                    planned_products: [split.productType],
                    intake_notes: `Sub-batch from ${batchId} - Allocated ${subBatchTrimWeight.toFixed(1)}g trim for ${split.weight}g final product`,
                    status: 'finishing',
                    intake_user: batch.intake_user,
                    extraction_date: batch.extraction_date,
                    extraction_method: batch.extraction_method,
                    product_made: split.productType,
                    extraction_user: batch.extraction_user,
                    finishing_date: new Date().toISOString().split('T')[0],
                    finishing_user: currentRole ? currentRole.name : "Unknown",
                    final_weight: split.weight, // The weight allocated IS the final weight
                    timeline: [
                        {
                            stage: 'split',
                            user: currentRole ? currentRole.name : "Unknown",
                            date: new Date().toISOString(),
                            action: `Created from ${batchId} - ${subBatchTrimWeight.toFixed(1)}g trim ‚Üí ${split.weight}g ${split.productType} (${overallYieldPercent.toFixed(2)}% yield)`
                        }
                    ],
                    created_at: new Date().toISOString()
                };
                
                subBatches.push(subBatch);
            }
            
            // Insert all sub-batches
            const { error: insertError } = await supabaseClient
                .from('wm_batches')
                .insert(subBatches);
            
            if (insertError) {
                console.error('Error creating sub-batches:', insertError);
                alert('Error creating sub-batches. Please try again.');
                return;
            }
            
            // Update parent batch to mark as split
            const { error: updateError } = await supabaseClient
                .from('wm_batches')
                .update({
                    status: 'split',
                    timeline: parentTimeline
                })
                .eq('id', batchId);
            
            if (updateError) {
                console.error('Error updating parent batch:', updateError);
            }
            
            showCelebration({
                emoji: 'üî•',
                title: 'Batch Split Complete!',
                message: `Created ${splits.length} sub-batches from ${batchId}`,
                stats: [
                    { value: splits.length, label: 'Sub-Batches' },
                    { value: `${overallYieldPercent.toFixed(1)}%`, label: 'Overall Yield' }
                ]
            });

            document.getElementById('finishingForm').style.display = 'none';
            document.getElementById('finishingBatchSelect').value = '';
            
            await loadBatches();
            populateFinishingSelect();
        }

        async function submitFinishing() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('finishingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) return;
            
            const finalWeight = parseFloat(document.getElementById('finalWeight').value);
            const sampleWeight = parseFloat(document.getElementById('sampleWeight').value);
            const netWeight = finalWeight - sampleWeight;
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'finishing',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `Finishing completed - QC: ${finalWeight}g bulk, ${sampleWeight}g sample pulled for testing`
            });
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update({
                    status: 'finishing',
                    finishing_date: document.getElementById('finishingDate').value,
                    final_weight: finalWeight,
                    sample_weight: sampleWeight,
                    finishing_notes: document.getElementById('finishingNotes').value,
                    finishing_user: currentRole ? currentRole.name : "Unknown",
                    net_weight: netWeight,
                    timeline: timeline
                })
                .eq('id', batchId);
            
            if (error) {
                console.error('Error updating batch:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            showCelebration({
                emoji: '‚ú®',
                title: 'Finishing Complete!',
                message: `${batchId} has been processed and is ready for packaging.`,
                stats: [
                    { value: `${finalWeight}g`, label: 'Final Weight' },
                    { value: `${((netWeight / batch.trim_weight) * 100).toFixed(1)}%`, label: 'Yield' }
                ]
            });

            document.getElementById('finishingForm').style.display = 'none';
            document.getElementById('finishingBatchSelect').value = '';
            document.getElementById('finishingNotes').value = '';
            
            await loadBatches();
            populateFinishingSelect();
        }

        // Packaging functions
        function populatePackagingSelect() {
            const select = document.getElementById('packagingBatchSelect');
            const finishingBatches = batches.filter(b => b.status === 'finishing');
            
            select.innerHTML = '<option value="">Select a batch...</option>';
            finishingBatches.forEach(batch => {
                const weight = batch.final_weight || batch.net_weight || 0;
                const pauseIndicator = batch.packaging_paused ? ' ‚è∏Ô∏è PAUSED' : '';
                select.innerHTML += `<option value="${batch.id}">${batch.id} - ${batch.strain} - ${batch.product_made} (${weight}g)${pauseIndicator}</option>`;
            });
        }

        document.getElementById('packagingBatchSelect').addEventListener('change', function() {
            const form = document.getElementById('packagingForm');
            form.style.display = this.value ? 'block' : 'none';
            
            if (this.value) {
                const batch = batches.find(b => b.id === this.value);
                document.getElementById('packagingDate').value = new Date().toISOString().split('T')[0];
                
                // Show strain type with color coding
                const strainTypeAlert = document.getElementById('strainTypeAlert');
                const strainTypeName = document.getElementById('strainTypeName');
                
                if (batch.strain_type) {
                    strainTypeAlert.style.display = 'block';
                    strainTypeName.textContent = batch.strain_type;
                    
                    // Color code based on strain type
                    if (batch.strain_type === 'Indica') {
                        // BLUE for Indica
                        strainTypeAlert.style.background = 'rgba(59, 130, 246, 0.2)';
                        strainTypeAlert.style.borderColor = 'var(--accent-blue)';
                        strainTypeName.style.color = 'var(--accent-blue)';
                    } else if (batch.strain_type === 'Sativa') {
                        // RED for Sativa
                        strainTypeAlert.style.background = 'rgba(239, 68, 68, 0.2)';
                        strainTypeAlert.style.borderColor = 'var(--accent-red)';
                        strainTypeName.style.color = 'var(--accent-red)';
                    } else if (batch.strain_type === 'Hybrid') {
                        // GREEN for Hybrid
                        strainTypeAlert.style.background = 'rgba(16, 185, 129, 0.2)';
                        strainTypeAlert.style.borderColor = 'var(--accent-green)';
                        strainTypeName.style.color = 'var(--accent-green)';
                    }
                } else {
                    strainTypeAlert.style.display = 'none';
                }
                
                // Update pause button visibility
                updatePauseButtons();
            }
        });

        // Handle product type selection for multi-size vs single-size
        document.getElementById('packagedProductType').addEventListener('change', function() {
            const multiSize = document.getElementById('multiSizeSection');
            const singleSize = document.getElementById('singleSizeSection');
            const bulkSaleAlert = document.getElementById('bulkSaleAlert');
            const units1gLabel = multiSize.querySelector('label[for="units1g"]') || multiSize.querySelectorAll('label')[0];
            const units4gLabel = multiSize.querySelector('label[for="units4g"]') || multiSize.querySelectorAll('label')[1];
            
            // Show/hide bulk sale alert
            if (this.value === 'Bulk Sale') {
                bulkSaleAlert.style.display = 'block';
            } else {
                bulkSaleAlert.style.display = 'none';
            }
            
            if (this.value === 'Wax/Sugar' || this.value === 'Brick Hash') {
                multiSize.style.display = 'block';
                singleSize.style.display = 'none';
                document.getElementById('unitsPackaged').required = false;
                
                // Set labels for 1g/4g
                if (units1gLabel) units1gLabel.textContent = '1g Units';
                if (units4gLabel) units4gLabel.textContent = '4g Units';
                
            } else if (this.value === 'Hash Hits') {
                multiSize.style.display = 'block';
                singleSize.style.display = 'none';
                document.getElementById('unitsPackaged').required = false;
                
                // Set labels for 2-pack/5-pack
                if (units1gLabel) units1gLabel.textContent = '2-Packs';
                if (units4gLabel) units4gLabel.textContent = '5-Packs';
                
            } else {
                multiSize.style.display = 'none';
                singleSize.style.display = 'block';
                document.getElementById('unitsPackaged').required = true;
                // Reset multi-size fields
                document.getElementById('units1g').value = 0;
                document.getElementById('units4g').value = 0;
            }
        });

        // Auto-calculate totals for multi-size packaging
        function updateMultiSizeCalcs() {
            const productType = document.getElementById('packagedProductType').value;
            const units1g = parseInt(document.getElementById('units1g').value) || 0;
            const units4g = parseInt(document.getElementById('units4g').value) || 0;
            
            let totalGrams, totalUnits;
            
            if (productType === 'Hash Hits') {
                // Hash Hits: 0.2g per hit, 2-packs and 5-packs
                const totalHits = (units1g * 2) + (units4g * 5);
                totalGrams = totalHits * 0.2;
                totalUnits = units1g + units4g; // Total packs
                
                document.getElementById('totalGramsCalc').value = `${totalGrams.toFixed(1)}g (${totalHits} hits)`;
                document.getElementById('totalUnitsCalc').value = `${totalUnits} packs`;
            } else {
                // Regular 1g/4g products
                totalGrams = (units1g * 1) + (units4g * 4);
                totalUnits = units1g + units4g;
                
                document.getElementById('totalGramsCalc').value = totalGrams;
                document.getElementById('totalUnitsCalc').value = totalUnits;
            }
            
            // Update pricing when quantities change
            updatePricing();
        }

        // Calculate wholesale price based on SKU pricing (internal use only, not displayed to packagers)
        document.getElementById('units1g').addEventListener('input', updateMultiSizeCalcs);
        document.getElementById('units4g').addEventListener('input', updateMultiSizeCalcs);

        // Start packaging (marks batch as in-progress)
        async function startPackaging() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('packagingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) return;
            
            const packagingDate = document.getElementById('packagingDate').value;
            const productType = document.getElementById('packagedProductType').value;
            
            if (!packagingDate || !productType) {
                alert('Please select packaging date and product type');
                return;
            }
            
            const confirmation = confirm(
                `Mark batch ${batchId} as STARTED packaging?\n\n` +
                `This will:\n` +
                `‚Ä¢ Add "Packaging Started" to timeline\n` +
                `‚Ä¢ Keep status as "finishing" (not yet complete)\n` +
                `‚Ä¢ Allow you to finish later\n\n` +
                `You can skip this and go straight to "Complete Packaging" for single sessions.`
            );
            
            if (!confirmation) return;
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'packaging',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `Packaging started - ${productType}`
            });
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update({
                    packaging_date: packagingDate,
                    packaged_product_type: productType,
                    packaging_notes: document.getElementById('packagingNotes').value || null,
                    timeline: timeline
                })
                .eq('id', batchId);
            
            if (error) {
                console.error('Error marking batch as started:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            alert(`‚úÖ Batch ${batchId} marked as packaging in progress!\n\n` +
                  `Product Type: ${productType}\n` +
                  `Started by: ${currentRole.name}\n\n` +
                  `This batch will remain in the dropdown until you click "Complete Packaging".`);
            
            // Refresh batch data but keep form open and batch selected
            await loadBatches();
            populatePackagingSelect();
            
            // Re-select the batch
            document.getElementById('packagingBatchSelect').value = batchId;
            document.getElementById('packagingForm').style.display = 'block';
        }

        // Toggle pause/resume for packaging
        async function togglePausePackaging() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('packagingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) {
                alert('Please select a batch first!');
                return;
            }
            
            const isPaused = batch.packaging_paused || false;
            const action = isPaused ? 'RESUME' : 'PAUSE';
            const actionVerb = isPaused ? 'Resumed' : 'Paused';
            
            const confirmation = confirm(
                `${action} packaging for batch ${batchId}?\n\n` +
                `This will:\n` +
                `‚Ä¢ Add "${actionVerb}" to timeline\n` +
                `‚Ä¢ ${isPaused ? 'Allow work to continue' : 'Temporarily stop work'}\n` +
                `‚Ä¢ Keep batch in packaging stage`
            );
            
            if (!confirmation) return;
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'packaging',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `Packaging ${actionVerb.toLowerCase()} - ${batch.product_type || 'unknown product'}`
            });
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update({
                    packaging_paused: !isPaused,
                    timeline: timeline
                })
                .eq('id', batchId);
            
            if (error) {
                console.error('Error toggling pause:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            alert(`‚úÖ Packaging ${actionVerb.toLowerCase()} for batch ${batchId}!\n\n` +
                  `${isPaused ? 'Work can continue.' : 'Work temporarily stopped.'}\n` +
                  `${actionVerb} by: ${currentRole.name}`);
            
            await loadBatches();
            populatePackagingSelect();
            // Keep the batch selected
            document.getElementById('packagingBatchSelect').value = batchId;
            document.getElementById('packagingBatchSelect').dispatchEvent(new Event('change'));
        }

        async function submitPackaging() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }
            
            const batchId = document.getElementById('packagingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);

            if (!batch) {
                alert('Batch not found. Please select a batch.');
                return;
            }

            const packagedProductType = document.getElementById('packagedProductType').value;

            if (!packagedProductType) {
                alert('Please select a product type');
                return;
            }

            let unitsPackaged, totalGrams, packagingDetails;

            // Wholesale price set to 0 (staff doesn't know this info)
            const wholesalePrice = 0;
            
            // Handle multi-size packaging
            if (packagedProductType === 'Wax/Sugar' || packagedProductType === 'Brick Hash' || packagedProductType === 'Hash Hits') {
                const units1g = parseInt(document.getElementById('units1g').value) || 0;
                const units4g = parseInt(document.getElementById('units4g').value) || 0;
                
                if (units1g === 0 && units4g === 0) {
                    alert('Please enter at least one package size');
                    return;
                }
                
                if (packagedProductType === 'Hash Hits') {
                    // Hash Hits: 0.2g per hit
                    const totalHits = (units1g * 2) + (units4g * 5);
                    totalGrams = totalHits * 0.2;
                    unitsPackaged = units1g + units4g; // Total packs
                    
                    packagingDetails = {
                        units_1g: units1g,
                        units_4g: units4g,
                        total_grams: totalGrams,
                        packaging_breakdown: `${units1g}x 2-pack, ${units4g}x 5-pack`
                    };
                } else {
                    // Wax/Sugar or Brick Hash
                    totalGrams = (units1g * 1) + (units4g * 4);
                    unitsPackaged = units1g + units4g;
                    
                    packagingDetails = {
                        units_1g: units1g,
                        units_4g: units4g,
                        total_grams: totalGrams,
                        packaging_breakdown: `${units1g}x 1g, ${units4g}x 4g`
                    };
                }
            } else {
                // Single size packaging
                unitsPackaged = parseInt(document.getElementById('unitsPackaged').value);
                
                if (!unitsPackaged || unitsPackaged === 0) {
                    alert('Please enter units packaged');
                    return;
                }
                
                packagingDetails = {
                    units_1g: null,
                    units_4g: null,
                    total_grams: null,
                    packaging_breakdown: null
                };
            }
            
            const timeline = batch.timeline || [];
            
            // Check if this is a bulk sale
            const isBulkSale = packagedProductType === 'Bulk Sale';
            
            if (packagedProductType === 'Wax/Sugar' || packagedProductType === 'Brick Hash') {
                timeline.push({
                    stage: 'packaging',
                    user: currentRole ? currentRole.name : "Unknown",
                    date: new Date().toISOString(),
                    action: `Packaged ${unitsPackaged} total units (${packagingDetails.packaging_breakdown} = ${totalGrams}g) - ${packagedProductType}`
                });
            } else if (isBulkSale) {
                timeline.push({
                    stage: 'packaging',
                    user: currentRole ? currentRole.name : "Unknown",
                    date: new Date().toISOString(),
                    action: `Bulk sale - ${unitsPackaged} unit(s) - Skipping labeling process`
                });
            } else {
                timeline.push({
                    stage: 'packaging',
                    user: currentRole ? currentRole.name : "Unknown",
                    date: new Date().toISOString(),
                    action: `Packaged ${unitsPackaged} units - ${packagedProductType}`
                });
            }
            
            // Prepare update data
            const updateData = {
                packaging_date: document.getElementById('packagingDate').value,
                packaged_product_type: packagedProductType,
                units_packaged: unitsPackaged,
                units_1g: packagingDetails.units_1g,
                units_4g: packagingDetails.units_4g,
                total_grams_packaged: packagingDetails.total_grams,
                packaging_breakdown: packagingDetails.packaging_breakdown,
                wholesale_price: wholesalePrice,
                packaging_notes: document.getElementById('packagingNotes').value,
                packaging_user: currentRole ? currentRole.name : "Unknown",
                timeline: timeline
            };
            
            // If bulk sale, mark as fully complete and skip labeling
            if (isBulkSale) {
                updateData.status = 'complete';
                updateData.labels_applied = true; // Mark as "labeled" to skip labeling queue
                updateData.labeling_date = document.getElementById('packagingDate').value;
                updateData.labeling_user = currentRole ? currentRole.name : "Unknown";
                updateData.labeling_notes = 'Bulk sale - labeling not required';
                updateData.completed_at = new Date().toISOString();
                
                // Add completion timeline entry
                timeline.push({
                    stage: 'complete',
                    user: currentRole ? currentRole.name : "Unknown",
                    date: new Date().toISOString(),
                    action: 'Bulk sale completed - no labeling required'
                });
                updateData.timeline = timeline;
            } else {
                // Normal packaging - goes to "complete" status waiting for labeling
                updateData.status = 'complete';
                updateData.completed_at = new Date().toISOString();
            }
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update(updateData)
                .eq('id', batchId);
            
            if (error) {
                console.error('Error updating batch:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            if (isBulkSale) {
                showCelebration({
                    emoji: 'üí∞',
                    title: 'Bulk Sale Complete!',
                    message: `${batchId} has been packaged for bulk sale!`,
                    stats: [
                        { value: `${totalGrams}g`, label: 'Total Weight' },
                        { value: packagedProductType, label: 'Product' }
                    ]
                });
            } else {
                showCelebration({
                    emoji: 'üì¶',
                    title: 'Packaging Complete!',
                    message: `${batchId} is packed and ready for labeling!`,
                    stats: [
                        { value: unitsPackaged, label: 'Units Packed' },
                        { value: packagedProductType, label: 'Product' }
                    ]
                });
            }

            document.getElementById('packagingForm').style.display = 'none';
            document.getElementById('packagingBatchSelect').value = '';
            document.getElementById('packagingNotes').value = '';
            document.getElementById('units1g').value = 0;
            document.getElementById('units4g').value = 0;
            document.getElementById('unitsPackaged').value = '';
            
            await loadBatches();
            populatePackagingSelect();
        }

        // Dashboard functions
        function updateDashboard() {
            document.getElementById('totalBatches').textContent = batches.length;
            document.getElementById('activeBatches').textContent = batches.filter(b => b.status !== 'complete').length;
            document.getElementById('completedBatches').textContent = batches.filter(b => b.status === 'complete').length;
            
            const totalGrams = batches.reduce((sum, b) => sum + (parseFloat(b.trim_weight) || 0), 0);
            document.getElementById('totalGramsIn').textContent = totalGrams.toFixed(0) + 'g';
            
            // Calculate total weight loss from bulk to labeled
            let totalWeightLoss = 0;
            let batchesWithDiscrepancy = 0;
            
            batches.forEach(batch => {
                if (batch.grams_labeled && batch.net_weight) {
                    const labeled = parseFloat(batch.grams_labeled);
                    const bulk = parseFloat(batch.net_weight);
                    const loss = bulk - labeled;
                    
                    if (loss > 0) {
                        totalWeightLoss += loss;
                        
                        // Count significant discrepancies (>5% or >5g)
                        const lossPercent = (loss / bulk) * 100;
                        if (lossPercent > 5 || loss > 5) {
                            batchesWithDiscrepancy++;
                        }
                    }
                }
            });
            
            // Update weight discrepancy card
            const discrepancyCard = document.getElementById('weightDiscrepancyCard');
            const weightLossElement = document.getElementById('totalWeightLoss');
            
            if (totalWeightLoss > 0) {
                discrepancyCard.style.display = 'block';
                weightLossElement.textContent = `${totalWeightLoss.toFixed(1)}g`;
                
                // Update label to show count if there are significant discrepancies
                const label = discrepancyCard.querySelector('.stat-label');
                if (batchesWithDiscrepancy > 0) {
                    label.innerHTML = `‚ö†Ô∏è Weight Loss (${batchesWithDiscrepancy} batches)`;
                    weightLossElement.style.color = 'var(--accent-orange)';
                } else {
                    label.innerHTML = '‚ö†Ô∏è Weight Loss (Bulk‚ÜíLabel)';
                    weightLossElement.style.color = 'var(--accent-blue)';
                }
            } else {
                discrepancyCard.style.display = 'none';
            }
            
            // Update personal workload stats
            updatePersonalWorkloadStats();
            
            // Update badge counts on navigation tabs
            updateBadgeCounts();
        }

        // Update badge counts on navigation tabs
        function updateBadgeCounts() {
            // Count batches at each stage (excluding intake)
            const counts = {
                extraction: batches.filter(b => b.status === 'intake').length, // Waiting for extraction
                finishing: batches.filter(b => b.status === 'extraction').length, // Waiting for post-extraction
                packaging: batches.filter(b => b.status === 'finishing').length, // Waiting for packaging
                testing: batches.filter(b => b.status === 'packaging' || (b.status === 'complete' && !b.test_thc_percent)).length,
                labeling: batches.filter(b => b.status === 'complete' && b.test_thc_percent && !b.labels_applied).length
            };
            
            // Update each badge
            Object.entries(counts).forEach(([stage, count]) => {
                const badge = document.getElementById(`badge-${stage}`);
                if (badge) {
                    badge.textContent = count;
                    if (count > 0) {
                        badge.classList.add('has-count');
                    } else {
                        badge.classList.remove('has-count');
                    }
                }
            });
        }

        // Personal Performance Stats Dashboard
        let currentPersonalPeriod = 'today';
        
        function updatePersonalStats(period = 'today') {
            currentPersonalPeriod = period;
            
            // Update button states
            document.querySelectorAll('.personal-time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const periodBtn = document.querySelector(`[data-period="${period}"]`);
            if (periodBtn) periodBtn.classList.add('active');
            
            if (!currentRole) {
                document.getElementById('personalStatsContent').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">Please login to see your stats</p>';
                document.getElementById('personalRecordsContent').innerHTML = '';
                return;
            }
            
            // Calculate date range
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                    break;
                case 'all':
                default:
                    startDate = new Date(0); // Beginning of time
            }
            
            // Calculate stats
            const stats = calculatePersonalStats(currentRole.name, startDate);
            
            // Display stats
            displayPersonalStats(stats, period);
            displayPersonalRecords(currentRole.name);
        }
        
        function calculatePersonalStats(userName, startDate) {
            const stats = {
                unitsPackaged: 0,
                unitsLabeled: 0,
                gramsExtracted: 0,
                batchesFinished: 0,
                avgPackagingRate: 0,
                avgLabelingRate: 0
            };
            
            batches.forEach(batch => {
                // PACKAGING: Check packaging_user field (same as Performance tab uses)
                if (batch.packaging_user === userName && batch.packaging_date && batch.units_packaged) {
                    const packagingDate = new Date(batch.packaging_date);
                    if (packagingDate >= startDate) {
                        stats.unitsPackaged += parseInt(batch.units_packaged) || 0;
                    }
                }
                
                // EXTRACTION: Check extraction_user field first (most reliable)
                if (batch.extraction_user === userName && batch.status !== 'intake' && batch.trim_weight) {
                    // Check if extraction was done in the date range
                    let extractionDate = null;
                    if (batch.timeline && batch.timeline.length > 0) {
                        const extractionEvent = batch.timeline.find(e => 
                            e.stage === 'extraction' && e.user === userName
                        );
                        if (extractionEvent) {
                            extractionDate = new Date(extractionEvent.timestamp || extractionEvent.date);
                        }
                    }
                    
                    // If we found an extraction event in the date range, count it
                    if (extractionDate && extractionDate >= startDate) {
                        const grams = parseFloat(batch.trim_weight) || 0;
                        stats.gramsExtracted += grams;
                    }
                }
                
                // FINISHING: Check finishing_user field
                if (batch.finishing_user === userName && batch.status !== 'intake' && batch.status !== 'extraction') {
                    // Check if finishing was done in the date range
                    let finishingDate = null;
                    if (batch.timeline && batch.timeline.length > 0) {
                        const finishingEvent = batch.timeline.find(e => 
                            e.stage === 'finishing' && e.user === userName
                        );
                        if (finishingEvent) {
                            finishingDate = new Date(finishingEvent.timestamp || finishingEvent.date);
                        }
                    }
                    
                    // If we found a finishing event in the date range, count it
                    if (finishingDate && finishingDate >= startDate) {
                        stats.batchesFinished++;
                    }
                }
                
                // LABELING: Check timeline (same as before)
                if (batch.timeline && batch.timeline.length > 0) {
                    batch.timeline.forEach(event => {
                        if (!event.date && !event.timestamp) return;
                        if (!event.user || event.user !== userName) return;
                        
                        const eventDate = new Date(event.timestamp || event.date);
                        if (eventDate < startDate) return;
                        
                        // Labeling
                        if (event.stage === 'labeling' && event.action && 
                            (event.action.toLowerCase().includes('completed') || event.action.toLowerCase().includes('labeled')) &&
                            batch.units_packaged) {
                            stats.unitsLabeled += parseInt(batch.units_packaged) || 0;
                        }
                    });
                }
            });

            return stats;
        }
        
        function displayPersonalStats(stats, period) {
            const periodLabel = {
                'today': 'Today',
                'week': 'This Week', 
                'month': 'This Month',
                'all': 'All Time'
            }[period];
            
            const statName = `${currentRole.name}'s Performance - ${periodLabel}`;
            const personalStatEl = document.getElementById('personalStatName');
            const modalStatEl = document.getElementById('modalPersonalStatName');
            if (personalStatEl) personalStatEl.textContent = statName;
            if (modalStatEl) modalStatEl.textContent = statName;
            
            // Convert grams to pounds if over 454g (1 lb)
            const extractedDisplay = stats.gramsExtracted >= 454 
                ? `${(stats.gramsExtracted / 453.592).toFixed(1)} lbs`
                : `${stats.gramsExtracted.toFixed(0)}g`;
            
            const content = `
                <div class="stat-box">
                    <div class="stat-number">${stats.unitsPackaged.toLocaleString()}</div>
                    <div class="stat-label">üì¶ Units Packaged</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-number">${stats.unitsLabeled.toLocaleString()}</div>
                    <div class="stat-label">üè∑Ô∏è Units Labeled</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-number">${extractedDisplay}</div>
                    <div class="stat-label">‚öóÔ∏è Trim Extracted</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-number">${stats.batchesFinished}</div>
                    <div class="stat-label">‚ú® Batches Finished</div>
                </div>
                
                ${stats.avgPackagingRate > 0 ? `
                <div class="stat-box">
                    <div class="stat-number">${stats.avgPackagingRate}</div>
                    <div class="stat-label">üìä Units/Hour (Packaging)</div>
                </div>
                ` : ''}
                
                ${stats.avgLabelingRate > 0 ? `
                <div class="stat-box">
                    <div class="stat-number">${stats.avgLabelingRate}</div>
                    <div class="stat-label">‚ö° Units/Hour (Labeling)</div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('personalStatsContent').innerHTML = content;
        }
        
        // Open/close personal stats modal
        function openPersonalStatsModal() {
            if (!currentRole) {
                alert('Please login first to see your stats!');
                return;
            }
            
            document.getElementById('personalStatsModal').style.display = 'block';
            populateWhatsNext();
            populateTodayProgress();
            populateMyBatches();
            updatePersonalStats('today');
        }
        
        function populateWhatsNext() {
            const userName = currentRole.name;
            const whatsNextEl = document.getElementById('whatsNextContent');
            
            // Find next batch waiting for this user based on their role
            let nextBatch = null;
            let taskType = '';
            
            // Check for packaging tasks
            if (currentRole.access.includes('packaging')) {
                nextBatch = batches.find(b => b.status === 'finishing' && !b.packaging_user);
                taskType = 'üì¶ Packaging';
            }
            
            // Check for labeling tasks
            if (!nextBatch && currentRole.access.includes('labeling')) {
                nextBatch = batches.find(b => b.status === 'packaging' && !b.labeling_user);
                taskType = 'üè∑Ô∏è Labeling';
            }
            
            // Check for extraction tasks
            if (!nextBatch && currentRole.access.includes('extraction')) {
                nextBatch = batches.find(b => b.status === 'intake');
                taskType = '‚öóÔ∏è Extraction';
            }
            
            // Check for finishing tasks
            if (!nextBatch && currentRole.access.includes('finishing')) {
                nextBatch = batches.find(b => b.status === 'extraction');
                taskType = 'üî• Finishing';
            }
            
            if (nextBatch) {
                whatsNextEl.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--accent-green); margin-bottom: 10px;">${taskType}</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary); font-family: 'Space Mono', monospace;">${nextBatch.id}</div>
                        <div style="color: var(--text-secondary); margin-top: 5px;">${nextBatch.strain || 'Unknown strain'}</div>
                        ${nextBatch.trim_weight ? `<div style="color: var(--text-secondary); margin-top: 5px;">${parseFloat(nextBatch.trim_weight).toFixed(0)}g trim</div>` : ''}
                    </div>
                `;
            } else {
                whatsNextEl.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                        <div>All caught up! No batches waiting for you.</div>
                    </div>
                `;
            }
        }
        
        function populateTodayProgress() {
            const userName = currentRole.name;
            const today = new Date().toISOString().split('T')[0];
            const progressEl = document.getElementById('todayProgressContent');
            
            let packaged = 0;
            let labeled = 0;
            let extracted = 0;
            let finished = 0;
            
            batches.forEach(batch => {
                // Packaging
                if (batch.packaging_user === userName && batch.packaging_date) {
                    const date = new Date(batch.packaging_date).toISOString().split('T')[0];
                    if (date === today) packaged += parseInt(batch.units_packaged) || 0;
                }
                
                // Labeling
                if (batch.timeline) {
                    batch.timeline.forEach(event => {
                        if (event.user === userName && event.stage === 'labeling') {
                            const date = new Date(event.timestamp).toISOString().split('T')[0];
                            if (date === today) labeled += parseInt(batch.units_packaged) || 0;
                        }
                    });
                }
                
                // Extraction
                if (batch.timeline) {
                    const extractionEvent = batch.timeline.find(e => e.status === 'extraction' && e.user === userName);
                    if (extractionEvent) {
                        const date = new Date(extractionEvent.timestamp).toISOString().split('T')[0];
                        if (date === today) extracted++;
                    }
                }
                
                // Finishing
                if (batch.finishing_user === userName && batch.finishing_date) {
                    const date = new Date(batch.finishing_date).toISOString().split('T')[0];
                    if (date === today) finished++;
                }
            });
            
            let html = '';
            if (packaged > 0) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">üì¶ Packaged</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">${packaged}</div>
                </div>`;
            }
            if (labeled > 0) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">üè∑Ô∏è Labeled</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${labeled}</div>
                </div>`;
            }
            if (extracted > 0) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">‚öóÔ∏è Extracted</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange);">${extracted}</div>
                </div>`;
            }
            if (finished > 0) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">üî• Finished</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${finished}</div>
                </div>`;
            }
            
            if (html === '') {
                html = `<div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">
                    No production completed yet today
                </div>`;
            }
            
            progressEl.innerHTML = html;
        }
        
        function populateMyBatches() {
            const userName = currentRole.name;
            const batchesEl = document.getElementById('myBatchesList');
            
            const myBatches = batches.filter(b => {
                return (b.packaging_user === userName && b.status !== 'complete') ||
                       (b.finishing_user === userName && b.status !== 'complete') ||
                       (b.extraction_user === userName && b.status !== 'complete') ||
                       (b.timeline && b.timeline.some(e => e.user === userName));
            });
            
            if (myBatches.length === 0) {
                batchesEl.innerHTML = `<div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center; color: var(--text-secondary);">
                    No active batches assigned to you
                </div>`;
                return;
            }
            
            batchesEl.innerHTML = myBatches.map(batch => {
                const statusColors = {
                    'intake': 'var(--accent-orange)',
                    'extraction': 'var(--accent-blue)',
                    'finishing': 'var(--accent-purple)',
                    'packaging': 'var(--accent-green)',
                    'complete': 'var(--accent-green)'
                };
                
                return `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColors[batch.status] || 'var(--border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 700; font-family: 'Space Mono', monospace;">${batch.id}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${batch.strain || 'Unknown'} ‚Ä¢ ${batch.status}</div>
                        </div>
                        <div style="text-align: right;">
                            ${batch.units_packaged ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${batch.units_packaged} units</div>` : ''}
                            ${batch.net_weight ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${parseFloat(batch.net_weight).toFixed(0)}g</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function closePersonalStatsModal() {
            document.getElementById('personalStatsModal').style.display = 'none';
        }
        
        // Inventory Management Functions
        // Pull Batch Functions
        
        function openPullBatchModal(machine) {
            currentPullMachine = machine;
            const machineName = machine === 'left' ? 'Left Machine' : 'Right Machine';
            document.getElementById('pullBatchModalTitle').textContent = `ü´ô Pull Batch from ${machineName}`;
            
            // Get machine status from Supabase
            supabaseClient
                .from('wm_machine_status')
                .select('*')
                .eq('machine', machine)
                .single()
                .then(({ data: machineStatus, error }) => {
                    if (error) {
                        console.error('Error loading machine status:', error);
                        machineStatus = {};
                    }
                    
                    if (!machineStatus.pot_batch) {
                        alert('‚ö†Ô∏è No batch in pot!\n\nPlease load a batch in the pot first using the machine status button.');
                        return;
                    }
                    
                    // Get batch info
                    const batch = batches.find(b => b.id == machineStatus.pot_batch);
                    if (batch) {
                        document.getElementById('pullBatchNumber').textContent = batch.id;
                        document.getElementById('pullBatchRuns').textContent = `${machineStatus.pot_runs || 0} runs collected`;
                    }
                    
                    // Clear form
                    document.getElementById('pullProductType').value = '';
                    document.getElementById('pullSlabs').value = '';
                    document.getElementById('pullBowls').value = '';
                    document.getElementById('pullNotes').value = '';
                    updatePullFields();
                    
                    document.getElementById('pullBatchModal').style.display = 'block';
                });
        }
        
        function closePullBatchModal() {
            document.getElementById('pullBatchModal').style.display = 'none';
            currentPullMachine = null;
        }
        
        function updatePullFields() {
            const productType = document.getElementById('pullProductType').value;
            
            document.getElementById('shatterFields').style.display = productType === 'shatter' ? 'block' : 'none';
            document.getElementById('waxFields').style.display = (productType === 'wax' || productType === 'sugar_wax') ? 'block' : 'none';
        }
        
        function submitPullBatch() {
            if (!currentPullMachine) return;
            
            // Get machine status from Supabase
            supabaseClient
                .from('wm_machine_status')
                .select('*')
                .eq('machine', currentPullMachine)
                .single()
                .then(({ data: machineStatus, error }) => {
                    if (error || !machineStatus || !machineStatus.pot_batch) {
                        alert('No batch in pot!');
                        return;
                    }
                    
                    const productType = document.getElementById('pullProductType').value;
                    const slabs = parseInt(document.getElementById('pullSlabs').value) || 0;
                    const bowls = parseInt(document.getElementById('pullBowls').value) || 0;
                    const notes = document.getElementById('pullNotes').value;
                    
                    if (!productType) {
                        alert('Please select a product type');
                        return;
                    }
                    
                    if (productType === 'shatter' && slabs === 0) {
                        alert('Please enter the number of slabs');
                        return;
                    }
                    
                    if ((productType === 'wax' || productType === 'sugar_wax') && bowls === 0) {
                        alert('Please enter the number of bowls');
                        return;
                    }
                    
                    // Get batch info
                    const batch = batches.find(b => b.id == machineStatus.pot_batch);
                    
                    if (!batch) {
                        alert('Batch not found!');
                        return;
                    }
                    
                    // Continue with the rest of the pull batch logic...
                    completePullBatch(batch, machineStatus, productType, slabs, bowls, notes);
                });
        }
        
        function completePullBatch(batch, machineStatus, productType, slabs, bowls, notes) {
            // Create pull record
            const pullRecord = {
                batchId: machineStatus.pot_batch,
                batchNumber: batch.id,
                machine: currentPullMachine,
                productType: productType,
                slabs: slabs,
                bowls: bowls,
                runs: machineStatus.pot_runs || 0,
                notes: notes,
                timestamp: new Date().toISOString(),
                pulledBy: currentRole ? currentRole.name : 'Unknown'
            };
            
            // Save to localStorage
            const pullHistory = JSON.parse(localStorage.getItem('wm_pull_history') || '[]');
            pullHistory.push(pullRecord);
            localStorage.setItem('wm_pull_history', JSON.stringify(pullHistory));
            
            // Update batch status to 'extraction' (completing extraction phase)
            const productTypeText = productType === 'shatter' ? 'Shatter' : 
                                   productType === 'wax' ? 'Wax' : 'Sugar Wax';
            const amountText = productType === 'shatter' ? `${slabs} slab(s)` : `${bowls} bowl(s)`;
            
            const updatedBatch = {
                ...batch,
                status: 'extraction',
                extraction_method: 'BHO',
                product_type: productTypeText,
                product_made: productTypeText, // Also set product_made for finishing dropdown
                extraction_machine: currentPullMachine === 'left' ? 'Machine 1 (Left)' : 'Machine 2 (Right)',
                extraction_runs: machineStatus.pot_runs || 0,
                extraction_slabs: productType === 'shatter' ? slabs : null,
                extraction_bowls: (productType === 'wax' || productType === 'sugar_wax') ? bowls : null,
                extraction_notes: notes,
                timeline: [
                    ...(batch.timeline || []),
                    {
                        timestamp: new Date().toISOString(),
                        status: 'extraction',
                        user: currentRole ? currentRole.name : 'Unknown',
                        note: `Extraction completed - ${productTypeText} - ${amountText} - ${machineStatus.pot_runs || 0} runs - ${currentPullMachine === 'left' ? 'Machine 1 (Left)' : 'Machine 2 (Right)'}`
                    }
                ]
            };
            
            // Update batch in Supabase
            supabaseClient
                .from('wm_batches')
                .update(updatedBatch)
                .eq('id', batch.id)
                .then(({ error, data }) => {
                    if (error) {
                        console.error('Error updating batch:', error);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                        console.error('Batch data being sent:', updatedBatch);
                        alert(`Error completing extraction:\n\n${error.message || JSON.stringify(error)}\n\nCheck console for details.`);
                        return;
                    }
                    
                    // Clear pot in machine status in Supabase
                    const clearedPotStatus = {
                        machine: currentPullMachine,
                        pot_batch: null,
                        pot_runs: 0,
                        column_batch: machineStatus.column_batch, // Keep column A
                        column_b_batch: machineStatus.column_b_batch, // Keep column B
                        filter_clay: machineStatus.filter_clay, // Keep filter
                        filter_silica: machineStatus.filter_silica,
                        filter_runs: machineStatus.filter_runs,
                        last_updated: new Date().toISOString(),
                        updated_by: currentRole ? currentRole.name : 'Unknown'
                    };
                    
                    supabaseClient
                        .from('wm_machine_status')
                        .upsert(clearedPotStatus, { onConflict: 'machine' })
                        .then(() => {
                            // Reload batches and update displays
                            loadBatches();
                            updateMachineDisplays();
                            closePullBatchModal();
                            
                            alert(`‚úÖ Extraction Complete!\n\n${batch.id}\n${productTypeText}: ${amountText}\n${machineStatus.pot_runs || 0} runs\n\nBatch moved to Finishing stage.\nPot has been emptied.`);
                        });
                });
        }
        
        // Machine Status Tracking
        
        function openMachineModal(machine) {
            currentMachine = machine;
            const machineName = machine === 'left' ? 'Left Machine' : 'Right Machine';
            document.getElementById('machineModalTitle').textContent = `‚öóÔ∏è ${machineName}`;
            
            // Load machine status from Supabase
            supabaseClient
                .from('wm_machine_status')
                .select('*')
                .eq('machine', machine)
                .single()
                .then(({ data: machineStatus, error }) => {
                    if (error) {
                        console.error('Error loading machine status:', error);
                        machineStatus = {};
                    }
                    
                    // Populate batch dropdowns with current batches in intake status
                    const columnSelect = document.getElementById('machineColumnBatch');
                    const columnBSelect = document.getElementById('machineColumnBBatch');
                    const potSelect = document.getElementById('machinePotBatch');
                    
                    // Clear and repopulate
                    columnSelect.innerHTML = '<option value="">Empty / Not Loaded</option>';
                    columnBSelect.innerHTML = '<option value="">Empty / Not Loaded</option>';
                    potSelect.innerHTML = '<option value="">Empty / Not Loaded</option>';
                    
                    batches.forEach(batch => {
                        if (batch.status === 'intake') {
                            const option = `<option value="${batch.id}">${batch.id} - ${batch.cultivation_license} - ${batch.strain}</option>`;
                            columnSelect.innerHTML += option;
                            columnBSelect.innerHTML += option;
                            potSelect.innerHTML += option;
                        }
                    });
                    
                    // Set current values
                    columnSelect.value = machineStatus.column_batch || '';
                    columnBSelect.value = machineStatus.column_b_batch || '';
                    potSelect.value = machineStatus.pot_batch || '';
                    document.getElementById('machinePotRuns').value = machineStatus.pot_runs || '';
                    document.getElementById('machineFilterClay').value = machineStatus.filter_clay || '';
                    document.getElementById('machineFilterSilica').value = machineStatus.filter_silica || '';
                    document.getElementById('machineFilterRuns').value = machineStatus.filter_runs || '';
                    
                    document.getElementById('machineModal').style.display = 'block';
                });
        }
        
        function closeMachineModal() {
            document.getElementById('machineModal').style.display = 'none';
            currentMachine = null;
        }
        
        function saveMachineStatus() {
            if (!currentMachine) return;
            
            const columnBatch = document.getElementById('machineColumnBatch').value;
            const columnBBatch = document.getElementById('machineColumnBBatch').value;
            const potBatch = document.getElementById('machinePotBatch').value;
            const potRuns = parseInt(document.getElementById('machinePotRuns').value) || 0;
            const filterClay = parseFloat(document.getElementById('machineFilterClay').value) || 0;
            const filterSilica = parseFloat(document.getElementById('machineFilterSilica').value) || 0;
            const filterRuns = parseInt(document.getElementById('machineFilterRuns').value) || 0;
            
            const machineStatus = {
                machine: currentMachine,
                column_batch: columnBatch,
                column_b_batch: columnBBatch,
                pot_batch: potBatch,
                pot_runs: potRuns,
                filter_clay: filterClay,
                filter_silica: filterSilica,
                filter_runs: filterRuns,
                last_updated: new Date().toISOString(),
                updated_by: currentRole ? currentRole.name : 'Unknown'
            };
            
            // Save to Supabase
            supabaseClient
                .from('wm_machine_status')
                .upsert(machineStatus, { onConflict: 'machine' })
                .then(({ error }) => {
                    if (error) {
                        console.error('Error saving machine status:', error);
                        alert('Error saving machine status. Please try again.');
                        return;
                    }
                    
                    updateMachineDisplays();
                    closeMachineModal();
                    
                    alert(`‚úÖ ${currentMachine === 'left' ? 'Left' : 'Right'} Machine Status Saved!`);
                });
        }
        
        function clearMachineStatus() {
            if (!currentMachine) return;
            
            if (!confirm(`Are you sure you want to clear all status for the ${currentMachine} machine?\n\nThis will reset column, pot, and filter information.`)) {
                return;
            }
            
            const emptyStatus = {
                machine: currentMachine,
                column_batch: null,
                column_b_batch: null,
                pot_batch: null,
                pot_runs: 0,
                filter_clay: 0,
                filter_silica: 0,
                filter_runs: 0,
                last_updated: new Date().toISOString(),
                updated_by: currentRole ? currentRole.name : 'Unknown'
            };
            
            supabaseClient
                .from('wm_machine_status')
                .upsert(emptyStatus, { onConflict: 'machine' })
                .then(({ error }) => {
                    if (error) {
                        console.error('Error clearing machine status:', error);
                        return;
                    }
                    
                    // Clear form
                    document.getElementById('machineColumnBatch').value = '';
                    document.getElementById('machineColumnBBatch').value = '';
                    document.getElementById('machinePotBatch').value = '';
                    document.getElementById('machinePotRuns').value = '';
                    document.getElementById('machineFilterClay').value = '';
                    document.getElementById('machineFilterSilica').value = '';
                    document.getElementById('machineFilterRuns').value = '';
                    
                    updateMachineDisplays();
                    
                    alert(`‚úÖ ${currentMachine === 'left' ? 'Left' : 'Right'} Machine Cleared!`);
                });
        }
        
        function updateMachineDisplays() {
            supabaseClient
                .from('wm_machine_status')
                .select('*')
                .then(({ data: machineStatuses, error }) => {
                    if (error) {
                        console.error('Error loading machine statuses:', error);
                        return;
                    }
                    
                    ['left', 'right'].forEach(machine => {
                        const machineStatus = machineStatuses.find(m => m.machine === machine) || {};
                        
                        // Get batch info for Column A
                        let columnText = 'Empty';
                        let columnBText = 'Empty';
                        let potText = 'Empty';
                        
                        if (machineStatus.column_batch) {
                            const batch = batches.find(b => b.id == machineStatus.column_batch);
                            columnText = batch ? `${batch.id}` : 'Unknown';
                        }
                        
                        if (machineStatus.column_b_batch) {
                            const batch = batches.find(b => b.id == machineStatus.column_b_batch);
                            columnBText = batch ? `${batch.id}` : 'Unknown';
                        }
                        
                        if (machineStatus.pot_batch) {
                            const batch = batches.find(b => b.id == machineStatus.pot_batch);
                            if (batch) {
                                potText = `${batch.id}`;
                                if (machineStatus.pot_runs) {
                                    potText += ` (${machineStatus.pot_runs} runs)`;
                                }
                            } else {
                                potText = 'Unknown';
                            }
                        }
                        
                        // Filter status
                        let filterText = 'Not loaded';
                        if (machineStatus.filter_clay || machineStatus.filter_silica || machineStatus.filter_runs) {
                            const parts = [];
                            if (machineStatus.filter_clay) parts.push(`${machineStatus.filter_clay}c clay`);
                            if (machineStatus.filter_silica) parts.push(`${machineStatus.filter_silica}c silica`);
                            if (machineStatus.filter_runs) parts.push(`${machineStatus.filter_runs} runs`);
                            filterText = parts.join(', ');
                        }
                        
                        // Update display
                        document.getElementById(`${machine}ColumnBatch`).textContent = columnText;
                        document.getElementById(`${machine}ColumnBBatch`).textContent = columnBText;
                        document.getElementById(`${machine}PotBatch`).textContent = potText;
                        document.getElementById(`${machine}FilterStatus`).textContent = filterText;
                    });
                });
        }
        
        // Supplies Modal
        function openSuppliesModal() {
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .then(({ data: inventory, error }) => {
                    if (error) {
                        console.error('Error loading inventory:', error);
                        return;
                    }
                    
                    const butane = inventory.find(i => i.supply_type === 'butane');
                    const nitrogen = inventory.find(i => i.supply_type === 'nitrogen');
                    
                    // Update displays in modal
                    document.getElementById('modalButaneDisplay').textContent = butane ? `${parseFloat(butane.current_level).toFixed(1)} lbs` : '0.0 lbs';
                    document.getElementById('modalNitrogenDisplay').textContent = nitrogen ? `${parseFloat(nitrogen.current_level).toFixed(1)}` : '0.0';
                    
                    // Clear input fields
                    document.getElementById('modalWithdrawButane').value = '';
                    document.getElementById('modalWithdrawNitrogen').value = '';
                    
                    document.getElementById('suppliesModal').style.display = 'block';
                });
        }
        
        function closeSuppliesModal() {
            document.getElementById('suppliesModal').style.display = 'none';
        }
        
        function withdrawButaneFromModal() {
            const withdrawAmount = parseFloat(document.getElementById('modalWithdrawButane').value);
            
            if (!withdrawAmount || withdrawAmount <= 0) {
                alert('Please enter an amount to withdraw');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'butane')
                .single()
                .then(({ data: butaneRecord, error }) => {
                    if (error) {
                        console.error('Error loading butane inventory:', error);
                        return;
                    }
                    
                    const currentButane = parseFloat(butaneRecord.current_level) || 0;
                    
                    if (withdrawAmount > currentButane) {
                        if (!confirm(`‚ö†Ô∏è Warning: You're withdrawing ${withdrawAmount.toFixed(1)} lbs but only ${currentButane.toFixed(1)} lbs are in the bulk tank.\n\nContinue anyway?`)) {
                            return;
                        }
                    }
                    
                    const newButane = currentButane - withdrawAmount;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: newButane,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'butane')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating butane:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'butane',
                                    transaction_type: 'withdraw',
                                    amount: withdrawAmount,
                                    previous_level: currentButane,
                                    new_level: newButane,
                                    notes: `Withdrew ${withdrawAmount.toFixed(1)} lbs`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    document.getElementById('modalWithdrawButane').value = '';
                                    document.getElementById('modalButaneDisplay').textContent = `${newButane.toFixed(1)} lbs`;
                                    updateSuppliesButton();
                                    
                                    alert(`‚úÖ Withdrawn!\n\n${withdrawAmount.toFixed(1)} lbs butane removed\nRemaining: ${newButane.toFixed(1)} lbs`);
                                });
                        });
                });
        }
        
        function withdrawNitrogenFromModal() {
            const withdrawAmount = parseFloat(document.getElementById('modalWithdrawNitrogen').value);
            
            if (!withdrawAmount || withdrawAmount <= 0) {
                alert('Please enter an amount to withdraw');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'nitrogen')
                .single()
                .then(({ data: nitrogenRecord, error }) => {
                    if (error) {
                        console.error('Error loading nitrogen inventory:', error);
                        return;
                    }
                    
                    const currentNitrogen = parseFloat(nitrogenRecord.current_level) || 0;
                    
                    if (withdrawAmount > currentNitrogen) {
                        if (!confirm(`‚ö†Ô∏è Warning: You're withdrawing ${withdrawAmount.toFixed(1)} tank(s) but only ${currentNitrogen.toFixed(1)} remain.\n\nContinue anyway?`)) {
                            return;
                        }
                    }
                    
                    const newNitrogen = currentNitrogen - withdrawAmount;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: newNitrogen,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'nitrogen')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating nitrogen:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'nitrogen',
                                    transaction_type: 'withdraw',
                                    amount: withdrawAmount,
                                    previous_level: currentNitrogen,
                                    new_level: newNitrogen,
                                    notes: `Withdrew ${withdrawAmount.toFixed(1)} tank(s)`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    document.getElementById('modalWithdrawNitrogen').value = '';
                                    document.getElementById('modalNitrogenDisplay').textContent = `${newNitrogen.toFixed(1)}`;
                                    updateSuppliesButton();
                                    
                                    alert(`‚úÖ Withdrawn!\n\n${withdrawAmount.toFixed(1)} nitrogen tank(s) removed\nRemaining: ${newNitrogen.toFixed(1)} tanks`);
                                });
                        });
                });
        }
        
        // Butane Modals
        function openAddButaneModal() {
            document.getElementById('butaneShipmentAmount').value = '';
            document.getElementById('butaneShipmentNotes').value = '';
            document.getElementById('addShipmentModal').style.display = 'block';
        }
        
        function closeAddButaneModal() {
            document.getElementById('addShipmentModal').style.display = 'none';
        }
        
        function addButaneShipment() {
            const addAmount = parseFloat(document.getElementById('butaneShipmentAmount').value);
            const notes = document.getElementById('butaneShipmentNotes').value;
            
            if (!addAmount || addAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'butane')
                .single()
                .then(({ data: butaneRecord, error }) => {
                    if (error) {
                        console.error('Error loading butane inventory:', error);
                        return;
                    }
                    
                    const currentButane = parseFloat(butaneRecord.current_level) || 0;
                    const newButane = currentButane + addAmount;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: newButane,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'butane')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating butane:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'butane',
                                    transaction_type: 'add',
                                    amount: addAmount,
                                    previous_level: currentButane,
                                    new_level: newButane,
                                    notes: notes || `Added ${addAmount.toFixed(1)} lbs shipment`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    // Update all displays
                                    if (document.getElementById('modalButaneDisplay')) {
                                        document.getElementById('modalButaneDisplay').textContent = `${newButane.toFixed(1)} lbs`;
                                    }
                                    updateSuppliesButton();
                                    closeAddButaneModal();
                                    
                                    alert(`‚úÖ Shipment Added!\n\n${addAmount.toFixed(1)} lbs butane added\nNew Total: ${newButane.toFixed(1)} lbs`);
                                });
                        });
                });
        }
        
        function openEditButaneModal() {
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'butane')
                .single()
                .then(({ data: butaneRecord, error }) => {
                    if (error) {
                        console.error('Error loading butane inventory:', error);
                        return;
                    }
                    
                    const currentButane = parseFloat(butaneRecord.current_level) || 0;
                    document.getElementById('editButaneCurrentDisplay').textContent = `${currentButane.toFixed(1)} lbs`;
                    document.getElementById('butaneSetAmount').value = '';
                    document.getElementById('butaneSetNotes').value = '';
                    document.getElementById('editBulkModal').style.display = 'block';
                });
        }
        
        function closeEditButaneModal() {
            document.getElementById('editBulkModal').style.display = 'none';
        }
        
        function setButaneWeight() {
            const setAmount = parseFloat(document.getElementById('butaneSetAmount').value);
            const notes = document.getElementById('butaneSetNotes').value;
            
            if (!setAmount && setAmount !== 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!notes.trim()) {
                alert('Please provide a reason for this manual change');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'butane')
                .single()
                .then(({ data: butaneRecord, error }) => {
                    if (error) {
                        console.error('Error loading butane inventory:', error);
                        return;
                    }
                    
                    const currentButane = parseFloat(butaneRecord.current_level) || 0;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: setAmount,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'butane')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating butane:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'butane',
                                    transaction_type: 'edit',
                                    amount: setAmount - currentButane,
                                    previous_level: currentButane,
                                    new_level: setAmount,
                                    notes: `Manual adjustment: ${notes}`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    // Update all displays
                                    if (document.getElementById('modalButaneDisplay')) {
                                        document.getElementById('modalButaneDisplay').textContent = `${setAmount.toFixed(1)} lbs`;
                                    }
                                    updateSuppliesButton();
                                    closeEditButaneModal();
                                    
                                    alert(`‚úÖ Butane Updated!\n\nManually set to ${setAmount.toFixed(1)} lbs (was ${currentButane.toFixed(1)} lbs)\n\nReason: ${notes}`);
                                });
                        });
                });
        }
        
        // Nitrogen Modals
        function openAddNitrogenModal() {
            document.getElementById('nitrogenShipmentAmount').value = '';
            document.getElementById('nitrogenShipmentNotes').value = '';
            document.getElementById('addNitrogenModal').style.display = 'block';
        }
        
        function closeAddNitrogenModal() {
            document.getElementById('addNitrogenModal').style.display = 'none';
        }
        
        function addNitrogenShipment() {
            const addAmount = parseFloat(document.getElementById('nitrogenShipmentAmount').value);
            const notes = document.getElementById('nitrogenShipmentNotes').value;
            
            if (!addAmount || addAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'nitrogen')
                .single()
                .then(({ data: nitrogenRecord, error }) => {
                    if (error) {
                        console.error('Error loading nitrogen inventory:', error);
                        return;
                    }
                    
                    const currentNitrogen = parseFloat(nitrogenRecord.current_level) || 0;
                    const newNitrogen = currentNitrogen + addAmount;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: newNitrogen,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'nitrogen')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating nitrogen:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'nitrogen',
                                    transaction_type: 'add',
                                    amount: addAmount,
                                    previous_level: currentNitrogen,
                                    new_level: newNitrogen,
                                    notes: notes || `Added ${addAmount.toFixed(1)} tank(s)`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    // Update all displays
                                    if (document.getElementById('modalNitrogenDisplay')) {
                                        document.getElementById('modalNitrogenDisplay').textContent = `${newNitrogen.toFixed(1)}`;
                                    }
                                    updateSuppliesButton();
                                    closeAddNitrogenModal();
                                    
                                    alert(`‚úÖ Tanks Added!\n\n${addAmount.toFixed(1)} nitrogen tank(s) added\nNew Total: ${newNitrogen.toFixed(1)} tanks`);
                                });
                        });
                });
        }
        
        function openEditNitrogenModal() {
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'nitrogen')
                .single()
                .then(({ data: nitrogenRecord, error }) => {
                    if (error) {
                        console.error('Error loading nitrogen inventory:', error);
                        return;
                    }
                    
                    const currentNitrogen = parseFloat(nitrogenRecord.current_level) || 0;
                    document.getElementById('editNitrogenCurrentDisplay').textContent = `${currentNitrogen.toFixed(1)} tanks`;
                    document.getElementById('nitrogenSetAmount').value = '';
                    document.getElementById('nitrogenSetNotes').value = '';
                    document.getElementById('editNitrogenModal').style.display = 'block';
                });
        }
        
        function closeEditNitrogenModal() {
            document.getElementById('editNitrogenModal').style.display = 'none';
        }
        
        function setNitrogenAmount() {
            const setAmount = parseFloat(document.getElementById('nitrogenSetAmount').value);
            const notes = document.getElementById('nitrogenSetNotes').value;
            
            if (!setAmount && setAmount !== 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!notes.trim()) {
                alert('Please provide a reason for this manual change');
                return;
            }
            
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .eq('supply_type', 'nitrogen')
                .single()
                .then(({ data: nitrogenRecord, error }) => {
                    if (error) {
                        console.error('Error loading nitrogen inventory:', error);
                        return;
                    }
                    
                    const currentNitrogen = parseFloat(nitrogenRecord.current_level) || 0;
                    
                    // Update inventory in Supabase
                    supabaseClient
                        .from('wm_inventory')
                        .update({
                            current_level: setAmount,
                            last_updated: new Date().toISOString(),
                            updated_by: currentRole ? currentRole.name : 'Unknown'
                        })
                        .eq('supply_type', 'nitrogen')
                        .then(({ error: updateError }) => {
                            if (updateError) {
                                console.error('Error updating nitrogen:', updateError);
                                return;
                            }
                            
                            // Save transaction
                            supabaseClient
                                .from('wm_inventory_transactions')
                                .insert({
                                    supply_type: 'nitrogen',
                                    transaction_type: 'edit',
                                    amount: setAmount - currentNitrogen,
                                    previous_level: currentNitrogen,
                                    new_level: setAmount,
                                    notes: `Manual adjustment: ${notes}`,
                                    timestamp: new Date().toISOString(),
                                    user_name: currentRole ? currentRole.name : 'Unknown'
                                })
                                .then(() => {
                                    // Update all displays
                                    if (document.getElementById('modalNitrogenDisplay')) {
                                        document.getElementById('modalNitrogenDisplay').textContent = `${setAmount.toFixed(1)}`;
                                    }
                                    updateSuppliesButton();
                                    closeEditNitrogenModal();
                                    
                                    alert(`‚úÖ Nitrogen Updated!\n\nManually set to ${setAmount.toFixed(1)} tanks (was ${currentNitrogen.toFixed(1)})\n\nReason: ${notes}`);
                                });
                        });
                });
        }
        
        // Company Production Summary (respects time range)
        function updateCompanyProductionSummary(timeRange = 30) {
            const now = new Date();
            const rangeStart = new Date(now.getTime() - (timeRange * 24 * 60 * 60 * 1000));
            
            // Display time range
            const periodEl = document.getElementById('companyPeriodRange');
            if (periodEl) {
                const startStr = rangeStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                periodEl.textContent = `${startStr} - ${endStr}`;
            }
            
            let trimExtracted = 0;
            let trimBatches = 0;
            let finishedWeight = 0;
            let finishedBatches = 0;
            let packaged = 0;
            let packagedWeight = 0;
            let labeled = 0;
            let labeledWeight = 0;
            
            batches.forEach(batch => {
                // Check extraction completed in range (from timeline)
                if (batch.timeline && batch.timeline.length > 0) {
                    const extractionEvent = batch.timeline.find(event => {
                        if (event.status === 'extraction' && event.timestamp) {
                            const eventDate = new Date(event.timestamp);
                            return eventDate >= rangeStart && eventDate <= now;
                        }
                        return false;
                    });
                    
                    if (extractionEvent) {
                        trimExtracted += parseFloat(batch.trim_weight) || 0;
                        trimBatches++;
                    }
                }
                
                // Check finishing completed in range
                if (batch.finishing_date) {
                    const finishingDate = new Date(batch.finishing_date);
                    if (finishingDate >= rangeStart && finishingDate <= now) {
                        finishedWeight += parseFloat(batch.final_weight) || parseFloat(batch.net_weight) || 0;
                        finishedBatches++;
                    }
                }
                
                // Check packaging done in range
                if (batch.packaging_date) {
                    const packagingDate = new Date(batch.packaging_date);
                    if (packagingDate >= rangeStart && packagingDate <= now && batch.units_packaged) {
                        packaged += parseInt(batch.units_packaged) || 0;
                        packagedWeight += parseFloat(batch.net_weight) || 0;
                    }
                }
                
                // Check labeling done in range (from timeline)
                if (batch.timeline && batch.timeline.length > 0) {
                    const labelingEvent = batch.timeline.find(event => {
                        if ((event.stage === 'labeling' || event.status === 'complete') && event.timestamp) {
                            const eventDate = new Date(event.timestamp);
                            if (eventDate >= rangeStart && eventDate <= now) {
                                const action = (event.action || event.note || '').toLowerCase();
                                return action.includes('label') || action.includes('complet');
                            }
                        }
                        return false;
                    });
                    
                    if (labelingEvent && batch.units_packaged) {
                        labeled += parseInt(batch.units_packaged) || 0;
                        labeledWeight += parseFloat(batch.grams_labeled) || 0;
                    }
                }
            });
            
            // Update displays
            document.getElementById('companyTrimExtracted').textContent = `${trimExtracted.toLocaleString()}g`;
            document.getElementById('companyTrimBatches').textContent = `${trimBatches} batch${trimBatches !== 1 ? 'es' : ''}`;
            
            document.getElementById('companyFinished').textContent = `${finishedWeight.toLocaleString()}g`;
            document.getElementById('companyFinishedBatches').textContent = `${finishedBatches} batch${finishedBatches !== 1 ? 'es' : ''}`;
            
            document.getElementById('companyPackaged').textContent = packaged.toLocaleString();
            document.getElementById('companyPackagedWeight').textContent = `${packagedWeight.toLocaleString()}g total`;
            
            document.getElementById('companyLabeled').textContent = labeled.toLocaleString();
            document.getElementById('companyLabeledWeight').textContent = `${labeledWeight.toLocaleString()}g total`;
        }
        
        // Today's Production Summary
        function updateTodayProduction() {
            // Use local Colorado time instead of UTC
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            const today = localDate.toISOString().split('T')[0]; // YYYY-MM-DD format in local time
            
            // Display today's date
            const dateEl = document.getElementById('todayDate');
            if (dateEl) {
                dateEl.textContent = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            let trimExtracted = 0;
            let trimBatches = 0;
            let finishedWeight = 0;
            let finishedBatches = 0;
            let packaged = 0;
            let packagedWeight = 0;
            let labeled = 0;
            let labeledWeight = 0;
            
            batches.forEach(batch => {
                // Check extraction completed today (from timeline)
                if (batch.timeline && batch.timeline.length > 0) {
                    const extractionEvent = batch.timeline.find(event => {
                        if (event.status === 'extraction' && event.timestamp) {
                            const eventTime = new Date(event.timestamp);
                            const localEventDate = new Date(eventTime.getTime() - (eventTime.getTimezoneOffset() * 60000));
                            const eventDate = localEventDate.toISOString().split('T')[0];
                            return eventDate === today;
                        }
                        return false;
                    });
                    
                    if (extractionEvent) {
                        trimExtracted += parseFloat(batch.trim_weight) || 0;
                        trimBatches++;
                    }
                }
                
                // Check finishing completed today
                if (batch.finishing_date) {
                    const finishTime = new Date(batch.finishing_date);
                    const localFinishDate = new Date(finishTime.getTime() - (finishTime.getTimezoneOffset() * 60000));
                    const finishingDate = localFinishDate.toISOString().split('T')[0];
                    if (finishingDate === today) {
                        finishedWeight += parseFloat(batch.final_weight) || parseFloat(batch.net_weight) || 0;
                        finishedBatches++;
                    }
                }
                
                // Check packaging done today
                if (batch.packaging_date) {
                    const packTime = new Date(batch.packaging_date);
                    const localPackDate = new Date(packTime.getTime() - (packTime.getTimezoneOffset() * 60000));
                    const packagingDate = localPackDate.toISOString().split('T')[0];
                    if (packagingDate === today && batch.units_packaged) {
                        packaged += parseInt(batch.units_packaged) || 0;
                        packagedWeight += parseFloat(batch.net_weight) || 0;
                    }
                }
                
                // Check labeling done today (from timeline)
                if (batch.timeline && batch.timeline.length > 0) {
                    const labelingEvent = batch.timeline.find(event => {
                        if ((event.stage === 'labeling' || event.status === 'complete') && event.timestamp) {
                            const eventTime = new Date(event.timestamp);
                            const localEventDate = new Date(eventTime.getTime() - (eventTime.getTimezoneOffset() * 60000));
                            const eventDate = localEventDate.toISOString().split('T')[0];
                            if (eventDate === today) {
                                const action = (event.action || event.note || '').toLowerCase();
                                return action.includes('label') || action.includes('complet');
                            }
                        }
                        return false;
                    });
                    
                    if (labelingEvent && batch.units_packaged) {
                        labeled += parseInt(batch.units_packaged) || 0;
                        labeledWeight += parseFloat(batch.grams_labeled) || 0;
                    }
                }
            });
            
            // Update displays
            document.getElementById('todayTrimExtracted').textContent = `${trimExtracted.toFixed(0)}g`;
            document.getElementById('todayTrimBatches').textContent = `${trimBatches} batch${trimBatches !== 1 ? 'es' : ''}`;
            
            document.getElementById('todayFinished').textContent = `${finishedWeight.toFixed(0)}g`;
            document.getElementById('todayFinishedBatches').textContent = `${finishedBatches} batch${finishedBatches !== 1 ? 'es' : ''}`;
            
            document.getElementById('todayPackaged').textContent = packaged.toLocaleString();
            document.getElementById('todayPackagedWeight').textContent = `${packagedWeight.toFixed(0)}g total`;
            
            document.getElementById('todayLabeled').textContent = labeled.toLocaleString();
            document.getElementById('todayLabeledWeight').textContent = `${labeledWeight.toFixed(0)}g total`;
        }
        
        // Login Activity Tracker
        function updateLoginTracker() {
            const now = new Date();
            const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            const thirtyMinutesAgo = new Date(now.getTime() - (30 * 60 * 1000));
            
            // Get recent logins (last 24 hours)
            supabaseClient
                .from('wm_login_history')
                .select('*')
                .gte('login_time', twentyFourHoursAgo.toISOString())
                .order('login_time', { ascending: false })
                .limit(10)
                .then(({ data: logins, error }) => {
                    if (error) {
                        console.error('Error loading login history:', error);
                        return;
                    }
                    
                    // Find currently active users (logged in within 30 min and no logout)
                    const activeUsers = logins.filter(login => {
                        const loginTime = new Date(login.login_time);
                        return loginTime >= thirtyMinutesAgo && !login.logout_time;
                    });
                    
                    // Display active users
                    const activeUsersEl = document.getElementById('activeUsers');
                    if (activeUsers.length === 0) {
                        activeUsersEl.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No active users</div>';
                    } else {
                        const uniqueUsers = [...new Set(activeUsers.map(u => u.user_name))];
                        activeUsersEl.innerHTML = uniqueUsers.map(name => {
                            const userLogin = activeUsers.find(u => u.user_name === name);
                            const loginTime = new Date(userLogin.login_time);
                            const minutesAgo = Math.floor((now - loginTime) / 1000 / 60);
                            const timeText = minutesAgo < 1 ? 'just now' : `${minutesAgo}m ago`;
                            return `<div style="padding: 5px 0; border-bottom: 1px solid var(--border);">
                                <strong>${name}</strong> <span style="color: var(--text-secondary); font-size: 0.85rem;">(${timeText})</span>
                            </div>`;
                        }).join('');
                    }
                    
                    // Display recent logins
                    const recentLoginsEl = document.getElementById('recentLogins');
                    if (logins.length === 0) {
                        recentLoginsEl.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No recent logins</div>';
                    } else {
                        recentLoginsEl.innerHTML = logins.map(login => {
                            const loginTime = new Date(login.login_time);
                            const timeStr = loginTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                            const dateStr = loginTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            
                            let sessionInfo = '';
                            if (login.logout_time) {
                                const duration = login.session_duration;
                                const hours = Math.floor(duration / 60);
                                const mins = duration % 60;
                                const durationStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                                sessionInfo = `<span style="color: var(--text-secondary);">(${durationStr})</span>`;
                            } else {
                                sessionInfo = '<span style="color: var(--accent-green);">‚óè</span>';
                            }
                            
                            return `<div style="padding: 5px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                                <div><strong>${login.user_name}</strong></div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${dateStr} ${timeStr} ${sessionInfo}</div>
                            </div>`;
                        }).join('');
                    }
                });
        }
        
        // Update button display on extraction page
        function updateSuppliesButton() {
            supabaseClient
                .from('wm_inventory')
                .select('*')
                .then(({ data: inventory, error }) => {
                    if (error) {
                        console.error('Error loading inventory:', error);
                        return;
                    }
                    
                    const butane = inventory.find(i => i.supply_type === 'butane');
                    const nitrogen = inventory.find(i => i.supply_type === 'nitrogen');
                    
                    const btnButane = document.getElementById('btnButaneDisplay');
                    const btnNitrogen = document.getElementById('btnNitrogenDisplay');
                    
                    if (btnButane && butane) {
                        btnButane.textContent = `${parseFloat(butane.current_level).toFixed(1)} lbs`;
                    }
                    
                    if (btnNitrogen && nitrogen) {
                        btnNitrogen.textContent = `${parseFloat(nitrogen.current_level).toFixed(1)} tanks`;
                    }
                });
        }
        
        // Helper function to save transactions
        function saveTransaction(type, action, previousAmount, newAmount, withdraw, add, notes) {
            const transactionKey = type === 'butane' ? 'wm_gas_transactions' : 'wm_nitrogen_transactions';
            const transactions = JSON.parse(localStorage.getItem(transactionKey) || '[]');
            
            transactions.push({
                timestamp: new Date().toISOString(),
                user: currentRole ? currentRole.name : 'Unknown',
                action: action,
                previousAmount: previousAmount,
                newAmount: newAmount,
                withdraw: withdraw,
                add: add,
                notes: notes
            });
            
            localStorage.setItem(transactionKey, JSON.stringify(transactions));
        }
        
        
        // Old functions - redirect to new ones
        function openGasModal() {
            // No longer used - interface is now inline
        }
        
        function closeGasModal() {
            // No longer used
        }
        
        // Inventory Management Functions (Redirect to gas modal)
        function openInventoryModal() {
            openGasModal();
        }
        
        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
        }
        
        function displayPersonalRecords(userName) {
            // Find best days
            const dailyStats = {};
            
            batches.forEach(batch => {
                // PACKAGING: Use packaging_user and packaging_date
                if (batch.packaging_user === userName && batch.packaging_date && batch.units_packaged) {
                    const date = batch.packaging_date;
                    if (!dailyStats[date]) {
                        dailyStats[date] = { packaged: 0, labeled: 0, extracted: 0 };
                    }
                    dailyStats[date].packaged += parseInt(batch.units_packaged) || 0;
                }
                
                // EXTRACTION: Use extraction_user and look for extraction timeline entry
                if (batch.extraction_user === userName && batch.trim_weight && batch.timeline) {
                    const extractionEvent = batch.timeline.find(e => 
                        e.stage === 'extraction' && e.user === userName
                    );
                    if (extractionEvent) {
                        const eventDate = new Date(extractionEvent.timestamp || extractionEvent.date);
                        const date = eventDate.toISOString().split('T')[0];
                        if (!dailyStats[date]) {
                            dailyStats[date] = { packaged: 0, labeled: 0, extracted: 0 };
                        }
                        dailyStats[date].extracted += parseFloat(batch.trim_weight) || 0;
                    }
                }
                
                // LABELING: Check timeline
                (batch.timeline || []).forEach(entry => {
                    if (!entry.date && !entry.timestamp) return;
                    if (!entry.user || entry.user !== userName) return;
                    if (!entry.action) return;
                    
                    const eventDate = new Date(entry.timestamp || entry.date);
                    const date = eventDate.toISOString().split('T')[0];
                    
                    if (!dailyStats[date]) {
                        dailyStats[date] = { packaged: 0, labeled: 0, extracted: 0 };
                    }
                    
                    const actionLower = entry.action.toLowerCase();
                    
                    if (entry.stage === 'labeling' && (actionLower.includes('labeled') || actionLower.includes('completed'))) {
                        dailyStats[date].labeled += parseInt(batch.units_packaged) || 0;
                    }
                });
            });
            
            // Find best records
            let bestPackaging = { date: '', units: 0 };
            let bestLabeling = { date: '', units: 0 };
            let bestExtraction = { date: '', grams: 0 };
            
            Object.entries(dailyStats).forEach(([date, stats]) => {
                if (stats.packaged > bestPackaging.units) {
                    bestPackaging = { date, units: stats.packaged };
                }
                if (stats.labeled > bestLabeling.units) {
                    bestLabeling = { date, units: stats.labeled };
                }
                if (stats.extracted > bestExtraction.grams) {
                    bestExtraction = { date, grams: stats.extracted };
                }
            });
            
            // Convert extraction grams to pounds if appropriate
            const extractedDisplay = bestExtraction.grams >= 454 
                ? `${(bestExtraction.grams / 453.592).toFixed(1)} lbs`
                : `${bestExtraction.grams.toFixed(0)}g`;
            
            const content = `
                ${bestPackaging.units > 0 ? `
                <div class="record-box">
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green); margin-bottom: 5px;">
                        ${bestPackaging.units} units
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        üì¶ Best Packaging Day
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">
                        ${new Date(bestPackaging.date).toLocaleDateString()}
                    </div>
                </div>
                ` : ''}
                
                ${bestLabeling.units > 0 ? `
                <div class="record-box" style="border-left-color: var(--accent-blue);">
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 5px;">
                        ${bestLabeling.units} units
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        üè∑Ô∏è Best Labeling Day
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">
                        ${new Date(bestLabeling.date).toLocaleDateString()}
                    </div>
                </div>
                ` : ''}
                
                ${bestExtraction.grams > 0 ? `
                <div class="record-box" style="border-left-color: var(--accent-purple);">
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 5px;">
                        ${extractedDisplay}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        ‚öóÔ∏è Best Extraction Day
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">
                        ${new Date(bestExtraction.date).toLocaleDateString()}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('personalRecordsContent').innerHTML = content || '<p style="text-align: center; color: var(--text-secondary);">No records yet - start tracking your work!</p>';
        }

        // Feature #2: Personal Dashboard Quick Stats
        // Feature #2: Personal Dashboard Quick Stats (Workload Summary)
        function updatePersonalWorkloadStats() {
            const statsGrid = document.getElementById('personalStatsGrid');
            const statsTitle = document.getElementById('personalStatsTitle');
            
            if (!currentRole) {
                statsGrid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1;">Login to see your personal workload</p>';
                statsTitle.textContent = 'Your Workload';
                return;
            }
            
            statsTitle.textContent = `${currentRole.name}'s Workload`;
            
            // Count batches at each stage
            const waitingExtraction = batches.filter(b => b.status === 'intake').length;
            const waitingFinishing = batches.filter(b => b.status === 'extraction').length;
            const waitingPackaging = batches.filter(b => b.status === 'finishing').length;
            const waitingTesting = batches.filter(b => b.status === 'packaging' || (b.status === 'complete' && !b.test_thc_percent)).length;
            const waitingLabeling = batches.filter(b => b.status === 'complete' && b.test_thc_percent && !b.labels_applied).length;
            const paused = batches.filter(b => b.extraction_paused || b.packaging_paused || b.labeling_paused).length;
            
            const stats = [
                { label: 'Waiting Extraction', count: waitingExtraction, icon: '‚öóÔ∏è', color: 'var(--accent-orange)' },
                { label: 'Waiting Post-Extraction', count: waitingFinishing, icon: '‚ú®', color: 'var(--accent-purple)' },
                { label: 'Waiting Packaging', count: waitingPackaging, icon: 'üì¶', color: 'var(--accent-blue)' },
                { label: 'Waiting Testing', count: waitingTesting, icon: 'üß™', color: 'var(--accent-green)' },
                { label: 'Ready to Label', count: waitingLabeling, icon: 'üè∑Ô∏è', color: 'var(--accent-purple)' },
                { label: 'Paused (Need Attention)', count: paused, icon: '‚è∏Ô∏è', color: '#ff9800' }
            ];
            
            statsGrid.innerHTML = stats.map(s => `
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border-left: 4px solid ${s.color};">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">${s.icon} ${s.label}</div>
                    <div style="font-size: 2rem; font-weight: 700; color: ${s.count > 0 ? s.color : 'var(--text-secondary)'};">${s.count}</div>
                </div>
            `).join('');
        }

        // Feature #1: Enhanced Batch Search with Filtering
        function addDropdownSearchFilters() {
            // Add search to extraction dropdown
            addSearchToDropdown('extractionBatchSelect', 'extraction');
            // Add search to packaging dropdown
            addSearchToDropdown('packagingBatchSelect', 'packaging');
            // Add search to finishing dropdown
            addSearchToDropdown('finishingBatchSelect', 'finishing');
            // Add search to labeling dropdown
            addSearchToDropdown('labelingBatchSelect', 'labeling');
        }

        function addSearchToDropdown(selectId, stage) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Create search input
            const searchWrapper = document.createElement('div');
            searchWrapper.style.cssText = 'position: relative; margin-bottom: 10px;';
            
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'üîç Search batch ID or strain...';
            searchInput.style.cssText = 'width: 100%; padding: 10px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;';
            
            // Insert before dropdown
            select.parentNode.insertBefore(searchWrapper, select);
            searchWrapper.appendChild(searchInput);
            
            // Filter dropdown on search
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const options = select.querySelectorAll('option');
                
                options.forEach(opt => {
                    if (opt.value === '') {
                        opt.style.display = '';
                        return;
                    }
                    
                    const text = opt.textContent.toLowerCase();
                    opt.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Feature #3: Batch Timeline Visual Progress Viewer
        function showBatchTimeline(batchId) {
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;
            
            const stages = [
                { name: 'Intake', status: 'intake', icon: 'üì•', completed: batch.intake_date },
                { name: 'Extraction', status: 'extraction', icon: '‚öóÔ∏è', completed: batch.extraction_user, paused: batch.extraction_paused },
                { name: 'Post-Extraction', status: 'finishing', icon: '‚ú®', completed: batch.finishing_user },
                { name: 'Packaging', status: 'packaging', icon: 'üì¶', completed: batch.packaging_user, paused: batch.packaging_paused },
                { name: 'Testing', status: 'testing', icon: 'üß™', completed: batch.test_thc_percent },
                { name: 'Labeling', status: 'complete', icon: 'üè∑Ô∏è', completed: batch.labels_applied, paused: batch.labeling_paused }
            ];
            
            let currentStageIndex = stages.findIndex(s => s.status === batch.status);
            if (currentStageIndex === -1) currentStageIndex = stages.length - 1;
            
            return stages.map((stage, index) => {
                let statusIcon, statusColor, statusText;
                
                if (index < currentStageIndex) {
                    statusIcon = '‚úÖ';
                    statusColor = 'var(--accent-green)';
                    statusText = 'Complete';
                } else if (index === currentStageIndex) {
                    if (stage.paused) {
                        statusIcon = '‚è∏Ô∏è';
                        statusColor = '#ff9800';
                        statusText = 'Paused';
                    } else {
                        statusIcon = 'üîÑ';
                        statusColor = 'var(--accent-blue)';
                        statusText = 'In Progress';
                    }
                } else {
                    statusIcon = '‚è≥';
                    statusColor = 'var(--text-secondary)';
                    statusText = 'Waiting';
                }
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: ${index === currentStageIndex ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; border-radius: 6px;">
                        <div style="font-size: 1.5rem;">${stage.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${stage.name}</div>
                            <div style="font-size: 0.85rem; color: ${statusColor};">${statusIcon} ${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('<div style="width: 2px; height: 15px; background: var(--border); margin-left: 23px;"></div>');
        }

        // Feature #4: Auto-Calculate Yield Percentage with Alerts
        function calculateYield(batch) {
            if (!batch.trim_weight) return null;
            
            // Prioritize grams_labeled (actual sellable weight after labeling) over final_weight (post-extraction)
            const finalWeight = batch.grams_labeled ? parseFloat(batch.grams_labeled) : 
                                batch.final_weight ? parseFloat(batch.final_weight) : null;
            
            if (!finalWeight) return null;
            
            const trimWeight = parseFloat(batch.trim_weight);
            
            if (trimWeight === 0) return null;
            
            const yieldPercent = (finalWeight / trimWeight) * 100;
            const expectedYield = 18; // Industry standard for BHO
            const variance = yieldPercent - expectedYield;
            
            return {
                actual: yieldPercent,
                expected: expectedYield,
                variance: variance,
                status: variance < -3 ? 'low' : (variance > 3 ? 'high' : 'normal')
            };
        }

        function displayYieldAlert(batch, yieldData) {
            if (!yieldData) return '';
            
            let alertHTML = '';
            let statusIcon, statusColor, statusText;
            
            if (yieldData.status === 'low') {
                statusIcon = '‚ö†Ô∏è';
                statusColor = '#f44336';
                statusText = 'Low Yield Alert';
            } else if (yieldData.status === 'high') {
                statusIcon = 'üéâ';
                statusColor = 'var(--accent-green)';
                statusText = 'Excellent Yield';
            } else {
                statusIcon = '‚úÖ';
                statusColor = 'var(--accent-blue)';
                statusText = 'Normal Yield';
            }
            
            return `
                <div style="background: rgba(${statusColor === '#f44336' ? '244, 67, 54' : '59, 130, 246'}, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid ${statusColor}; margin-top: 10px;">
                    <div style="font-weight: 600; color: ${statusColor}; margin-bottom: 5px;">${statusIcon} ${statusText}</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        Actual: ${yieldData.actual.toFixed(1)}% | Expected: ${yieldData.expected}% | Variance: ${yieldData.variance > 0 ? '+' : ''}${yieldData.variance.toFixed(1)}%
                    </div>
                </div>
            `;
        }

        // Feature #8: End-of-Day Report Generator
        function generateDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            
            // Filter batches with activity today
            const todaysBatches = batches.filter(b => {
                const timeline = b.timeline || [];
                return timeline.some(t => t.date && t.date.startsWith(today));
            });
            
            // Count by stage
            const extracted = todaysBatches.filter(b => 
                (b.timeline || []).some(t => t.stage === 'extraction' && t.date.startsWith(today))
            ).length;
            
            const packaged = todaysBatches.filter(b => 
                (b.timeline || []).some(t => t.stage === 'packaging' && t.date.startsWith(today) && t.action.includes('ompleted'))
            ).length;
            
            const labeled = todaysBatches.filter(b => 
                (b.timeline || []).some(t => t.stage === 'labeling' && t.date.startsWith(today))
            ).length;
            
            // Employee performance
            const employeeActivity = {};
            todaysBatches.forEach(b => {
                (b.timeline || []).forEach(t => {
                    if (!t.date || !t.date.startsWith(today)) return;
                    if (!employeeActivity[t.user]) {
                        employeeActivity[t.user] = { extracted: 0, packaged: 0, labeled: 0 };
                    }
                    if (t.stage === 'extraction') employeeActivity[t.user].extracted++;
                    if (t.stage === 'packaging' && t.action.includes('ompleted')) employeeActivity[t.user].packaged++;
                    if (t.stage === 'labeling') employeeActivity[t.user].labeled++;
                });
            });
            
            return {
                date: today,
                batches: todaysBatches.length,
                extracted,
                packaged,
                labeled,
                employees: employeeActivity
            };
        }

        // Recalculate trim weight allocations for all existing sub-batches
        async function recalculateAllSubBatchYields() {
            if (!confirm('This will recalculate trim weight allocations for all sub-batches based on actual yields.\n\nThis affects yield calculations in the dashboard and analytics.\n\nContinue?')) {
                return;
            }
            
            // Find all parent batches that have been split
            const parentBatches = batches.filter(b => b.status === 'split');
            
            if (parentBatches.length === 0) {
                alert('No split batches found. Nothing to recalculate.');
                return;
            }
            
            let updatedCount = 0;
            let errorCount = 0;
            const updates = [];
            
            for (const parent of parentBatches) {
                // Find all sub-batches for this parent
                const subBatches = batches.filter(b => b.parent_batch_id === parent.id && b.is_sub_batch);
                
                if (subBatches.length === 0) continue;
                
                // Calculate total final weight across all sub-batches
                // Prioritize grams_labeled (actual sellable) over final_weight (post-extraction)
                const totalFinalWeight = subBatches.reduce((sum, sub) => {
                    const weight = sub.grams_labeled ? parseFloat(sub.grams_labeled) : parseFloat(sub.final_weight) || 0;
                    return sum + weight;
                }, 0);
                
                if (totalFinalWeight === 0) continue;
                
                // Calculate overall yield from parent trim to total sub-batch output
                const parentTrimWeight = parseFloat(parent.trim_weight) || 0;
                if (parentTrimWeight === 0) continue;
                
                const overallYieldPercent = (totalFinalWeight / parentTrimWeight) * 100;
                
                // Update each sub-batch with proportional trim weight
                for (const subBatch of subBatches) {
                    // Use grams_labeled if available, otherwise final_weight
                    const subFinalWeight = subBatch.grams_labeled ? parseFloat(subBatch.grams_labeled) : parseFloat(subBatch.final_weight) || 0;
                    if (subFinalWeight === 0) continue;
                    
                    // Back-calculate trim weight: if yield is 18% and final is 50g, trim = 50/0.18 = 277.8g
                    const newTrimWeight = overallYieldPercent > 0 
                        ? (subFinalWeight / overallYieldPercent) * 100
                        : 0;
                    
                    // Only update if different
                    if (Math.abs(newTrimWeight - (parseFloat(subBatch.trim_weight) || 0)) > 0.1) {
                        updates.push({
                            id: subBatch.id,
                            oldTrim: parseFloat(subBatch.trim_weight) || 0,
                            newTrim: newTrimWeight,
                            finalWeight: subFinalWeight,
                            yieldPercent: overallYieldPercent,
                            usedLabeledWeight: !!subBatch.grams_labeled
                        });
                        
                        // Update in database
                        const { error } = await supabaseClient
                            .from('wm_batches')
                            .update({
                                trim_weight: newTrimWeight,
                                intake_notes: (subBatch.intake_notes || '') + `\n[Yield recalculated: ${newTrimWeight.toFixed(1)}g trim for ${subFinalWeight.toFixed(1)}g ${subBatch.grams_labeled ? 'labeled' : 'bulk'} weight at ${overallYieldPercent.toFixed(2)}%]`
                            })
                            .eq('id', subBatch.id);
                        
                        if (error) {
                            console.error(`Error updating ${subBatch.id}:`, error);
                            errorCount++;
                        } else {
                            updatedCount++;
                        }
                    }
                }
            }
            
            if (updates.length === 0) {
                alert('All sub-batches already have correct trim allocations. Nothing to update.');
                return;
            }
            
            // Reload batches to reflect changes
            await loadBatches();
            
            // Show detailed report
            const reportDetails = updates.map(u => 
                `${u.id}: ${u.oldTrim.toFixed(1)}g ‚Üí ${u.newTrim.toFixed(1)}g trim (${u.finalWeight.toFixed(1)}g @ ${u.yieldPercent.toFixed(2)}%)`
            ).join('\n');
            
            alert(`‚úÖ Sub-Batch Yield Recalculation Complete!\n\nUpdated: ${updatedCount} batches\nErrors: ${errorCount}\n\nDetails:\n${reportDetails.substring(0, 500)}${reportDetails.length > 500 ? '\n...(truncated)' : ''}`);
        }

        function showDailyReportPopup() {
            const report = generateDailyReport();
            
            let employeeReport = Object.entries(report.employees).map(([name, stats]) => 
                `${name}: ${stats.extracted} extracted, ${stats.packaged} packaged, ${stats.labeled} labeled`
            ).join('\n');
            
            alert(`üìä Daily Production Report
            
Date: ${report.date}

Summary:
‚Ä¢ ${report.batches} batches with activity today
‚Ä¢ ${report.extracted} batches extracted
‚Ä¢ ${report.packaged} batches packaged  
‚Ä¢ ${report.labeled} batches labeled

Employee Activity:
${employeeReport || 'No activity recorded today'}
            `);
        }


        function renderBatches(filter = 'all', searchTerm = '') {
            const container = document.getElementById('batchesList');
            let filteredBatches = batches;
            
            if (filter !== 'all') {
                if (filter === 'extraction') {
                    // Show batches waiting for extraction (at intake status)
                    filteredBatches = batches.filter(b => b.status === 'intake');
                } else if (filter === 'finishing') {
                    // Show batches waiting for post-extraction (at extraction status)
                    filteredBatches = batches.filter(b => b.status === 'extraction');
                } else if (filter === 'packaging') {
                    // Show batches waiting for packaging (at finishing status)
                    filteredBatches = batches.filter(b => b.status === 'finishing');
                } else if (filter === 'testing') {
                    // Show batches waiting for testing (at packaging status or complete without test results)
                    filteredBatches = batches.filter(b => 
                        b.status === 'packaging' || 
                        (b.status === 'complete' && !b.test_thc_percent)
                    );
                } else if (filter === 'labeling') {
                    // Show batches waiting for labeling (complete with test results but not labeled)
                    filteredBatches = batches.filter(b => 
                        b.status === 'complete' && 
                        b.test_thc_percent && 
                        !b.labels_applied
                    );
                } else if (filter === 'complete') {
                    // Show fully completed batches
                    filteredBatches = batches.filter(b => 
                        b.status === 'complete' && 
                        b.labels_applied
                    );
                } else if (filter === 'intake') {
                    // Show just intake (newly created batches)
                    filteredBatches = batches.filter(b => b.status === 'intake');
                } else {
                    // Fallback to status filter
                    filteredBatches = batches.filter(b => b.status === filter);
                }
            }
            
            if (searchTerm) {
                filteredBatches = filteredBatches.filter(b => 
                    b.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    b.strain.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            container.innerHTML = filteredBatches.map(batch => `
                <div class="batch-item">
                    <div class="batch-header" onclick="toggleBatchTimeline('${batch.id}')" style="cursor: pointer;">
                        <div class="batch-id">${batch.id}</div>
                        <div class="batch-status status-${batch.status}">${batch.status.toUpperCase()}</div>
                        <div style="margin-left: auto; color: var(--accent-blue); font-size: 0.9rem; font-weight: 600;">
                            <span id="timeline-toggle-${batch.id}">Show History ‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="batch-details">
                        ${batch.is_sub_batch ? `
                            <div class="batch-detail" style="background: rgba(147, 51, 234, 0.1); border-left: 3px solid var(--accent-purple); padding: 8px; border-radius: 4px; grid-column: 1/-1;">
                                <div class="batch-detail-label">üîó Sub-Batch Of</div>
                                <div class="batch-detail-value">${batch.parent_batch_id}</div>
                            </div>
                        ` : ''}
                        <div class="batch-detail">
                            <div class="batch-detail-label">Product</div>
                            <div class="batch-detail-value">${batch.strain} (${batch.strain_type})</div>
                        </div>
                        <div class="batch-detail">
                            <div class="batch-detail-label">Trim Weight</div>
                            <div class="batch-detail-value">${batch.trim_weight}g${batch.is_sub_batch ? ' (allocated)' : ''}</div>
                        </div>
                        ${batch.grams_labeled ? `
                            <div class="batch-detail">
                                <div class="batch-detail-label">Labeled Weight</div>
                                <div class="batch-detail-value">${batch.grams_labeled}g (sellable)</div>
                            </div>
                            ${batch.net_weight ? `
                                <div class="batch-detail" style="grid-column: 1/-1;">
                                    <div class="batch-detail-label">Bulk Weight (Pre-Label)</div>
                                    <div class="batch-detail-value">${batch.net_weight}g</div>
                                </div>
                            ` : ''}
                        ` : batch.final_weight ? `
                            <div class="batch-detail">
                                <div class="batch-detail-label">Post-Extraction Weight</div>
                                <div class="batch-detail-value">${batch.final_weight}g${batch.net_weight ? ` (${batch.net_weight}g net)` : ''}</div>
                            </div>
                        ` : ''}
                        ${(() => {
                            // Calculate weight discrepancy between bulk and labeled weight
                            if (batch.grams_labeled && batch.net_weight) {
                                const labeled = parseFloat(batch.grams_labeled);
                                const bulk = parseFloat(batch.net_weight);
                                const discrepancy = bulk - labeled;
                                const discrepancyPercent = (discrepancy / bulk) * 100;
                                
                                // Show alert if discrepancy is > 5% or > 5g
                                if (Math.abs(discrepancyPercent) > 5 || Math.abs(discrepancy) > 5) {
                                    const isHigh = discrepancyPercent > 0;
                                    const icon = isHigh ? '‚ö†Ô∏è' : '‚úÖ';
                                    const color = isHigh ? 'var(--accent-orange)' : 'var(--accent-green)';
                                    const bgColor = isHigh ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)';
                                    
                                    return `
                                        <div style="grid-column: 1/-1; background: ${bgColor}; padding: 10px; border-radius: 8px; border-left: 4px solid ${color}; margin-top: 5px;">
                                            <div style="font-weight: 600; color: ${color}; font-size: 0.9rem; margin-bottom: 3px;">
                                                ${icon} Weight Discrepancy
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                Lost: ${discrepancy.toFixed(1)}g (${discrepancyPercent.toFixed(1)}%) between bulk and labeled
                                            </div>
                                            ${batch.weight_discrepancy !== undefined ? `
                                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 3px; font-style: italic;">
                                                    Note: ${batch.discrepancy_accepted ? 'Discrepancy noted and accepted' : 'Discrepancy recorded'}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }
                            }
                            return '';
                        })()}
                        ${batch.units_packaged ? `
                            <div class="batch-detail">
                                <div class="batch-detail-label">Units Packaged</div>
                                <div class="batch-detail-value">${batch.units_packaged} units${batch.packaging_breakdown ? ` (${batch.packaging_breakdown})` : ''}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${(() => {
                        const yieldData = calculateYield(batch);
                        return yieldData ? displayYieldAlert(batch, yieldData) : '';
                    })()}
                    
                    <div class="timeline" id="timeline-${batch.id}" style="display: none;">
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin-bottom: 10px; color: var(--accent-purple);">üìä Progress Timeline</h4>
                            ${showBatchTimeline(batch.id)}
                        </div>
                        
                        <h4 style="margin-bottom: 10px; color: var(--accent-blue);">üìù Activity History</h4>
                        ${(batch.timeline || []).map(t => `
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div><span class="timeline-user">${t.user}</span> - ${t.action}</div>
                                    <div class="timeline-date">${new Date(t.date).toLocaleString()}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${currentRole && (currentRole.name === 'Ryan (Admin)' || currentRole.name === 'Alex') ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            ${batch.is_sub_batch ? `
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" style="background: var(--accent-orange); flex: 1;" onclick="openEditBatch('${batch.id}')">‚úèÔ∏è Edit Batch</button>
                                    <button class="btn" style="background: var(--accent-red); flex: 1;" onclick="deleteSubBatch('${batch.id}')">üóëÔ∏è Delete Sub-Batch</button>
                                </div>
                            ` : `
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" style="background: var(--accent-orange); flex: 1;" onclick="openEditBatch('${batch.id}')">‚úèÔ∏è Edit Batch</button>
                                    <button class="btn" style="background: var(--accent-green); flex: 1;" onclick="openCreateSubBatch('${batch.id}')">‚ûï Create Sub-Batch</button>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                const searchTerm = document.getElementById('searchBatches').value;
                renderBatches(filter, searchTerm);
            });
        });

        // Search
        document.getElementById('searchBatches').addEventListener('input', function() {
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            renderBatches(activeFilter, this.value);
        });

        // Toggle batch timeline visibility
        function toggleBatchTimeline(batchId) {
            const timeline = document.getElementById(`timeline-${batchId}`);
            const toggle = document.getElementById(`timeline-toggle-${batchId}`);
            
            if (timeline.style.display === 'none') {
                timeline.style.display = 'block';
                toggle.textContent = 'Hide History ‚ñ≤';
            } else {
                timeline.style.display = 'none';
                toggle.textContent = 'Show History ‚ñº';
            }
        }

        function initializeApp() {
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = new Date().toISOString().split('T')[0];
                }
            });
            
            document.getElementById('batchId').value = `WM-${batchCounter}`;
            
            // Add pre-sift change handler to highlight hash products
            const preSiftSelect = document.getElementById('preSift');
            if (preSiftSelect) {
                preSiftSelect.addEventListener('change', function() {
                    const brickHashLabel = document.getElementById('brickHash')?.parentElement;
                    const hashHitsLabel = document.getElementById('hashHits')?.parentElement;
                    
                    if (this.value === 'yes') {
                        // Highlight hash products as required
                        if (brickHashLabel) {
                            brickHashLabel.style.background = 'rgba(245, 158, 11, 0.2)';
                            brickHashLabel.style.border = '2px solid var(--accent-orange)';
                            brickHashLabel.style.borderRadius = '8px';
                            brickHashLabel.style.padding = '8px';
                        }
                        if (hashHitsLabel) {
                            hashHitsLabel.style.background = 'rgba(245, 158, 11, 0.2)';
                            hashHitsLabel.style.border = '2px solid var(--accent-orange)';
                            hashHitsLabel.style.borderRadius = '8px';
                            hashHitsLabel.style.padding = '8px';
                        }
                    } else {
                        // Remove highlighting
                        if (brickHashLabel) {
                            brickHashLabel.style.background = '';
                            brickHashLabel.style.border = '';
                            brickHashLabel.style.padding = '';
                        }
                        if (hashHitsLabel) {
                            hashHitsLabel.style.background = '';
                            hashHitsLabel.style.border = '';
                            hashHitsLabel.style.padding = '';
                        }
                    }
                });
            }
        }

        // Testing functions
        function populateTestingSelect() {
            const select = document.getElementById('testingBatchSelect');
            // Show batches that are finishing or complete, but NOT yet labeled
            const testableBatches = batches.filter(b => 
                (b.status === 'finishing' || b.status === 'complete') && !b.labeling_date
            );
            
            select.innerHTML = '<option value="">Select a batch...</option>';
            testableBatches.forEach(batch => {
                const hasResults = batch.test_results_received_date ? '‚úì ' : '';
                select.innerHTML += `<option value="${batch.id}">${hasResults}${batch.id} - ${batch.strain} - ${batch.product_made}</option>`;
            });
        }

        document.getElementById('testingBatchSelect').addEventListener('change', function() {
            const form = document.getElementById('testingForm');
            form.style.display = this.value ? 'block' : 'none';
            
            if (this.value) {
                const batch = batches.find(b => b.id === this.value);
                
                // Display current batch ID
                document.getElementById('currentBatchIdDisplay').textContent = batch.id;
                
                // Calculate trim used for this batch
                let trimUsedInfo = '';
                if (batch.is_sub_batch && batch.parent_batch_id) {
                    // Sub-batch: calculate proportional trim used
                    const parentBatch = batches.find(b => b.id === batch.parent_batch_id);
                    if (parentBatch) {
                        const parentTrimWeight = parseFloat(parentBatch.adjusted_trim_weight || parentBatch.trim_weight || 0);
                        const parentTotalOutput = parseFloat(parentBatch.final_weight || parentBatch.net_weight || 0);
                        const thisBatchWeight = parseFloat(batch.final_weight || batch.net_weight || 0);
                        
                        if (parentTotalOutput > 0) {
                            const trimUsed = (thisBatchWeight / parentTotalOutput) * parentTrimWeight;
                            const yieldPercent = parentTotalOutput > 0 ? (thisBatchWeight / trimUsed) * 100 : 0;
                            trimUsedInfo = `
                                <p><strong>Trim Used (calculated):</strong> ${trimUsed.toFixed(1)}g</p>
                                <p><strong>Yield %:</strong> ${yieldPercent.toFixed(2)}%</p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">Sub-batch from ${parentBatch.id} (${parentTrimWeight.toFixed(1)}g total trim)</p>
                            `;
                        }
                    }
                } else if (batch.extraction_method === 'Dry Sift') {
                    // Sift batch: the sift weight IS the trim used
                    trimUsedInfo = `
                        <p><strong>Trim Used:</strong> ${batch.trim_weight}g (dry sift)</p>
                    `;
                } else {
                    // Regular batch or post-sift BHO
                    const trimWeight = parseFloat(batch.adjusted_trim_weight || batch.trim_weight || 0);
                    const finalWeight = parseFloat(batch.final_weight || batch.net_weight || 0);
                    const yieldPercent = trimWeight > 0 ? (finalWeight / trimWeight) * 100 : 0;
                    
                    trimUsedInfo = `
                        <p><strong>Trim Used:</strong> ${trimWeight.toFixed(1)}g${batch.adjusted_trim_weight ? ' (after sift)' : ''}</p>
                        <p><strong>Yield %:</strong> ${yieldPercent.toFixed(2)}%</p>
                    `;
                }
                
                // Show current batch info
                const details = `
                    <p><strong>Strain:</strong> ${batch.strain} (${batch.strain_type})</p>
                    <p><strong>Product:</strong> ${batch.product_made}</p>
                    <p><strong>Net Weight:</strong> ${batch.net_weight || batch.final_weight || 'N/A'}g</p>
                    ${trimUsedInfo}
                    <div style="background: rgba(245, 158, 11, 0.2); padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid var(--accent-orange);">
                        <p style="margin: 0;"><strong style="color: var(--accent-orange);">üìã METRC Tags:</strong> <span style="font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700;">${batch.metrc_tags && batch.metrc_tags.trim() !== '' ? batch.metrc_tags : 'Not entered at intake'}</span></p>
                    </div>
                    <p><strong>Cultivation License:</strong> ${batch.cultivation_license}</p>
                    <p><strong>Grower:</strong> ${batch.grower_name || 'N/A'}</p>
                    <p><strong>Status:</strong> ${batch.status}</p>
                    ${batch.test_submitted_date ? `<p><strong>Previously Submitted:</strong> ${batch.test_submitted_date}</p>` : ''}
                    ${batch.is_rta === 'yes' ? `<p style="color: var(--accent-green);"><strong>‚úì RTA Full Panel</strong></p>` : ''}
                `;
                document.getElementById('testBatchDetails').innerHTML = details;
                
                // Auto-populate product name with current strain + product type
                // User can modify if they want to rename for wholesale variety
                const defaultProductName = batch.final_product_name || `${batch.strain} ${batch.product_made}`;
                document.getElementById('finalProductName').value = defaultProductName;
                
                // Auto-populate strain type from batch, but allow redesignation
                const strainType = batch.final_strain_type || batch.strain_type;
                
                // Show Dealer's Choice alert if this batch was marked as such
                const dealersChoiceAlert = document.getElementById('dealersChoiceAlert');
                if (batch.strain_type === "Dealer's Choice") {
                    dealersChoiceAlert.style.display = 'block';
                    // Default to Hybrid for Dealer's Choice, but user can select anything
                    document.getElementById('finalStrainType').value = 'Hybrid';
                } else {
                    dealersChoiceAlert.style.display = 'none';
                    document.getElementById('finalStrainType').value = strainType;
                }
                
                // Pre-fill if test results already exist
                if (batch.test_results_received_date) {
                    document.getElementById('testSubmittedDate').value = batch.test_submitted_date || '';
                    document.getElementById('testExpirationDate').value = batch.test_expiration_date || '';
                    document.getElementById('metrcLast4').value = ''; // Clear - batch ID already set
                    document.getElementById('newBatchId').value = ''; // Always clear - this is for reassignment
                    document.getElementById('testResultsReceivedDate').value = batch.test_results_received_date;
                    document.getElementById('testThcPercent').value = batch.test_thc_percent || '';
                    document.getElementById('testCbdPercent').value = batch.test_cbd_percent || '';
                    document.getElementById('isRTA').value = batch.is_rta || 'no';
                    document.getElementById('testResultsNotes').value = batch.test_results_notes || '';
                    // Load saved product name and strain type if exists
                    if (batch.final_product_name) {
                        document.getElementById('finalProductName').value = batch.final_product_name;
                    }
                    if (batch.final_strain_type) {
                        document.getElementById('finalStrainType').value = batch.final_strain_type;
                    }
                    // Trigger batch ID generation in case user wants to reassign
                    generateBatchId();
                } else {
                    // Clear form
                    document.getElementById('testSubmittedDate').value = '';
                    document.getElementById('testExpirationDate').value = '';
                    document.getElementById('metrcLast4').value = '';
                    document.getElementById('newBatchId').value = '';
                    document.getElementById('testResultsReceivedDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('testThcPercent').value = '';
                    document.getElementById('testCbdPercent').value = '';
                    document.getElementById('isRTA').value = 'no';
                    document.getElementById('testResultsNotes').value = '';
                }
            }
            
            // Check RTA status after loading
            checkRTAStatus();
        });

        // Auto-generate batch ID from expiration date and METRC tag last 4
        function generateBatchId() {
            const expirationDate = document.getElementById('testExpirationDate').value;
            const metrcLast4 = document.getElementById('metrcLast4').value.trim();
            
            if (expirationDate && metrcLast4 && metrcLast4.length === 4) {
                // Parse date string directly to avoid timezone issues
                // Date format from input is YYYY-MM-DD
                const dateParts = expirationDate.split('-');
                const month = parseInt(dateParts[1], 10); // Remove leading zero
                const day = parseInt(dateParts[2], 10);   // Remove leading zero
                
                const batchId = `${month}.${day}.${metrcLast4}`;
                document.getElementById('newBatchId').value = batchId;
            } else {
                document.getElementById('newBatchId').value = '';
            }
        }

        // Add event listeners for auto-generation
        document.getElementById('testExpirationDate').addEventListener('change', generateBatchId);
        document.getElementById('metrcLast4').addEventListener('input', generateBatchId);

        // Check RTA status and show reminder if needed - BY EXTRACTION METHOD
        function checkRTAStatus() {
            const rtaBatches = batches.filter(b => b.is_rta === 'yes' && b.test_submitted_date);
            
            const today = new Date();
            
            // Track BHO and Brick Hash/Dry Sift separately
            const bhoRTAs = rtaBatches.filter(b => b.extraction_method === 'BHO');
            const hashRTAs = rtaBatches.filter(b => b.extraction_method === 'Dry Sift' || b.extraction_method === 'Brick Hash');
            
            let reminderHTML = '<div style="display: grid; gap: 15px;">';
            
            // Check BHO RTA Status
            reminderHTML += checkMethodRTA(bhoRTAs, 'BHO', today);
            
            // Check Hash RTA Status
            reminderHTML += checkMethodRTA(hashRTAs, 'Brick Hash / Dry Sift', today);
            
            reminderHTML += '</div>';
            
            document.getElementById('rtaReminder').innerHTML = reminderHTML;
        }
        
        function checkMethodRTA(rtaBatches, methodName, today) {
            if (rtaBatches.length === 0) {
                return `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 2px solid var(--accent-red); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-red); margin-bottom: 10px;">‚ö†Ô∏è ${methodName} - No RTA Submitted</h3>
                        <p style="color: var(--text-primary);">You must submit at least one RTA full panel per month for ${methodName}.</p>
                    </div>
                `;
            }
            
            // Get most recent RTA for this method
            rtaBatches.sort((a, b) => new Date(b.test_submitted_date) - new Date(a.test_submitted_date));
            const lastRTA = rtaBatches[0];
            const lastRTADate = new Date(lastRTA.test_submitted_date);
            
            // Check if next RTA is due (30 days)
            const nextRTADue = new Date(lastRTADate);
            nextRTADue.setDate(nextRTADue.getDate() + 30);
            
            const daysUntilDue = Math.floor((nextRTADue - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilDue < 0) {
                // Overdue
                return `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 2px solid var(--accent-red); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-red); margin-bottom: 10px;">üö® ${methodName} RTA OVERDUE!</h3>
                        <p style="color: var(--text-primary); margin-bottom: 10px;">Last RTA: ${lastRTA.id} (${lastRTADate.toLocaleDateString()}) - ${Math.abs(daysUntilDue)} days overdue</p>
                        <p style="color: var(--text-primary); font-weight: 700;">Submit new ${methodName} RTA immediately!</p>
                    </div>
                `;
            } else if (daysUntilDue <= 7) {
                // Due soon
                return `
                    <div style="background: rgba(245, 158, 11, 0.2); border: 2px solid var(--accent-orange); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-orange); margin-bottom: 10px;">‚ö†Ô∏è ${methodName} RTA Due Soon</h3>
                        <p style="color: var(--text-primary); margin-bottom: 10px;">Last RTA: ${lastRTA.id} (${lastRTADate.toLocaleDateString()})</p>
                        <p style="color: var(--text-primary); font-weight: 700;">Next ${methodName} RTA due in ${daysUntilDue} days (${nextRTADue.toLocaleDateString()})</p>
                    </div>
                `;
            } else {
                // All good
                return `
                    <div style="background: rgba(16, 185, 129, 0.2); border: 2px solid var(--accent-green); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 10px;">‚úì ${methodName} RTA: Current</h3>
                        <p style="color: var(--text-primary); margin-bottom: 10px;">Last RTA: ${lastRTA.id} (${lastRTADate.toLocaleDateString()})</p>
                        <p style="color: var(--text-primary);">Next due: ${nextRTADue.toLocaleDateString()} (${daysUntilDue} days)</p>
                    </div>
                `;
            }
        }

        async function submitTestResults() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('testingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) return;
            
            const thcPercent = parseFloat(document.getElementById('testThcPercent').value) || null;
            const cbdPercent = parseFloat(document.getElementById('testCbdPercent').value) || null;
            const isRTA = document.getElementById('isRTA').value;
            const submittedDate = document.getElementById('testSubmittedDate').value;
            const expirationDate = document.getElementById('testExpirationDate').value;
            const newBatchId = document.getElementById('newBatchId').value.trim();
            const finalProductName = document.getElementById('finalProductName').value.trim();
            const finalStrainType = document.getElementById('finalStrainType').value;
            
            if (!finalProductName) {
                alert('Please enter a product name for this batch.');
                return;
            }
            
            // Check if new batch ID is being assigned
            let batchIdChanged = false;
            let oldBatchId = batchId;
            if (newBatchId && newBatchId !== batchId) {
                // Verify new batch ID doesn't already exist
                const existingBatch = batches.find(b => b.id === newBatchId);
                if (existingBatch) {
                    alert(`Error: Batch ID "${newBatchId}" already exists in the system. Please choose a different ID.`);
                    return;
                }
                
                const confirmChange = confirm(
                    `‚ö†Ô∏è BATCH ID REASSIGNMENT\n\n` +
                    `Current ID: ${oldBatchId}\n` +
                    `New ID: ${newBatchId}\n\n` +
                    `This will permanently change the batch ID in the system.\n\n` +
                    `Continue?`
                );
                
                if (!confirmChange) return;
                
                batchIdChanged = true;
            }
            
            // Show redesignation note in timeline if strain type changed
            const strainTypeNote = batch.strain_type !== finalStrainType ? ` | Redesignated: ${batch.strain_type} ‚Üí ${finalStrainType}` : '';
            const batchIdNote = batchIdChanged ? ` | Batch ID reassigned: ${oldBatchId} ‚Üí ${newBatchId}` : '';
            
            const timeline = batch.timeline || [];
            const resultsText = thcPercent !== null ? `THC ${thcPercent}%, CBD ${cbdPercent || 0}%` : 'Test submitted - results pending';
            timeline.push({
                stage: 'testing',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `${resultsText}${isRTA === 'yes' ? ' - RTA FULL PANEL' : ''} | Named: ${finalProductName}${strainTypeNote}${batchIdNote}`
            });
            
            // Build update object - only include fields that exist in database
            const updates = {
                test_submitted_date: submittedDate,
                test_expiration_date: expirationDate,
                test_results_received_date: document.getElementById('testResultsReceivedDate').value,
                test_thc_percent: thcPercent,
                test_cbd_percent: cbdPercent,
                is_rta: isRTA,
                test_results_notes: document.getElementById('testResultsNotes').value || null,
                timeline: timeline
            };
            
            // Update the batch strain name and strain_type to reflect the final product
            // This makes batch IDs display the actual wholesale product name
            updates.strain = finalProductName;
            updates.strain_type = finalStrainType;
            
            // Store product info in notes for now until we add columns
            const productInfo = `\n\n[PRODUCT INFO]\nOriginal Strain: ${batch.strain}\nOriginal Type: ${batch.strain_type}\nFinal Name: ${finalProductName}\nFinal Type: ${finalStrainType}`;
            updates.test_results_notes = (updates.test_results_notes || '') + productInfo;
            
            // If batch ID is being changed, we need to handle it specially
            if (batchIdChanged) {
                // Add new batch ID to updates
                updates.id = newBatchId;
                
                // First, insert a new record with the new ID
                const { error: insertError } = await supabaseClient
                    .from('wm_batches')
                    .insert({
                        ...batch,
                        ...updates,
                        id: newBatchId
                    });
                
                if (insertError) {
                    console.error('Error creating new batch with new ID:', insertError);
                    alert('Error reassigning batch ID. Please try again.');
                    return;
                }
                
                // Then delete the old record
                const { error: deleteError } = await supabaseClient
                    .from('wm_batches')
                    .delete()
                    .eq('id', oldBatchId);
                
                if (deleteError) {
                    console.error('Error deleting old batch record:', deleteError);
                    alert('Warning: New batch created but old batch could not be removed. You may need to manually delete batch ' + oldBatchId);
                }
            } else {
                // Normal update without ID change
                const { error } = await supabaseClient
                    .from('wm_batches')
                    .update(updates)
                    .eq('id', batchId);
                
                if (error) {
                    console.error('Error updating test results:', error);
                    alert('Error saving test results. Please try again.');
                    return;
                }
            }
            
            const lidColor = finalStrainType === 'Indica' ? 'Blue' : finalStrainType === 'Sativa' ? 'Red' : 'Green';
            const resultsInfo = thcPercent !== null ? `\nTHC: ${thcPercent}% | CBD: ${cbdPercent || 0}%` : '\nTest submitted - awaiting results';
            const finalBatchId = batchIdChanged ? newBatchId : batchId;
            const batchChangeMsg = batchIdChanged ? `\n‚úì Batch ID changed: ${oldBatchId} ‚Üí ${newBatchId}` : '';
            alert(`Test results saved for ${finalBatchId}!${batchChangeMsg}\n\nProduct Name: ${finalProductName}\nStrain Type: ${finalStrainType} (${lidColor} Lid)${strainTypeNote ? '\n‚úì Strain type redesignated' : ''}${resultsInfo}\n${isRTA === 'yes' ? '‚úì RTA Full Panel' : 'Standard Potency'}\nExpires: ${expirationDate}`);
            
            document.getElementById('testingForm').style.display = 'none';
            document.getElementById('testingBatchSelect').value = '';
            
            await loadBatches();
            populateTestingSelect();
            checkRTAStatus();
        }

        // Toggle connection type UI
        function toggleConnectionType() {
            const type = document.getElementById('connectionType').value;
            document.getElementById('networkIPGroup').style.display = type === 'network' ? 'block' : 'none';
            document.getElementById('networkPortGroup').style.display = type === 'network' ? 'block' : 'none';
        }

        function savePrintSettings() {
            const printServerURL = document.getElementById('printServerURL').value;
            if (printServerURL) {
                localStorage.setItem('printServerURL', printServerURL);
                alert('Print server settings saved!\n\nMake sure the print server is running on that computer.');
            } else {
                localStorage.setItem('printServerURL', 'http://localhost:3000/print');
                alert('Using default localhost print server.');
            }
        }

        function populateLabelingSelect() {
            const select = document.getElementById('labelingBatchSelect');
            // Show batches that are complete and have test results, but haven't been labeled yet
            const labelableBatches = batches.filter(b => 
                b.status === 'complete' && 
                b.test_thc_percent && 
                !b.labels_applied
            );
            
            select.innerHTML = '<option value="">Select a batch...</option>';
            labelableBatches.forEach(batch => {
                const pauseIndicator = batch.labeling_paused ? ' ‚è∏Ô∏è PAUSED' : '';
                select.innerHTML += `<option value="${batch.id}">${batch.id} - ${batch.strain} - ${batch.packaged_product_type} (${batch.units_packaged} units)${pauseIndicator}</option>`;
            });
            
            // Load saved settings
            const savedURL = localStorage.getItem('printServerURL');
            if (savedURL) {
                document.getElementById('printServerURL').value = savedURL;
            }
        }

        document.getElementById('labelingBatchSelect').addEventListener('change', function() {
            const form = document.getElementById('labelingForm');
            form.style.display = this.value ? 'block' : 'none';
            
            if (this.value) {
                const batch = batches.find(b => b.id === this.value);
                displayLabelPreview(batch);
                
                // Initialize weight verification if elements exist
                const gramsLabeledInput = document.getElementById('gramsLabeled');
                const expectedWeightEl = document.getElementById('expectedWeight');
                const actualWeightEl = document.getElementById('actualWeight');
                
                if (gramsLabeledInput && expectedWeightEl && actualWeightEl) {
                    gramsLabeledInput.value = '';
                    document.getElementById('acceptDiscrepancy').checked = false;
                    document.getElementById('discrepancyAlert').style.display = 'none';
                    
                    const expectedGrams = parseFloat(batch.total_grams_packaged) || 0;
                    expectedWeightEl.textContent = expectedGrams.toFixed(1) + 'g';
                    actualWeightEl.textContent = '-';
                }
                
                // Update pause button visibility
                updatePauseButtons();
            }
        });

        // Real-time weight comparison for labeling
        const gramsLabeledInput = document.getElementById('gramsLabeled');
        if (gramsLabeledInput) {
            gramsLabeledInput.addEventListener('input', function() {
                const batchId = document.getElementById('labelingBatchSelect').value;
                const batch = batches.find(b => b.id === batchId);
                if (!batch) return;
                
                const gramsLabeled = parseFloat(this.value) || 0;
                const expectedGrams = parseFloat(batch.total_grams_packaged) || 0;
                
                const actualWeightEl = document.getElementById('actualWeight');
                if (actualWeightEl) {
                    actualWeightEl.textContent = gramsLabeled.toFixed(1) + 'g';
                }
                
                // Check for discrepancy (more than 2% difference)
                const discrepancy = Math.abs(gramsLabeled - expectedGrams);
                const percentDiff = expectedGrams > 0 ? (discrepancy / expectedGrams) * 100 : 0;
                
                const discrepancyAlert = document.getElementById('discrepancyAlert');
                if (discrepancyAlert) {
                    if (percentDiff > 2 && gramsLabeled > 0) {
                        discrepancyAlert.style.display = 'block';
                        document.getElementById('discrepancyDetails').innerHTML = `
                            <div>Expected: <strong>${expectedGrams.toFixed(1)}g</strong></div>
                            <div>Actual: <strong>${gramsLabeled.toFixed(1)}g</strong></div>
                            <div style="color: var(--accent-orange); font-weight: 700;">Difference: ${discrepancy.toFixed(1)}g (${percentDiff.toFixed(1)}%)</div>
                        `;
                    } else {
                        discrepancyAlert.style.display = 'none';
                        const acceptCheckbox = document.getElementById('acceptDiscrepancy');
                        if (acceptCheckbox) acceptCheckbox.checked = false;
                    }
                }
            });
        }


        function displayLabelPreview(batch) {
            const preview = document.getElementById('labelPreview');
            preview.innerHTML = `
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">PRODUCT</div>
                    <div style="font-weight: 700;">${batch.packaged_product_type}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">STRAIN</div>
                    <div style="font-weight: 700;">${batch.strain}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">BATCH ID</div>
                    <div style="font-weight: 700; color: var(--accent-purple);">${batch.id}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">THC</div>
                    <div style="font-weight: 700; color: var(--accent-green);">${batch.test_thc_percent}%</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">CBD</div>
                    <div style="font-weight: 700;">${batch.test_cbd_percent || 0}%</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">EXPIRES</div>
                    <div style="font-weight: 700;">${batch.test_expiration_date ? new Date(batch.test_expiration_date).toLocaleDateString() : 'N/A'}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">UNITS</div>
                    <div style="font-weight: 700;">${batch.units_packaged}</div>
                </div>
                ${batch.packaging_breakdown ? `
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">SIZES</div>
                    <div style="font-weight: 700;">${batch.packaging_breakdown}</div>
                </div>
                ` : ''}
            `;
        }

        // Open printable label popup
        function openPrintableLabels() {
            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) {
                alert('Please select a batch first');
                return;
            }
            
            const quantity = batch.units_packaged || 1;
            
            // Format expiration date
            let expDate = 'N/A';
            if (batch.test_expiration_date) {
                const d = new Date(batch.test_expiration_date);
                expDate = `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear().toString().slice(-2)}`;
            }
            
            // Determine net weight
            let netWeight = '1 GRAM';
            if (batch.packaged_product_type.includes('4g')) {
                netWeight = '4 GRAM';
            } else if (batch.packaged_product_type.includes('0.5')) {
                netWeight = '0.5 GRAM';
            }
            
            const thc = parseFloat(batch.test_thc_percent) || 0;
            const cbd = parseFloat(batch.test_cbd_percent) || 0;
            const cultivationLicense = batch.cultivation_license || '403R-01007';
            const extractionLicense = '404R-00016';
            
            // Create labels array
            let labelsHTML = '';
            for (let i = 0; i < quantity; i++) {
                labelsHTML += `
                    <div class="label">
                        <div class="product-type">${batch.packaged_product_type.toUpperCase()}</div>
                        <div class="strain">${batch.strain.toUpperCase()}</div>
                        <div class="cannabinoids">
                            <div class="cannabinoid-box">
                                <div>TOTAL THC: ${thc.toFixed(1)}%</div>
                                <div>TOTAL CBD: ${cbd.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="licenses">
                            <div>CULTIVATED BY ${cultivationLicense}</div>
                            <div>EXTRACTED BY ${extractionLicense}</div>
                        </div>
                        <div class="warnings">
                            <div>INTENDED USE: INHALED PRODUCT.</div>
                            <div>NOT APPROVED BY THE FDA.</div>
                        </div>
                        <div class="net-weight">NET WEIGHT: ${netWeight}</div>
                        <div class="serving">SERVING SIZE: ‚Ä¢</div>
                        <div class="batch-id">BATCH ${batch.id}</div>
                        <div class="expiration">USE BY ${expDate}</div>
                    </div>
                `;
            }
            
            // Create popup window
            const popup = window.open('', 'PrintLabels', 'width=800,height=600');
            popup.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>Print Labels - ${batch.id}</title>
    <style>
        @media print {
            @page {
                size: 1.77in 1.77in;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none;
            }
            .label {
                page-break-after: always;
                page-break-inside: avoid;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .no-print {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .no-print h1 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .no-print button {
            background: #9333ea;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .no-print button:hover {
            background: #7c2db8;
        }
        
        .labels-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, 1.77in);
            gap: 20px;
            justify-content: center;
        }
        
        .label {
            width: 1.77in;
            height: 1.77in;
            border: 2px solid #333;
            border-radius: 50%;
            background: white;
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }
        
        .product-type {
            font-size: 9pt;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .strain {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        
        .cannabinoid-box {
            border: 2px solid #000;
            padding: 4px 8px;
            margin: 4px 0;
            font-size: 6pt;
            font-weight: bold;
        }
        
        .licenses {
            font-size: 5pt;
            margin: 4px 0;
            line-height: 1.3;
        }
        
        .warnings {
            font-size: 4.5pt;
            margin: 3px 0;
            line-height: 1.2;
        }
        
        .net-weight {
            font-size: 6pt;
            font-weight: bold;
            margin: 3px 0;
        }
        
        .serving {
            font-size: 6pt;
            margin: 2px 0;
        }
        
        .batch-id {
            font-size: 7pt;
            font-weight: bold;
            margin: 3px 0;
        }
        
        .expiration {
            font-size: 6pt;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="no-print">
        <h1>Print Labels for ${batch.id}</h1>
        <p>Quantity: ${quantity} labels</p>
        <button onclick="window.print()">üñ®Ô∏è Print Labels</button>
        <button onclick="window.close()">Close</button>
    </div>
    
    <div class="labels-container">
        ${labelsHTML}
    </div>
</body>
</html>
            `);
            popup.document.close();
        }

        function generateZPL(batch) {
            // Generate ZPL (Zebra Programming Language) code for CIRCULAR label
            const labelSize = document.getElementById('labelSize').value;
            
            // Circular label dimensions (in dots at 203dpi)
            const sizes = {
                '1.0': { diameter: 203 },   // 1.0" circle
                '1.5': { diameter: 305 },   // 1.5" circle
                '2.0': { diameter: 406 }    // 2.0" circle
            };
            
            const size = sizes[labelSize] || sizes['1.5'];
            const centerX = Math.floor(size.diameter / 2);
            
            // Format product type for label
            const productType = batch.packaged_product_type.toUpperCase().replace('WAX/SUGAR', 'WAX');
            
            // Format expiration date as M.D.YY (like 3.6.26)
            let expDate = 'N/A';
            if (batch.test_expiration_date) {
                const d = new Date(batch.test_expiration_date);
                expDate = `${d.getMonth() + 1}.${d.getDate()}.${d.getFullYear().toString().slice(-2)}`;
            }
            
            // Get THC and CBD percentages
            const thc = parseFloat(batch.test_thc_percent) || 0;
            const cbd = parseFloat(batch.test_cbd_percent) || 0;
            
            // Determine net weight based on product type
            let netWeight = '1 GRAM';
            if (batch.packaged_product_type.includes('4g')) {
                netWeight = '4 GRAM';
            } else if (batch.packaged_product_type.includes('0.5')) {
                netWeight = '0.5 GRAM';
            }
            
            // Get cultivation license from batch (403R)
            const cultivationLicense = batch.cultivation_license || '403R-01007';
            
            // White Mousse extraction license (404R)
            const extractionLicense = '404R-00016';
            
            // ZPL for 45mm circular label matching Canva design
            const diameter = 360;  // 45mm at 203dpi
            const center = 180;
            const zpl = `^XA
^MMT
^PW${diameter}
^LL${diameter}
^LS0

~SD20

^CF0,22
^FO${center},35^FB${diameter},1,0,C^FD${productType}^FS

^CF0,40
^FO${center},60^FB${diameter},2,0,C^FD${batch.strain.toUpperCase()}^FS

^FO${center - 100},110^GB200,40,3^FS
^CF0,14
^FO${center},118^FB${diameter},1,0,C^FDTOTAL THC: ${thc.toFixed(1)}%^FS
^FO${center},133^FB${diameter},1,0,C^FDTOTAL CBD: ${cbd.toFixed(1)}%^FS

^CF0,11
^FO${center},165^FB${diameter},1,0,C^FDCULTIVATED BY ${cultivationLicense}^FS
^FO${center},180^FB${diameter},1,0,C^FDEXTRACTED BY ${extractionLicense}^FS

^CF0,10
^FO${center},198^FB${diameter},1,0,C^FDINTENDED USE: INHALED PRODUCT.^FS
^FO${center},210^FB${diameter},1,0,C^FDNOT APPROVED BY THE FDA.^FS

^CF0,12
^FO${center},228^FB${diameter},1,0,C^FDNET WEIGHT: ${netWeight}^FS

^CF0,12
^FO${center},245^FB${diameter},1,0,C^FDSERVING SIZE: ^FS
^FO${center + 40},243^GC6,6,B^FS

^CF0,16
^FO${center},265^FB${diameter},1,0,C^FDBATCH ${batch.id}^FS

^CF0,12
^FO${center},285^FB${diameter},1,0,C^FDUSE BY ${expDate}^FS

^XZ`;
            
            document.getElementById('zplPreview').textContent = zpl;
            return zpl;
        }

        async function testPrinterConnection() {
            const connectionType = document.getElementById('connectionType').value;
            const statusDiv = document.getElementById('printerStatus');
            
            if (connectionType === 'network') {
                const ip = document.getElementById('printerIP').value;
                const port = document.getElementById('printerPort').value;
                
                if (!ip) {
                    alert('Please enter printer IP address');
                    return;
                }
                
                // Save settings
                localStorage.setItem('zebraPrinterIP', ip);
                localStorage.setItem('zebraPrinterPort', port);
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.2); border: 2px solid var(--accent-blue); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-blue); margin-bottom: 10px;">üì° Network Printer Setup</h3>
                        <p style="color: var(--text-primary); margin-bottom: 10px;">To print directly to network printer at ${ip}:${port}, you need:</p>
                        <ol style="color: var(--text-primary); margin-left: 20px;">
                            <li><strong>Zebra Browser Print</strong> - Free software from Zebra
                                <br><a href="https://www.zebra.com/us/en/support-downloads/software/printer-software/browser-print.html" target="_blank" style="color: var(--accent-blue);">Download here</a>
                            </li>
                            <li><strong>Or download ZPL</strong> and send file to printer manually</li>
                        </ol>
                        <p style="color: var(--text-primary); margin-top: 15px;">IP saved: <strong>${ip}:${port}</strong></p>
                    </div>
                `;
            } else {
                // USB mode
                localStorage.setItem('zebraConnectionType', 'usb');
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.2); border: 2px solid var(--accent-green); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 10px;">üîå USB Connection Mode</h3>
                        <p style="color: var(--text-primary); margin-bottom: 10px;"><strong>Setup Steps:</strong></p>
                        <ol style="color: var(--text-primary); margin-left: 20px;">
                            <li>Connect ZT230 to computer via USB</li>
                            <li>Install <strong>Zebra Browser Print</strong> - <a href="https://www.zebra.com/us/en/support-downloads/software/printer-software/browser-print.html" target="_blank" style="color: var(--accent-blue);">Download here</a></li>
                            <li>Browser Print will auto-detect your USB printer</li>
                            <li>Click "Print Labels" and they'll go straight to your ZT230!</li>
                        </ol>
                        <p style="color: var(--text-primary); margin-top: 15px;"><strong>Mode saved:</strong> USB Direct Connection</p>
                    </div>
                `;
            }
        }

        async function printLabels() {
            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);

            if (!batch) {
                alert('Please select a batch first');
                return;
            }

            const quantity = parseInt(document.getElementById('labelQuantity').value) || 1;
            const labelsPerUnit = parseInt(document.getElementById('labelsPerUnit').value) || 1;
            const totalLabels = quantity * labelsPerUnit;

            const zpl = generateZPL(batch);
            
            // Generate ZPL with multiple copies
            let fullZPL = '';
            for (let i = 0; i < totalLabels; i++) {
                fullZPL += zpl + '\n';
            }
            
            // Try print server first (works from mobile!)
            const printServerURL = localStorage.getItem('printServerURL') || 'http://localhost:3000/print';

            try {
                const response = await fetch(printServerURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zpl: fullZPL })
                });

                if (response.ok) {
                    alert(`‚úì Sent ${totalLabels} labels to printer!`);
                    return;
                }
            } catch (error) {
                // Print server not available, try Browser Print
            }

            // Fallback to Browser Print
            if (window.BrowserPrint) {
                try {
                    const printer = await window.BrowserPrint.getDefaultDevice('printer');

                    printer.send(fullZPL, undefined, (error) => {
                        if (error) {
                            console.error('Print error:', error);
                            alert('Print failed. Use "Download ZPL" button instead.');
                        } else {
                            alert(`‚úì Sent ${totalLabels} labels to printer!`);
                        }
                    });
                } catch (error) {
                    console.error('Browser Print error:', error);
                    alert('Printing not available.\n\nOptions:\n1. Start print server (see setup docs)\n2. Use "Download ZPL" button');
                }
            } else {
                alert('Print server not running and Browser Print not installed.\n\nUse "Download ZPL" button to print manually.');
            }
        }

        function downloadZPL() {
            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);

            if (!batch) {
                alert('Please select a batch first');
                return;
            }

            const quantity = parseInt(document.getElementById('labelQuantity').value) || 1;
            const labelsPerUnit = parseInt(document.getElementById('labelsPerUnit').value) || 1;
            const totalLabels = quantity * labelsPerUnit;

            const zpl = generateZPL(batch);

            // Generate ZPL file with multiple copies
            let fullZPL = '';
            for (let i = 0; i < totalLabels; i++) {
                fullZPL += zpl + '\n';
            }

            try {
                // Create download
                const blob = new Blob([fullZPL], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${batch.id}_labels_${totalLabels}x.zpl`;
                link.click();

                alert(`Downloaded ZPL file for ${totalLabels} labels!\n\nSend this file to your Zebra printer using:\n- Zebra Setup Utilities ‚Üí Send File\n- Or drag file to printer in Setup Utilities`);
            } catch (error) {
                console.error('Download error:', error);
                alert('Error creating download.');
            }
        }

        // Start labeling (marks batch as in-progress)
        async function startLabeling() {
            if (!currentRole) {
                alert('Please login first!');
                return;
            }
            
            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) return;
            
            const confirmation = confirm(
                `Mark batch ${batchId} as STARTED labeling?\n\n` +
                `This will:\n` +
                `‚Ä¢ Add "Labeling Started" to timeline\n` +
                `‚Ä¢ Keep status as "complete" (not yet labeled)\n` +
                `‚Ä¢ Allow you to finish later\n\n` +
                `You can skip this and go straight to "Complete Labeling" for single sessions.`
            );
            
            if (!confirmation) return;
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'labeling',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: 'Labeling started'
            });
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update({
                    labeling_notes: document.getElementById('labelingNotes').value || null,
                    timeline: timeline
                })
                .eq('id', batchId);
            
            if (error) {
                console.error('Error marking batch as started:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            alert(`‚úÖ Batch ${batchId} marked as labeling in progress!\n\n` +
                  `Started by: ${currentRole.name}\n\n` +
                  `This batch will remain in the dropdown until you click "Complete Labeling".`);
            
            // Refresh batch data but keep form open and batch selected
            await loadBatches();
            populateLabelingSelect();
            
            // Re-select the batch
            document.getElementById('labelingBatchSelect').value = batchId;
            document.getElementById('labelingForm').style.display = 'block';
            
            // Re-populate the label preview since batch was reselected
            const updatedBatch = batches.find(b => b.id === batchId);
            if (updatedBatch) {
                displayLabelPreview(updatedBatch);
                
                // Reinitialize weight verification
                const gramsLabeledInput = document.getElementById('gramsLabeled');
                const expectedWeightEl = document.getElementById('expectedWeight');
                if (gramsLabeledInput && expectedWeightEl) {
                    const expectedGrams = parseFloat(updatedBatch.total_grams_packaged) || 0;
                    expectedWeightEl.textContent = expectedGrams.toFixed(1) + 'g';
                }
            }
        }

        // Toggle pause/resume for labeling
        async function togglePauseLabeling() {
            if (!currentRole) {
                alert('Please select a user first!');
                return;
            }

            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) {
                alert('Please select a batch first!');
                return;
            }
            
            const isPaused = batch.labeling_paused || false;
            const action = isPaused ? 'RESUME' : 'PAUSE';
            const actionVerb = isPaused ? 'Resumed' : 'Paused';
            
            const confirmation = confirm(
                `${action} labeling for batch ${batchId}?\n\n` +
                `This will:\n` +
                `‚Ä¢ Add "${actionVerb}" to timeline\n` +
                `‚Ä¢ ${isPaused ? 'Allow work to continue' : 'Temporarily stop work'}\n` +
                `‚Ä¢ Keep batch in labeling stage`
            );
            
            if (!confirmation) return;
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'labeling',
                user: currentRole ? currentRole.name : "Unknown",
                date: new Date().toISOString(),
                action: `Labeling ${actionVerb.toLowerCase()}`
            });
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update({
                    labeling_paused: !isPaused,
                    timeline: timeline
                })
                .eq('id', batchId);
            
            if (error) {
                console.error('Error toggling pause:', error);
                alert('Error updating batch. Please try again.');
                return;
            }
            
            alert(`‚úÖ Labeling ${actionVerb.toLowerCase()} for batch ${batchId}!\n\n` +
                  `${isPaused ? 'Work can continue.' : 'Work temporarily stopped.'}\n` +
                  `${actionVerb} by: ${currentRole.name}`);
            
            await loadBatches();
            populateLabelingSelect();
            // Keep the batch selected
            document.getElementById('labelingBatchSelect').value = batchId;
            document.getElementById('labelingBatchSelect').dispatchEvent(new Event('change'));
        }

        async function markAsLabeled() {
            if (!currentRole) {
                alert('Please login first!');
                return;
            }
            
            const batchId = document.getElementById('labelingBatchSelect').value;
            const batch = batches.find(b => b.id === batchId);
            
            if (!batch) {
                alert('Please select a batch first');
                return;
            }
            
            // Use units packaged as the quantity (no separate labelQuantity input anymore)
            const quantity = batch.units_packaged || 0;
            
            // Check if weight verification fields exist
            const gramsLabeledInput = document.getElementById('gramsLabeled');
            let gramsLabeled = null;
            let discrepancyData = null;
            
            if (gramsLabeledInput) {
                gramsLabeled = parseFloat(gramsLabeledInput.value);
                
                if (!gramsLabeled || gramsLabeled <= 0) {
                    alert('Please enter the total grams labeled');
                    return;
                }
                
                // Check for discrepancy
                const expectedGrams = parseFloat(batch.total_grams_packaged) || 0;
                const discrepancy = Math.abs(gramsLabeled - expectedGrams);
                const percentDiff = expectedGrams > 0 ? (discrepancy / expectedGrams) * 100 : 0;
                
                // If discrepancy > 2%, require acceptance
                if (percentDiff > 2) {
                    const acceptCheckbox = document.getElementById('acceptDiscrepancy');
                    if (!acceptCheckbox || !acceptCheckbox.checked) {
                        alert('‚ö†Ô∏è Weight discrepancy detected!\n\nYou must check the box to verify and accept the discrepancy before proceeding.');
                        return;
                    }
                    discrepancyData = { discrepancy, percentDiff };
                }
            }
            
            const confirmMsg = gramsLabeled 
                ? `Mark ${batchId} as labeled?\n\nGrams Labeled: ${gramsLabeled.toFixed(1)}g\nUnits: ${quantity}`
                : `Mark ${batchId} as labeled?\n\n${quantity} units`;
                
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const timeline = batch.timeline || [];
            timeline.push({
                stage: 'labeling',
                timestamp: new Date().toISOString(),
                user: currentRole ? currentRole.name : "Unknown",
                action: gramsLabeled ? `Labeled ${quantity} units - ${gramsLabeled.toFixed(1)}g total` : `Labeled ${quantity} units`
            });
            
            const updateData = {
                labels_applied: true,
                labeling_date: new Date().toISOString().split('T')[0],
                labeling_user: currentRole ? currentRole.name : "Unknown",
                labels_applied_quantity: quantity,
                labeling_notes: document.getElementById('labelingNotes').value || null,
                timeline: timeline
            };
            
            // Add weight data if verified
            if (gramsLabeled) {
                updateData.grams_labeled = gramsLabeled;
                if (discrepancyData) {
                    updateData.weight_discrepancy = discrepancyData.discrepancy;
                    updateData.discrepancy_accepted = true;
                }
            }
            
            const { error } = await supabaseClient
                .from('wm_batches')
                .update(updateData)
                .eq('id', batchId);
            
            if (error) {
                console.error('Error marking as labeled:', error);
                alert('Error saving labeling status. Please try again.');
                return;
            }
            
            showCelebration({
                emoji: 'üèÜ',
                title: 'Batch Complete!',
                message: `${batchId} is fully labeled and ready for sale!`,
                stats: [
                    { value: quantity, label: 'Labels Applied' },
                    { value: gramsLabeled ? `${gramsLabeled.toFixed(1)}g` : batch.product_made || 'N/A', label: gramsLabeled ? 'Total Weight' : 'Product' }
                ],
                confettiCount: 80
            });

            document.getElementById('labelingForm').style.display = 'none';
            document.getElementById('labelingBatchSelect').value = '';
            document.getElementById('labelingNotes').value = '';
            
            await loadBatches();
            populateLabelingSelect();
        }

        // Analytics functions
        let currentAnalyticsFilter = 'all';

        function updateAnalytics() {
            const completedBatches = batches.filter(b => b.status === 'complete');
            
            if (completedBatches.length === 0) {
                document.getElementById('avgYield').textContent = '0%';
                document.getElementById('avgThc').textContent = '0%';
                document.getElementById('avgProcessingTime').textContent = '0d';
                document.getElementById('avgCostPerGram').textContent = '$0';
                document.getElementById('completedBatchesGrid').innerHTML = '<p style="padding: 40px; text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">No completed batches yet</p>';
                return;
            }
            
            // Calculate summary stats
            let totalYield = 0, yieldCount = 0;
            let totalThc = 0, thcCount = 0;
            let totalProcessingDays = 0, timeCount = 0;
            let totalCostPerGram = 0, costCount = 0;
            
            completedBatches.forEach(b => {
                // Yield - use grams_labeled (actual sellable weight) instead of net_weight
                if (b.trim_weight && b.grams_labeled) {
                    totalYield += (parseFloat(b.grams_labeled) / parseFloat(b.trim_weight)) * 100;
                    yieldCount++;
                }
                // THC
                if (b.test_thc_percent) {
                    totalThc += parseFloat(b.test_thc_percent);
                    thcCount++;
                }
                // Processing time
                if (b.intake_date && b.finishing_date) {
                    const days = (new Date(b.finishing_date) - new Date(b.intake_date)) / (1000 * 60 * 60 * 24);
                    totalProcessingDays += days;
                    timeCount++;
                }
                // Cost per gram - use grams_labeled (actual sellable weight) instead of net_weight
                if (b.material_cost && b.grams_labeled) {
                    totalCostPerGram += parseFloat(b.material_cost) / parseFloat(b.grams_labeled);
                    costCount++;
                }
            });
            
            document.getElementById('avgYield').textContent = yieldCount > 0 ? (totalYield / yieldCount).toFixed(2) + '%' : '0%';
            document.getElementById('avgThc').textContent = thcCount > 0 ? (totalThc / thcCount).toFixed(2) + '%' : '0%';
            document.getElementById('avgProcessingTime').textContent = timeCount > 0 ? (totalProcessingDays / timeCount).toFixed(1) + 'd' : '0d';
            document.getElementById('avgCostPerGram').textContent = costCount > 0 ? '$' + (totalCostPerGram / costCount).toFixed(2) : '$0';
            
            filterAnalytics(currentAnalyticsFilter);
        }
        
        function filterAnalytics(filter) {
            currentAnalyticsFilter = filter;
            
            // Update active button
            document.querySelectorAll('[data-filter-analytics]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filterAnalytics === filter);
            });
            
            let filteredBatches = batches.filter(b => b.status === 'complete');
            
            const now = new Date();
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            
            if (filter === 'thisMonth') {
                filteredBatches = filteredBatches.filter(b => new Date(b.finishing_date) >= thisMonthStart);
            } else if (filter === 'lastMonth') {
                filteredBatches = filteredBatches.filter(b => {
                    const finishDate = new Date(b.finishing_date);
                    return finishDate >= lastMonthStart && finishDate <= lastMonthEnd;
                });
            }
            
            renderBatchCards(filteredBatches);
        }
        
        function renderBatchCards(completedBatches) {
            const container = document.getElementById('completedBatchesGrid');
            
            if (completedBatches.length === 0) {
                container.innerHTML = '<p style="padding: 40px; text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">No batches for this period</p>';
                return;
            }
            
            container.innerHTML = completedBatches.map(batch => {
                return `
                    <div class="batch-card" onclick="showBatchDetails('${batch.id}')" style="cursor: pointer; transition: all 0.2s; background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 2px solid var(--border);">
                        <div style="text-align: center;">
                            <div style="font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; color: var(--accent-green); margin-bottom: 8px;">${batch.id}</div>
                            <div style="color: var(--text-primary); font-size: 1rem; font-weight: 600;">${batch.strain}</div>
                            <div style="margin-top: 8px; padding: 4px 12px; background: rgba(147, 51, 234, 0.2); border-radius: 12px; font-size: 0.85rem; color: var(--accent-purple); display: inline-block;">
                                ${batch.strain_type}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add hover effect via CSS
            document.querySelectorAll('.batch-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                    this.style.boxShadow = '0 8px 24px rgba(147, 51, 234, 0.3)';
                    this.style.borderColor = 'var(--accent-purple)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                    this.style.borderColor = 'var(--border)';
                });
            });
        }

        function showBatchDetails(batchId) {
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;
            
            // Update modal title
            document.getElementById('modalBatchId').textContent = batch.id;
            
            // Batch Overview Cards
            const overview = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent-green);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Strain</div>
                    <div style="font-size: 1.1rem; font-weight: 700;">${batch.strain}</div>
                    <div style="font-size: 0.9rem; color: var(--accent-purple);">${batch.strain_type}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Product Made</div>
                    <div style="font-size: 1.1rem; font-weight: 700;">${batch.product_made || 'N/A'}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent-orange);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Grower</div>
                    <div style="font-size: 1.1rem; font-weight: 700;">${batch.grower_name || 'N/A'}</div>
                    <div style="font-size: 0.9rem; color: var(--accent-orange);">${batch.cultivation_license}</div>
                </div>
            `;
            document.getElementById('modalBatchOverview').innerHTML = overview;
            
            // Processing Timeline
            const intakeDate = new Date(batch.intake_date);
            
            // Derive extraction date from timeline completion
            let extractionDate = null;
            if (batch.timeline && batch.timeline.length > 0) {
                const extractionComplete = batch.timeline.find(t => 
                    t.stage === 'extraction' && t.timestamp
                );
                if (extractionComplete) {
                    extractionDate = new Date(extractionComplete.timestamp);
                }
            }
            
            const finishingDate = batch.finishing_date ? new Date(batch.finishing_date) : null;
            const packagingDate = batch.packaging_date ? new Date(batch.packaging_date) : null;
            const testingDate = batch.test_results_received_date ? new Date(batch.test_results_received_date) : null;
            const labelingDate = batch.labeling_date ? new Date(batch.labeling_date) : null;
            
            const totalDays = finishingDate ? ((finishingDate - intakeDate) / (1000 * 60 * 60 * 24)).toFixed(1) : 'N/A';
            const extractionDays = extractionDate && intakeDate ? ((extractionDate - intakeDate) / (1000 * 60 * 60 * 24)).toFixed(1) : 'N/A';
            const finishingDays = finishingDate && extractionDate ? ((finishingDate - extractionDate) / (1000 * 60 * 60 * 24)).toFixed(1) : 'N/A';
            
            // Helper function to format time in hours/minutes
            function formatDuration(minutes) {
                if (!minutes || minutes < 0) return 'N/A';
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                if (hours > 0) {
                    return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                }
                return `${mins}m`;
            }
            
            // Calculate stage durations from timeline
            let extractionTime = null;
            let finishingTime = null;
            let packagingTime = null;
            let testingTime = null;
            let labelingTime = null;
            
            if (batch.timeline && batch.timeline.length > 0) {
                // Find extraction start and complete
                const extractionStart = batch.timeline.find(t => 
                    t.action && (t.action.includes('Processing started') || t.action.includes('Extraction started'))
                );
                const extractionComplete = batch.timeline.find(t => 
                    (t.stage === 'extraction' || t.stage === 'finishing') && 
                    t.action && 
                    (t.action.includes('completed') || t.action.includes('Extracted') || t.action.includes('Extraction completed'))
                );
                
                if (extractionStart && extractionComplete) {
                    const startTime = new Date(extractionStart.date || extractionStart.timestamp);
                    const endTime = new Date(extractionComplete.date || extractionComplete.timestamp);
                    extractionTime = (endTime - startTime) / (1000 * 60); // minutes
                }
                
                // Find finishing/post-extraction start and complete (if exists)
                const finishingStart = batch.timeline.find(t => 
                    t.action && (t.action.includes('Post-processing started') || t.action.includes('Finishing started'))
                );
                const finishingComplete = batch.timeline.find(t => 
                    t.stage === 'finishing' && 
                    t.action && 
                    (t.action.includes('Finishing completed') || t.action.includes('Post-extraction completed'))
                );
                
                if (finishingStart && finishingComplete) {
                    const startTime = new Date(finishingStart.date || finishingStart.timestamp);
                    const endTime = new Date(finishingComplete.date || finishingComplete.timestamp);
                    finishingTime = (endTime - startTime) / (1000 * 60); // minutes
                }
                
                // Find packaging start and complete
                const packagingStart = batch.timeline.find(t => 
                    t.action && t.action.includes('Packaging started')
                );
                const packagingComplete = batch.timeline.find(t => 
                    t.stage === 'packaging' && 
                    t.action && 
                    (t.action.includes('packaged') || t.action.includes('Packaging completed') || t.action.includes('units packaged'))
                );
                
                if (packagingStart && packagingComplete) {
                    const startTime = new Date(packagingStart.date || packagingStart.timestamp);
                    const endTime = new Date(packagingComplete.date || packagingComplete.timestamp);
                    packagingTime = (endTime - startTime) / (1000 * 60); // minutes
                }
                
                // Find testing start and complete (test submitted to results received)
                const testSubmitted = batch.timeline.find(t => 
                    t.action && (t.action.includes('Test submitted') || t.action.includes('Submitted for testing'))
                );
                const testComplete = batch.timeline.find(t => 
                    t.action && (t.action.includes('Test results recorded') || t.action.includes('results received'))
                );
                
                if (testSubmitted && testComplete) {
                    const startTime = new Date(testSubmitted.date || testSubmitted.timestamp);
                    const endTime = new Date(testComplete.date || testComplete.timestamp);
                    testingTime = (endTime - startTime) / (1000 * 60); // minutes
                }
                
                // Find labeling start and complete
                const labelingStart = batch.timeline.find(t => 
                    t.action && t.action.includes('Labeling started')
                );
                const labelingComplete = batch.timeline.find(t => 
                    t.stage === 'labeling' && 
                    (t.action && t.action.includes('labeled') || t.timestamp)
                );
                
                if (labelingStart && labelingComplete) {
                    const startTime = new Date(labelingStart.date || labelingStart.timestamp);
                    const endTime = new Date(labelingComplete.date || labelingComplete.timestamp);
                    labelingTime = (endTime - startTime) / (1000 * 60); // minutes
                }
            }
            
            const timeline = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">üì•</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Intake</div>
                        <div style="font-weight: 700;">${intakeDate.toLocaleDateString()}</div>
                    </div>
                    ${extractionDate ? `
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">‚öóÔ∏è</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Extraction</div>
                        <div style="font-weight: 700;">${extractionDate.toLocaleDateString()}</div>
                        ${extractionTime ? `<div style="font-size: 0.9rem; color: var(--accent-green); font-weight: 700; margin-top: 5px;">‚è±Ô∏è ${formatDuration(extractionTime)}</div>` : ''}
                    </div>` : ''}
                    ${finishingDate ? `
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">‚ú®</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Finishing</div>
                        <div style="font-weight: 700;">${finishingDate.toLocaleDateString()}</div>
                        ${finishingTime ? `<div style="font-size: 0.9rem; color: var(--accent-green); font-weight: 700; margin-top: 5px;">‚è±Ô∏è ${formatDuration(finishingTime)}</div>` : ''}
                    </div>` : ''}
                    ${packagingDate ? `
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">üì¶</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Packaged</div>
                        <div style="font-weight: 700;">${packagingDate.toLocaleDateString()}</div>
                        ${packagingTime ? `<div style="font-size: 0.9rem; color: var(--accent-green); font-weight: 700; margin-top: 5px;">‚è±Ô∏è ${formatDuration(packagingTime)}</div>` : ''}
                    </div>` : ''}
                    ${testingDate ? `
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">üß™</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Testing</div>
                        <div style="font-weight: 700;">${testingDate.toLocaleDateString()}</div>
                        ${testingTime ? `<div style="font-size: 0.9rem; color: var(--accent-green); font-weight: 700; margin-top: 5px;">‚è±Ô∏è ${formatDuration(testingTime)}</div>` : ''}
                    </div>` : ''}
                    ${labelingDate ? `
                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">üè∑Ô∏è</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Labeled</div>
                        <div style="font-weight: 700;">${labelingDate.toLocaleDateString()}</div>
                        ${labelingTime ? `<div style="font-size: 0.9rem; color: var(--accent-green); font-weight: 700; margin-top: 5px;">‚è±Ô∏è ${formatDuration(labelingTime)}</div>` : ''}
                    </div>` : ''}
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.2); border-radius: 10px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Processing Time</div>
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">${totalDays} days</div>
                </div>
            `;
            document.getElementById('modalTimeline').innerHTML = timeline;
            
            // Economics
            const trimWeight = parseFloat(batch.trim_weight || 0);
            const netWeight = parseFloat(batch.net_weight || 0);
            const gramsLabeled = parseFloat(batch.grams_labeled || 0);
            
            // Use grams_labeled for yield if available, otherwise fall back to net_weight
            const finalWeight = gramsLabeled > 0 ? gramsLabeled : netWeight;
            const yield_percent = trimWeight > 0 ? ((finalWeight / trimWeight) * 100).toFixed(2) : 0;
            
            const materialCost = parseFloat(batch.material_cost || 0);
            const costPerGram = finalWeight > 0 ? (materialCost / finalWeight).toFixed(2) : 0;
            const costPerUnit = batch.units_packaged > 0 ? (materialCost / batch.units_packaged).toFixed(2) : 0;
            
            const economics = `
                <p><strong>Trim Used:</strong> ${trimWeight}g</p>
                <p><strong>Final Net Weight:</strong> ${netWeight}g</p>
                ${gramsLabeled > 0 ? `<p><strong>Labeled Weight:</strong> ${gramsLabeled}g</p>` : ''}
                <p style="color: var(--accent-green); font-size: 1.2rem; font-weight: 700; margin: 10px 0;"><strong>Yield:</strong> ${yield_percent}%</p>
                <p><strong>Material Cost:</strong> $${materialCost.toFixed(2)}</p>
                <p><strong>Cost Per Gram:</strong> $${costPerGram}</p>
                ${batch.units_packaged ? `<p><strong>Cost Per Unit:</strong> $${costPerUnit}</p>` : ''}
            `;
            document.getElementById('modalEconomics').innerHTML = economics;
            
            // Testing Results
            const testing = `
                <p><strong>THC:</strong> <span style="color: var(--accent-green); font-size: 1.3rem; font-weight: 700;">${batch.test_thc_percent || 'N/A'}${batch.test_thc_percent ? '%' : ''}</span></p>
                <p><strong>CBD:</strong> ${batch.test_cbd_percent || 0}%</p>
                ${batch.is_rta === 'yes' ? '<p style="color: var(--accent-green);"><strong>‚úì RTA Full Panel</strong></p>' : '<p style="color: var(--text-secondary);">Standard Potency Test</p>'}
                ${batch.test_expiration_date ? `<p><strong>Expires:</strong> ${new Date(batch.test_expiration_date).toLocaleDateString()}</p>` : ''}
            `;
            document.getElementById('modalTesting').innerHTML = testing;
            
            // Production
            const production = `
                <p><strong>Units Packaged:</strong> ${batch.units_packaged || 'N/A'}</p>
                ${batch.packaging_breakdown ? `<p><strong>Breakdown:</strong> ${batch.packaging_breakdown}</p>` : ''}
                <p><strong>Extraction Method:</strong> ${batch.extraction_method || 'N/A'}</p>
                <p><strong>Material Agreement:</strong> ${batch.material_agreement || 'N/A'}</p>
                ${batch.metrc_tags ? `<p style="margin-top: 10px;"><strong>METRC Tags:</strong><br><span style="font-family: 'Space Mono', monospace; font-size: 0.9rem;">${batch.metrc_tags}</span></p>` : ''}
            `;
            document.getElementById('modalProduction').innerHTML = production;
            
            // Team Members
            const teamMembers = {};
            if (batch.timeline) {
                batch.timeline.forEach(entry => {
                    if (entry.user && entry.user !== 'Unknown') {
                        if (!teamMembers[entry.user]) {
                            teamMembers[entry.user] = [];
                        }
                        teamMembers[entry.user].push(entry.stage);
                    }
                });
            }
            
            const team = Object.keys(teamMembers).length > 0 ? Object.keys(teamMembers).map(user => `
                <div style="display: inline-block; margin: 5px 10px 5px 0; padding: 10px 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-weight: 700;">${user}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${[...new Set(teamMembers[user])].join(', ')}</div>
                </div>
            `).join('') : '<p style="color: var(--text-secondary);">No team members recorded</p>';
            
            document.getElementById('modalTeam').innerHTML = team;
            
            // Show modal
            document.getElementById('batchDetailsModal').style.display = 'block';
        }

        function closeBatchDetails() {
            document.getElementById('batchDetailsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('batchDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBatchDetails();
            }
        });

        // Performance Analytics
        document.getElementById('performanceFilter')?.addEventListener('change', function() {
            renderPerformanceAnalytics();
        });

        // Save and load targets
        function saveTargets() {
            const targets = {
                packaging: parseFloat(document.getElementById('targetPackagingUnits')?.value) || 200,
                labeling: parseFloat(document.getElementById('targetLabelingUnits')?.value) || 300,
                extractionTrim: parseFloat(document.getElementById('targetExtractionTrim')?.value) || 11200
            };
            localStorage.setItem('productionTargets', JSON.stringify(targets));
        }

        function loadTargets() {
            const saved = localStorage.getItem('productionTargets');
            if (saved) {
                const targets = JSON.parse(saved);
                if (document.getElementById('targetPackagingUnits')) {
                    document.getElementById('targetPackagingUnits').value = targets.packaging || 200;
                    document.getElementById('targetLabelingUnits').value = targets.labeling || 300;
                    document.getElementById('targetExtractionTrim').value = targets.extractionTrim || 11200;
                }
            }
            return saved ? JSON.parse(saved) : { packaging: 200, labeling: 300, extractionTrim: 11200 };
        }

        function renderPerformanceAnalytics() {
            const filter = document.getElementById('performanceFilter')?.value || 'all';
            const viewMode = document.getElementById('performanceViewMode')?.value || 'overview';
            const timeRange = parseInt(document.getElementById('performanceTimeRange')?.value) || 30;
            const statsContainer = document.getElementById('performanceStats');
            const companySummary = document.getElementById('companySummary');
            const staffingContainer = document.getElementById('staffingRecommendations');
            const capacityContainer = document.getElementById('capacityPlanning');
            const logContainer = document.getElementById('activityLog');
            
            if (!statsContainer) return;
            
            // Update today's production summary
            updateTodayProduction();
            
            // Update company production summary based on time range
            updateCompanyProductionSummary(timeRange);
            
            // Update login tracker
            updateLoginTracker();

            const targets = loadTargets();
            
            // Calculate date range
            const now = new Date();
            const rangeStart = new Date(now.getTime() - (timeRange * 24 * 60 * 60 * 1000));
            
            // Build employee production data from batches
            const employeeData = {};
            const dailyProduction = {}; // For trend analysis
            
            batches.forEach(batch => {
                // Track packaging production
                if (batch.packaging_user && batch.packaging_date && batch.units_packaged) {
                    const packagingDate = new Date(batch.packaging_date);
                    if (packagingDate >= rangeStart) {
                        const user = batch.packaging_user;
                        if (!employeeData[user]) {
                            employeeData[user] = {
                                name: user,
                                packaging: { units: 0, batches: 0, byProduct: {}, dates: [] },
                                labeling: { units: 0, batches: 0, dates: [] },
                                extraction: { batches: 0, runs: 0, trimWeight: 0, dates: [] },
                                daysActive: new Set()
                            };
                        }
                        
                        employeeData[user].packaging.units += batch.units_packaged;
                        employeeData[user].packaging.batches += 1;
                        employeeData[user].packaging.dates.push(packagingDate);
                        employeeData[user].daysActive.add(packagingDate.toDateString());
                        
                        // Track by product type
                        const productType = batch.packaged_product_type || 'Unknown';
                        if (!employeeData[user].packaging.byProduct[productType]) {
                            employeeData[user].packaging.byProduct[productType] = 0;
                        }
                        employeeData[user].packaging.byProduct[productType] += batch.units_packaged;
                        
                        // Daily production tracking
                        const dateKey = packagingDate.toDateString();
                        if (!dailyProduction[dateKey]) dailyProduction[dateKey] = { packaging: 0, labeling: 0 };
                        dailyProduction[dateKey].packaging += batch.units_packaged;
                    }
                }
                
                // Track labeling production (from timeline)
                if (batch.timeline && batch.timeline.length > 0) {
                    batch.timeline.forEach(event => {
                        const eventDate = new Date(event.timestamp || event.date);
                        
                        // Labeling completion
                        if (event.stage === 'labeling' && 
                            event.action && 
                            (event.action.toLowerCase().includes('completed') || event.action.toLowerCase().includes('labeled')) &&
                            eventDate >= rangeStart &&
                            batch.units_packaged) {
                            
                            const user = event.user;
                            if (!employeeData[user]) {
                                employeeData[user] = {
                                    name: user,
                                    packaging: { units: 0, batches: 0, byProduct: {}, dates: [] },
                                    labeling: { units: 0, batches: 0, dates: [] },
                                    extraction: { batches: 0, runs: 0, trimWeight: 0, dates: [] },
                                    daysActive: new Set()
                                };
                            }
                            
                            employeeData[user].labeling.units += batch.units_packaged;
                            employeeData[user].labeling.batches += 1;
                            employeeData[user].labeling.dates.push(eventDate);
                            employeeData[user].daysActive.add(eventDate.toDateString());
                            
                            const dateKey = eventDate.toDateString();
                            if (!dailyProduction[dateKey]) dailyProduction[dateKey] = { packaging: 0, labeling: 0 };
                            dailyProduction[dateKey].labeling += batch.units_packaged;
                        }
                        
                        // Extraction completion
                        if (event.stage === 'extraction' && 
                            event.action && 
                            event.action.toLowerCase().includes('completed') &&
                            eventDate >= rangeStart) {
                            
                            const user = event.user;
                            if (!employeeData[user]) {
                                employeeData[user] = {
                                    name: user,
                                    packaging: { units: 0, batches: 0, byProduct: {}, dates: [] },
                                    labeling: { units: 0, batches: 0, dates: [] },
                                    extraction: { batches: 0, runs: 0, trimWeight: 0, dates: [] },
                                    daysActive: new Set()
                                };
                            }
                            
                            employeeData[user].extraction.batches += 1;
                            // Track runs from extraction_runs field
                            if (batch.extraction_runs) {
                                employeeData[user].extraction.runs += parseInt(batch.extraction_runs);
                            }
                            // Track trim weight processed
                            if (batch.trim_weight) {
                                employeeData[user].extraction.trimWeight += parseFloat(batch.trim_weight);
                            }
                            employeeData[user].extraction.dates.push(eventDate);
                            employeeData[user].daysActive.add(eventDate.toDateString());
                        }
                    });
                }
            });
            
            // Calculate per-day averages for each employee
            Object.values(employeeData).forEach(emp => {
                const daysActive = emp.daysActive.size;
                emp.daysActiveCount = daysActive;
                emp.packaging.perDay = daysActive > 0 ? (emp.packaging.units / daysActive).toFixed(1) : 0;
                emp.labeling.perDay = daysActive > 0 ? (emp.labeling.units / daysActive).toFixed(1) : 0;
                emp.extraction.perDay = daysActive > 0 ? (emp.extraction.batches / daysActive).toFixed(2) : 0;
            });
            
            // Filter data if needed
            const displayData = filter === 'all' 
                ? Object.values(employeeData) 
                : Object.values(employeeData).filter(e => e.name === filter);
            
            // Render company-wide summary (removed - now using separate function)
            
            // Render individual employee cards based on view mode
            if (displayData.length === 0) {
                statsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No production data found for this period</p>';
            } else {
                const sortedEmployees = displayData.sort((a, b) => {
                    if (viewMode === 'packaging') return b.packaging.units - a.packaging.units;
                    if (viewMode === 'labeling') return b.labeling.units - a.labeling.units;
                    if (viewMode === 'extraction') return b.extraction.batches - a.extraction.batches;
                    return (b.packaging.units + b.labeling.units) - (a.packaging.units + a.labeling.units);
                });
                
                statsContainer.innerHTML = sortedEmployees.map(emp => {
                    const packagingTarget = targets.packaging * emp.daysActiveCount;
                    const labelingTarget = targets.labeling * emp.daysActiveCount;
                    const extractionTrimTarget = (targets.extractionTrim || 11200) * emp.daysActiveCount;
                    
                    const packagingPct = packagingTarget > 0 ? ((emp.packaging.units / packagingTarget) * 100).toFixed(0) : 0;
                    const labelingPct = labelingTarget > 0 ? ((emp.labeling.units / labelingTarget) * 100).toFixed(0) : 0;
                    const extractionPct = extractionTrimTarget > 0 ? ((emp.extraction.trimWeight / extractionTrimTarget) * 100).toFixed(0) : 0;
                    
                    // Determine performance color
                    const getPerformanceColor = (pct) => {
                        if (pct >= 90) return 'var(--accent-green)';
                        if (pct >= 70) return 'var(--accent-blue)';
                        if (pct >= 50) return 'var(--accent-orange)';
                        return 'var(--accent-red)';
                    };
                    
                    let detailSection = '';
                    
                    if (viewMode === 'overview' || viewMode === 'packaging') {
                        const productBreakdown = Object.entries(emp.packaging.byProduct)
                            .sort((a, b) => b[1] - a[1])
                            .map(([product, units]) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>${product}</span>
                                    <span style="font-weight: 700; font-family: 'Space Mono', monospace;">${units} units</span>
                                </div>
                            `).join('');
                        
                        detailSection += `
                            <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: var(--accent-blue); font-size: 1.1rem;">üì¶ Packaging Performance</h4>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: ${getPerformanceColor(packagingPct)};">${packagingPct}%</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Total Units</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${emp.packaging.units.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Per Day</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${emp.packaging.perDay}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Batches</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">${emp.packaging.batches}</div>
                                    </div>
                                </div>
                                
                                ${Object.keys(emp.packaging.byProduct).length > 0 ? `
                                    <div style="border-top: 2px solid var(--border); padding-top: 15px;">
                                        <h5 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;">By Product Type:</h5>
                                        ${productBreakdown}
                                    </div>
                                ` : ''}
                                
                                <div style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${getPerformanceColor(packagingPct)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-secondary);">Target: ${targets.packaging}/day √ó ${emp.daysActiveCount} days</span>
                                        <span style="font-weight: 700;">${emp.packaging.units} / ${packagingTarget}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (viewMode === 'overview' || viewMode === 'labeling') {
                        detailSection += `
                            <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: var(--accent-green); font-size: 1.1rem;">üè∑Ô∏è Labeling Performance</h4>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: ${getPerformanceColor(labelingPct)};">${labelingPct}%</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Total Units</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${emp.labeling.units.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Per Day</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${emp.labeling.perDay}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Batches</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">${emp.labeling.batches}</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${getPerformanceColor(labelingPct)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-secondary);">Target: ${targets.labeling}/day √ó ${emp.daysActiveCount} days</span>
                                        <span style="font-weight: 700;">${emp.labeling.units} / ${labelingTarget}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (viewMode === 'overview' || viewMode === 'extraction') {
                        detailSection += `
                            <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: var(--accent-orange); font-size: 1.1rem;">üß™ Extraction Performance</h4>
                                    <span style="font-size: 1.5rem; font-weight: 700; color: ${getPerformanceColor(extractionPct)};">${extractionPct}%</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Batches</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange);">${emp.extraction.batches}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Total Runs</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${emp.extraction.runs}</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Trim (g)</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${emp.extraction.trimWeight.toFixed(0)}</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${getPerformanceColor(extractionPct)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-secondary);">Trim Target: ${targets.extractionTrim || 11200}g/day √ó ${emp.daysActiveCount} days</span>
                                        <span style="font-weight: 700;">${emp.extraction.trimWeight.toFixed(0)}g / ${extractionTrimTarget.toFixed(0)}g</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 15px; border: 2px solid var(--border); margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 5px; color: var(--accent-purple);">
                                        ${emp.name}
                                        ${(() => {
                                            // Find PIN for this employee
                                            const roleEntry = Object.entries(ROLES).find(([key, role]) => role.name === emp.name);
                                            return roleEntry ? ` - PIN: ${roleEntry[1].pin}` : '';
                                        })()}
                                    </h3>
                                    <p style="color: var(--text-secondary); font-size: 0.95rem;">Active ${emp.daysActiveCount} of ${timeRange} days</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">${(emp.packaging.units + emp.labeling.units).toLocaleString()}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Units</div>
                                </div>
                            </div>
                            
                            ${detailSection}
                        </div>
                    `;
                }).join('');
            }
            
            // Staffing recommendations (only show when viewing all employees)
            if (staffingContainer && filter === 'all') {
                const totalPackaging = Object.values(employeeData).reduce((sum, e) => sum + e.packaging.units, 0);
                const totalLabeling = Object.values(employeeData).reduce((sum, e) => sum + e.labeling.units, 0);
                const avgDailyPackaging = totalPackaging / timeRange;
                const avgDailyLabeling = totalLabeling / timeRange;
                const activeEmployees = Object.keys(employeeData).length;
                
                const packagingCapacity = activeEmployees * targets.packaging;
                const labelingCapacity = activeEmployees * targets.labeling;
                
                const packagingUtilization = packagingCapacity > 0 ? ((avgDailyPackaging / packagingCapacity) * 100).toFixed(0) : 0;
                const labelingUtilization = labelingCapacity > 0 ? ((avgDailyLabeling / labelingCapacity) * 100).toFixed(0) : 0;
                
                // Calculate needed employees to meet different inventory targets
                const inventoryTargets = [500, 1000, 1500, 2000];
                
                staffingContainer.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 15px; border: 2px solid var(--accent-green);">
                        <h3 style="color: var(--accent-green); margin-bottom: 20px; font-size: 1.4rem;">üéØ Capacity & Staffing Analysis</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Packaging Capacity Utilization</div>
                                <div style="font-size: 2.5rem; font-weight: 700; color: ${packagingUtilization >= 80 ? 'var(--accent-red)' : packagingUtilization >= 60 ? 'var(--accent-orange)' : 'var(--accent-green)'};">${packagingUtilization}%</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">${avgDailyPackaging.toFixed(0)} / ${packagingCapacity} units per day</div>
                            </div>
                            
                            <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Labeling Capacity Utilization</div>
                                <div style="font-size: 2.5rem; font-weight: 700; color: ${labelingUtilization >= 80 ? 'var(--accent-red)' : labelingUtilization >= 60 ? 'var(--accent-orange)' : 'var(--accent-green)'};">${labelingUtilization}%</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">${avgDailyLabeling.toFixed(0)} / ${labelingCapacity} units per day</div>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px;">
                            <h4 style="margin-bottom: 15px; color: var(--accent-blue);">Staffing to Meet Daily Production Targets:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${inventoryTargets.map(target => {
                                    const packagingNeeded = Math.ceil(target / targets.packaging);
                                    const labelingNeeded = Math.ceil(target / targets.labeling);
                                    const maxNeeded = Math.max(packagingNeeded, labelingNeeded);
                                    const diff = maxNeeded - activeEmployees;
                                    
                                    return `
                                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid ${diff > 0 ? 'var(--accent-orange)' : 'var(--accent-green)'};">
                                            <div style="font-weight: 700; font-size: 1.3rem; margin-bottom: 8px; color: var(--accent-purple);">${target} units/day</div>
                                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Packaging: ${packagingNeeded} employees</div>
                                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">Labeling: ${labelingNeeded} employees</div>
                                            <div style="font-weight: 600; color: ${diff > 0 ? 'var(--accent-orange)' : 'var(--accent-green)'};">
                                                ${diff > 0 ? `Need +${diff} more` : diff < 0 ? `${Math.abs(diff)} extra capacity` : '‚úì Fully staffed'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (staffingContainer) {
                staffingContainer.innerHTML = '';
            }
            
            // Render activity log
            if (logContainer) {
                const activities = [];
                batches.forEach(batch => {
                    if (batch.timeline && Array.isArray(batch.timeline)) {
                        batch.timeline.forEach(event => {
                            const eventDate = new Date(event.timestamp || event.date);
                            if (eventDate >= rangeStart) {
                                activities.push({
                                    ...event,
                                    batchId: batch.id,
                                    strain: batch.strain,
                                    date: eventDate,
                                    units: batch.units_packaged || 0
                                });
                            }
                        });
                    }
                });
                
                const filteredActivities = filter === 'all' 
                    ? activities 
                    : activities.filter(a => a.user === filter);
                
                const sortedActivities = filteredActivities.sort((a, b) => b.date - a.date);
                
                if (sortedActivities.length === 0) {
                    logContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No activities to display</p>';
                } else {
                    logContainer.innerHTML = `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border);">
                                        <th style="padding: 15px; text-align: left; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Date</th>
                                        <th style="padding: 15px; text-align: left; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Employee</th>
                                        <th style="padding: 15px; text-align: left; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Action</th>
                                        <th style="padding: 15px; text-align: left; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Batch</th>
                                        <th style="padding: 15px; text-align: left; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Strain</th>
                                        <th style="padding: 15px; text-align: right; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Units</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedActivities.slice(0, 100).map(activity => {
                                        const isCompletion = activity.action && (
                                            activity.action.toLowerCase().includes('completed') ||
                                            activity.action.toLowerCase().includes('labeled')
                                        );
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid var(--border);">
                                                <td style="padding: 12px; color: var(--text-secondary); font-size: 0.95rem;">${activity.date.toLocaleDateString()} ${activity.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                                <td style="padding: 12px; font-weight: 600; font-size: 0.95rem;">${activity.user}</td>
                                                <td style="padding: 12px;">
                                                    <span style="background: rgba(147, 51, 234, 0.2); color: var(--accent-purple); padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; text-transform: capitalize;">
                                                        ${activity.stage || 'unknown'}
                                                    </span>
                                                    ${isCompletion ? '<span style="margin-left: 8px; color: var(--accent-green);">‚úì</span>' : ''}
                                                </td>
                                                <td style="padding: 12px; font-family: 'Space Mono', monospace; font-size: 0.95rem;">${activity.batchId}</td>
                                                <td style="padding: 12px; color: var(--text-secondary); font-size: 0.95rem;">${activity.strain}</td>
                                                <td style="padding: 12px; text-align: right; font-weight: 700; font-family: 'Space Mono', monospace; font-size: 0.95rem;">${isCompletion && activity.units > 0 ? activity.units : '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${sortedActivities.length > 100 ? '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">Showing most recent 100 activities</p>' : ''}
                    `;
                }
            }
        }

        
        // Analytics filter buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-btn') && e.target.dataset.filterAnalytics) {
                document.querySelectorAll('[data-filter-analytics]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                const filter = e.target.dataset.filterAnalytics;
                let filteredBatches = batches.filter(b => b.status === 'complete' && b.units_packaged);
                
                if (filter === 'thisMonth') {
                    const now = new Date();
                    const thisMonth = now.getMonth();
                    const thisYear = now.getFullYear();
                    filteredBatches = filteredBatches.filter(b => {
                        const date = new Date(b.completed_at);
                        return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
                    });
                } else if (filter === 'lastMonth') {
                    const now = new Date();
                    const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                    const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                    filteredBatches = filteredBatches.filter(b => {
                        const date = new Date(b.completed_at);
                        return date.getMonth() === lastMonth && date.getFullYear() === year;
                    });
                }
                
                renderAnalyticsTable(filteredBatches);
            }
        });

        // Edit Batch Functions
        function openEditBatch(batchId) {
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;
            
            // Store original batch ID in hidden field
            document.getElementById('originalBatchId').value = batch.id;
            
            // Populate form
            document.getElementById('editBatchId').value = batch.id;
            document.getElementById('editStrainName').value = batch.strain;
            document.getElementById('editStrainType').value = batch.strain_type;
            document.getElementById('editTrimWeight').value = batch.trim_weight;
            document.getElementById('editMaterialCost').value = batch.material_cost;
            document.getElementById('editCultivationLicense').value = batch.cultivation_license || '';
            document.getElementById('editGrowerName').value = batch.grower_name || '';
            document.getElementById('editMetrcTags').value = batch.metrc_tags || '';
            document.getElementById('editNotes').value = '';
            
            // Parse batch ID to extract info
            parseBatchIdForEdit(batch.id);
            
            // Show modal
            document.getElementById('editBatchModal').style.display = 'block';
        }

        // Parse batch ID to extract METRC last 4 and expiration date
        function parseBatchIdForEdit(batchId) {
            // Format: M.D.XXXX or MM.DD.XXXX
            const parts = batchId.split('.');
            
            if (parts.length === 3) {
                const month = parts[0];
                const day = parts[1];
                const last4 = parts[2];
                
                // Show parsed METRC last 4
                document.getElementById('parsedMetrcLast4').value = last4;
                
                // Calculate expiration date (use current/next year)
                const currentYear = new Date().getFullYear();
                const expMonth = parseInt(month, 10);
                const expDay = parseInt(day, 10);
                
                if (expMonth >= 1 && expMonth <= 12 && expDay >= 1 && expDay <= 31) {
                    // Create date - if it's in the past, use next year
                    let expDate = new Date(currentYear, expMonth - 1, expDay);
                    const today = new Date();
                    
                    if (expDate < today) {
                        expDate = new Date(currentYear + 1, expMonth - 1, expDay);
                    }
                    
                    document.getElementById('parsedExpirationDate').value = expDate.toISOString().split('T')[0];
                } else {
                    document.getElementById('parsedExpirationDate').value = '';
                }
            } else {
                // Invalid format
                document.getElementById('parsedMetrcLast4').value = '';
                document.getElementById('parsedExpirationDate').value = '';
            }
        }

        // Add event listener for batch ID changes
        document.getElementById('editBatchId').addEventListener('input', function() {
            parseBatchIdForEdit(this.value);
        });

        function closeEditBatch() {
            document.getElementById('editBatchModal').style.display = 'none';
        }

        async function saveEditedBatch() {
            const oldBatchId = document.getElementById('originalBatchId').value;
            const newBatchId = document.getElementById('editBatchId').value.trim();
            const batch = batches.find(b => b.id === oldBatchId);
            const editNotes = document.getElementById('editNotes').value;
            
            if (!batch) {
                alert('Error: Could not find batch to edit.');
                return;
            }
            
            if (!editNotes || editNotes.trim() === '') {
                alert('Please enter a note explaining why you\'re making this change.');
                return;
            }
            
            // Check if batch ID changed
            const batchIdChanged = oldBatchId !== newBatchId;
            
            if (batchIdChanged) {
                // Verify new batch ID doesn't already exist
                const existingBatch = batches.find(b => b.id === newBatchId);
                if (existingBatch && existingBatch.id !== oldBatchId) {
                    alert(`Error: Batch ID "${newBatchId}" already exists. Please choose a different ID.`);
                    return;
                }
                
                const confirmChange = confirm(
                    `‚ö†Ô∏è BATCH ID CHANGE\n\n` +
                    `Old ID: ${oldBatchId}\n` +
                    `New ID: ${newBatchId}\n\n` +
                    `This will update the batch ID and recalculate expiration date.\n\n` +
                    `Continue?`
                );
                
                if (!confirmChange) return;
            }
            
            // Collect updated values
            const updates = {
                strain: document.getElementById('editStrainName').value,
                strain_type: document.getElementById('editStrainType').value,
                trim_weight: parseFloat(document.getElementById('editTrimWeight').value),
                material_cost: parseFloat(document.getElementById('editMaterialCost').value),
                cultivation_license: document.getElementById('editCultivationLicense').value,
                grower_name: document.getElementById('editGrowerName').value,
                metrc_tags: document.getElementById('editMetrcTags').value || null
            };
            
            // If expiration date was parsed, update it
            const parsedExpDate = document.getElementById('parsedExpirationDate').value;
            if (parsedExpDate) {
                updates.test_expiration_date = parsedExpDate;
            }
            
            // Add edit to timeline
            const timeline = batch.timeline || [];
            const batchIdNote = batchIdChanged ? ` | Batch ID changed: ${oldBatchId} ‚Üí ${newBatchId}` : '';
            timeline.push({
                stage: 'edit',
                timestamp: new Date().toISOString(),
                user: currentRole.name,
                action: `Edited batch - ${editNotes}${batchIdNote}`
            });
            updates.timeline = timeline;
            
            // Handle batch ID change
            if (batchIdChanged) {
                // Create new batch with new ID
                const { error: insertError } = await supabaseClient
                    .from('wm_batches')
                    .insert({
                        ...batch,
                        ...updates,
                        id: newBatchId
                    });
                
                if (insertError) {
                    console.error('Error creating new batch:', insertError);
                    alert('Error updating batch ID. Please try again.');
                    return;
                }
                
                // Delete old batch
                const { error: deleteError } = await supabaseClient
                    .from('wm_batches')
                    .delete()
                    .eq('id', oldBatchId);
                
                if (deleteError) {
                    console.error('Error deleting old batch:', deleteError);
                    alert('Warning: New batch created but old batch could not be removed.');
                }
            } else {
                // Normal update
                const { error } = await supabaseClient
                    .from('wm_batches')
                    .update(updates)
                    .eq('id', oldBatchId);
                
                if (error) {
                    console.error('Error updating batch:', error);
                    alert('Error saving changes. Please try again.');
                    return;
                }
            }
            
            const finalBatchId = batchIdChanged ? newBatchId : oldBatchId;
            alert(`Batch ${finalBatchId} updated successfully!${batchIdChanged ? '\n‚úì Batch ID changed and expiration date updated' : ''}`);
            closeEditBatch();
            await loadBatches();
            renderBatches();
        }

        // Close modal when clicking outside
        document.getElementById('editBatchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditBatch();
            }
        });

        // ==============================================
        // CREATE SUB-BATCH FUNCTIONS
        // ==============================================

        function openCreateSubBatch(batchId) {
            const batch = batches.find(b => b.id === batchId);

            if (!batch) {
                alert('Batch not found: ' + batchId);
                return;
            }
            
            // Store parent batch ID
            document.getElementById('subBatchParentId').value = batchId;
            
            // Generate next available sub-batch ID
            const existingSubBatches = batches.filter(b => b.parent_batch_id === batchId || b.id.startsWith(batchId + '-'));
            
            const subBatchLetters = existingSubBatches.map(b => {
                const match = b.id.match(/-([A-Z]|SIFT)$/);
                return match ? match[1] : null;
            }).filter(l => l && l !== 'SIFT');
            
            let nextLetter = 'A';
            if (subBatchLetters.length > 0) {
                const lastLetter = subBatchLetters.sort().pop();
                nextLetter = String.fromCharCode(lastLetter.charCodeAt(0) + 1);
            }
            
            const newSubBatchId = `${batchId}-${nextLetter}`;
            document.getElementById('newSubBatchId').value = newSubBatchId;
            
            // Show parent batch info
            const parentInfo = `
                <p><strong>Batch ID:</strong> ${batch.id}</p>
                <p><strong>Product:</strong> ${batch.strain} (${batch.strain_type})</p>
                <p><strong>Product Made:</strong> ${batch.product_made || 'N/A'}</p>
                <p><strong>Final Weight:</strong> ${batch.final_weight || batch.net_weight || 'N/A'}g</p>
                <p><strong>Status:</strong> ${batch.status}</p>
                ${existingSubBatches.length > 0 ? `<p style="color: var(--accent-orange);"><strong>Existing Sub-Batches:</strong> ${existingSubBatches.map(b => b.id).join(', ')}</p>` : ''}
            `;
            document.getElementById('subBatchParentDetails').innerHTML = parentInfo;
            
            // Clear form
            document.getElementById('subBatchProductType').value = '';
            document.getElementById('subBatchNotes').value = '';
            
            // Show modal
            const modal = document.getElementById('createSubBatchModal');
            if (modal) {
                // Force hide first to ensure clean state
                modal.style.display = 'none';
                // Force browser repaint
                modal.offsetHeight;
                // Now show it
                modal.style.display = 'block';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';

                // Scroll to top in case modal is below fold
                window.scrollTo(0, 0);
            } else {
                console.error('Modal element not found!');
                alert('Error: Modal not found in DOM');
            }
        }

        function closeCreateSubBatch() {
            document.getElementById('createSubBatchModal').style.display = 'none';
        }

        async function saveSubBatch() {
            if (!currentRole) {
                alert('Please login first!');
                return;
            }
            
            const parentBatchId = document.getElementById('subBatchParentId').value;
            const parentBatch = batches.find(b => b.id === parentBatchId);
            
            if (!parentBatch) {
                alert('Parent batch not found');
                return;
            }
            
            const newSubBatchId = document.getElementById('newSubBatchId').value;
            const productType = document.getElementById('subBatchProductType').value;
            const notes = document.getElementById('subBatchNotes').value;
            
            if (!productType) {
                alert('Please select a product type');
                return;
            }
            
            if (!notes.trim()) {
                alert('Please enter a reason for creating this retroactive sub-batch');
                return;
            }
            
            // Calculate proportional trim used from parent
            const parentTrimWeight = parseFloat(parentBatch.adjusted_trim_weight || parentBatch.trim_weight || 0);
            
            // Get all existing sub-batches BEFORE creating new one
            const existingSubBatches = batches.filter(b => 
                (b.parent_batch_id === parentBatchId || b.id.startsWith(parentBatchId + '-')) && 
                b.id !== parentBatchId
            );
            
            // For now, allocate equal trim across all sub-batches (will be recalculated when weights are entered)
            const numSubBatches = existingSubBatches.length + 1; // Including new one
            const trimUsed = parentTrimWeight / numSubBatches;
            
            // Set status to 'extraction' so it must go through post-processing (finishing)
            // This ensures the post-processor completes it properly
            const newStatus = 'extraction';
            
            // Create sub-batch
            const subBatch = {
                id: newSubBatchId,
                strain: parentBatch.strain,
                strain_type: parentBatch.strain_type,
                trim_weight: trimUsed,
                material_cost: 0,
                material_agreement: parentBatch.material_agreement,
                pre_sift: 'no',
                cultivation_license: parentBatch.cultivation_license,
                grower_name: parentBatch.grower_name,
                metrc_tags: parentBatch.metrc_tags,
                intake_date: parentBatch.intake_date,
                planned_products: [productType],
                intake_notes: `Retroactive sub-batch created from ${parentBatchId}. ${notes}`,
                status: newStatus,
                intake_user: parentBatch.intake_user,
                
                // Mark as sub-batch
                is_sub_batch: true,
                parent_batch_id: parentBatchId,
                
                // Set extraction data (completed by extractor)
                extraction_date: parentBatch.extraction_date || new Date().toISOString().split('T')[0],
                extraction_method: parentBatch.extraction_method,
                product_made: productType,
                extraction_notes: `Retroactive sub-batch of ${parentBatchId} - needs post-processing`,
                extraction_user: parentBatch.extraction_user || currentRole.name,
                
                // NO finishing data yet - post-processor must complete this
                finishing_date: null,
                final_weight: null,
                sample_weight: null,
                net_weight: null,
                finishing_notes: `Retroactive sub-batch - awaiting post-processing`,
                finishing_user: null,
                
                timeline: [
                    {
                        stage: 'intake',
                        timestamp: parentBatch.intake_date,
                        user: parentBatch.intake_user,
                        action: 'Batch created (parent)'
                    },
                    {
                        stage: 'extraction',
                        timestamp: parentBatch.extraction_date || new Date().toISOString(),
                        user: parentBatch.extraction_user || currentRole.name,
                        action: `Extracted as ${productType} - retroactive sub-batch created by ${currentRole.name}`
                    }
                ],
                created_at: new Date().toISOString()
            };

            // Insert sub-batch
            const { error: insertError } = await supabaseClient
                .from('wm_batches')
                .insert([subBatch]);
            
            if (insertError) {
                console.error('Error creating sub-batch:', insertError);
                alert(`Error creating sub-batch: ${insertError.message}`);
                return;
            }
            
            // Update parent batch timeline
            const parentTimeline = parentBatch.timeline || [];
            parentTimeline.push({
                stage: 'admin',
                timestamp: new Date().toISOString(),
                user: currentRole.name,
                action: `Retroactive sub-batch created: ${newSubBatchId} (${productType}) - needs post-processing`
            });
            
            await supabaseClient
                .from('wm_batches')
                .update({ timeline: parentTimeline })
                .eq('id', parentBatchId);
            
            alert(`‚úÖ Sub-batch ${newSubBatchId} created successfully!\n\nProduct: ${productType}\nStatus: extraction\n\n‚öôÔ∏è NEXT STEP:\nPost-processor must complete this batch on the "Post Extraction" page to:\n‚Ä¢ Enter final bulk weight\n‚Ä¢ Enter sample weight\n‚Ä¢ Complete finishing\n\nYields will be recalculated when weights are entered.`);
            
            closeCreateSubBatch();
            await loadBatches();
            renderBatches();
            
            // Refresh finishing select
            populateFinishingSelect();
        }

        // Close modal when clicking outside
        document.getElementById('createSubBatchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateSubBatch();
            }
        });

        async function deleteSubBatch(subBatchId) {
            if (!currentRole || (currentRole.name !== 'Ryan (Admin)' && currentRole.name !== 'Alex')) {
                alert('Only Ryan and Alex can delete sub-batches');
                return;
            }
            
            const subBatch = batches.find(b => b.id === subBatchId);
            if (!subBatch) {
                alert('Sub-batch not found');
                return;
            }
            
            if (!subBatch.is_sub_batch) {
                alert('This is not a sub-batch. Only sub-batches can be deleted this way.');
                return;
            }
            
            const parentBatchId = subBatch.parent_batch_id;
            const parentBatch = batches.find(b => b.id === parentBatchId);
            
            const confirmation = confirm(
                `‚ö†Ô∏è DELETE SUB-BATCH?\n\n` +
                `Sub-Batch: ${subBatchId}\n` +
                `Product: ${subBatch.product_made || 'N/A'}\n` +
                `Weight: ${subBatch.final_weight || subBatch.net_weight || 'N/A'}g\n\n` +
                `This will:\n` +
                `‚Ä¢ Delete this sub-batch permanently\n` +
                `‚Ä¢ Recalculate yields for remaining sub-batches\n` +
                `‚Ä¢ Update parent batch timeline\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type YES to confirm deletion.`
            );
            
            if (!confirmation) return;
            
            const userConfirmation = prompt('Type YES in capital letters to confirm deletion:');
            if (userConfirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }
            
            // Delete the sub-batch
            const { error: deleteError } = await supabaseClient
                .from('wm_batches')
                .delete()
                .eq('id', subBatchId);
            
            if (deleteError) {
                console.error('Error deleting sub-batch:', deleteError);
                alert(`Error deleting sub-batch: ${deleteError.message}`);
                return;
            }
            
            // Recalculate remaining sub-batches if parent exists and has other sub-batches
            if (parentBatch) {
                const remainingSubBatches = batches.filter(b => 
                    b.parent_batch_id === parentBatchId && 
                    b.id !== subBatchId &&
                    b.final_weight // Only completed sub-batches
                );
                
                if (remainingSubBatches.length > 0) {
                    const parentTrimWeight = parseFloat(parentBatch.adjusted_trim_weight || parentBatch.trim_weight || 0);
                    const totalRemainingWeight = remainingSubBatches.reduce((sum, b) => 
                        sum + parseFloat(b.final_weight || b.net_weight || 0), 0
                    );
                    
                    // Recalculate trim for each remaining sub-batch
                    for (const sub of remainingSubBatches) {
                        const subWeight = parseFloat(sub.final_weight || sub.net_weight || 0);
                        const recalculatedTrim = (subWeight / totalRemainingWeight) * parentTrimWeight;
                        
                        await supabaseClient
                            .from('wm_batches')
                            .update({ trim_weight: recalculatedTrim })
                            .eq('id', sub.id);
                    }
                }
                
                // Update parent timeline
                const parentTimeline = parentBatch.timeline || [];
                parentTimeline.push({
                    stage: 'admin',
                    timestamp: new Date().toISOString(),
                    user: currentRole.name,
                    action: `Sub-batch ${subBatchId} deleted. Yields recalculated for remaining sub-batches.`
                });
                
                await supabaseClient
                    .from('wm_batches')
                    .update({ timeline: parentTimeline })
                    .eq('id', parentBatchId);
                
                const resultMessage = remainingSubBatches.length > 0 
                    ? '‚úì Remaining sub-batch yields recalculated' 
                    : '‚úì This was the last sub-batch';
                alert(`‚úÖ Sub-batch ${subBatchId} deleted successfully!\n\n${resultMessage}`);
            } else {
                alert(`‚úÖ Sub-batch ${subBatchId} deleted successfully!`);
            }
            
            await loadBatches();
            renderBatches();
            
            // Refresh all selects
            
            populateFinishingSelect();
            populatePackagingSelect();
            populateTestingSelect();
        }

        // ==============================================
        // METRC INTEGRATION FUNCTIONS
        // ==============================================

        let metrcManifests = [];
        let selectedManifest = null;
        let selectedTags = [];

        // Load METRC config from localStorage
        function loadMetrcConfig() {
            const integratorKey = localStorage.getItem('metrcIntegratorKey');
            const userKey = localStorage.getItem('metrcUserKey');
            const licenseNumber = localStorage.getItem('metrcLicenseNumber') || '404R-00016';
            
            if (integratorKey) {
                document.getElementById('metrcIntegratorKey').value = integratorKey;
            }
            if (userKey) {
                document.getElementById('metrcUserKey').value = userKey;
            }
            document.getElementById('metrcLicenseNumber').value = licenseNumber;
            
            if (integratorKey && userKey) {
                updateMetrcConfigStatus(true);
            } else {
                updateMetrcConfigStatus(false);
            }
        }

        function updateMetrcConfigStatus(configured) {
            const statusEl = document.getElementById('metrcConfigStatus');
            if (configured) {
                statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                statusEl.style.color = 'var(--accent-green)';
                statusEl.style.border = '2px solid var(--accent-green)';
                statusEl.textContent = '‚úì Configured';
            } else {
                statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                statusEl.style.color = 'var(--accent-red)';
                statusEl.style.border = '2px solid var(--accent-red)';
                statusEl.textContent = '‚ö† Not Configured';
            }
        }

        function saveMetrcConfig() {
            const integratorKey = document.getElementById('metrcIntegratorKey').value.trim();
            const userKey = document.getElementById('metrcUserKey').value.trim();
            const licenseNumber = document.getElementById('metrcLicenseNumber').value.trim();
            
            if (!integratorKey || !userKey || !licenseNumber) {
                alert('Please enter both Integrator Key and User API Key');
                return;
            }
            
            localStorage.setItem('metrcIntegratorKey', integratorKey);
            localStorage.setItem('metrcUserKey', userKey);
            localStorage.setItem('metrcLicenseNumber', licenseNumber);
            
            updateMetrcConfigStatus(true);
            alert('METRC credentials saved successfully!\n\nClick "Test Connection" to verify they work.');
        }

        async function testMetrcConnection() {
            const integratorKey = localStorage.getItem('metrcIntegratorKey');
            const userKey = localStorage.getItem('metrcUserKey');
            const licenseNumber = localStorage.getItem('metrcLicenseNumber');
            
            if (!integratorKey || !userKey || !licenseNumber) {
                showTestResult('error', 'Please save your credentials first.');
                return;
            }

            showTestResult('testing', 'Testing connection to METRC API...');

            try {
                // Try to get facilities as a simple test
                const url = `https://api-co.metrc.com/facilities/v1/`;
                
                // METRC requires: integratorKey:userKey
                const authString = `${integratorKey}:${userKey}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${btoa(authString)}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                if (response.ok) {
                    const data = await response.json();
                    showTestResult('success', `‚úÖ Connection successful!\n\nFound ${data.length} facilities in your account.\n\nAuthentication format is correct.\nYou can try loading manifests (may still face CORS).`);
                } else {
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.Message || JSON.stringify(errorData);
                    } catch (e) {
                        errorDetails = await response.text();
                    }

                    showTestResult('error', `‚ùå METRC returned ${response.status}\n\n${errorDetails}\n\nTroubleshooting:\n‚Ä¢ Verify Integrator Key is from METRC Connect\n‚Ä¢ Verify User API Key from Settings ‚Üí Integrations ‚Üí User API Keys\n‚Ä¢ Check if user has permissions for license 404R-00016\n‚Ä¢ Try Manual Entry instead`);
                }
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showTestResult('error', `üö´ Browser blocked the request (CORS)\n\nThis is expected - browsers block METRC API calls for security.\n\nSolutions:\n1. ‚úÖ Use Manual Entry tab (recommended)\n2. Set up a server proxy for API calls\n3. Use METRC web interface and copy data`);
                } else {
                    showTestResult('error', `‚ùå Connection failed:\n\n${error.message}`);
                }
            }
        }

        function showTestResult(type, message) {
            const resultEl = document.getElementById('metrcTestResult');
            resultEl.style.display = 'block';
            resultEl.style.padding = '15px';
            resultEl.style.borderRadius = '10px';
            resultEl.style.marginTop = '15px';
            resultEl.style.whiteSpace = 'pre-line';

            if (type === 'success') {
                resultEl.style.background = 'rgba(16, 185, 129, 0.2)';
                resultEl.style.border = '2px solid var(--accent-green)';
                resultEl.style.color = 'var(--accent-green)';
            } else if (type === 'error') {
                resultEl.style.background = 'rgba(239, 68, 68, 0.2)';
                resultEl.style.border = '2px solid var(--accent-red)';
                resultEl.style.color = 'var(--accent-red)';
            } else if (type === 'testing') {
                resultEl.style.background = 'rgba(245, 158, 11, 0.2)';
                resultEl.style.border = '2px solid var(--accent-orange)';
                resultEl.style.color = 'var(--accent-orange)';
            }

            resultEl.textContent = message;
        }

        function openMetrcImport() {
            document.getElementById('metrcImportModal').style.display = 'block';
            loadMetrcConfig();
            
            // Set default dates (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('metrcStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('metrcEndDate').value = endDate.toISOString().split('T')[0];
            
            // Default to manual entry tab (more reliable)
            switchMetrcTab('manual');
        }

        function closeMetrcImport() {
            document.getElementById('metrcImportModal').style.display = 'none';
            clearManifestSelection();
        }

        async function loadMetrcManifests() {
            const integratorKey = localStorage.getItem('metrcIntegratorKey');
            const userKey = localStorage.getItem('metrcUserKey');
            const licenseNumber = localStorage.getItem('metrcLicenseNumber');
            
            if (!integratorKey || !userKey || !licenseNumber) {
                showMetrcError('Please configure your METRC API credentials first (both Integrator and User keys required).');
                return;
            }
            
            const startDate = document.getElementById('metrcStartDate').value;
            const endDate = document.getElementById('metrcEndDate').value;
            
            if (!startDate || !endDate) {
                showMetrcError('Please select both start and end dates.');
                return;
            }
            
            // Show loading
            document.getElementById('metrcLoadingIndicator').style.display = 'block';
            document.getElementById('metrcManifestsList').style.display = 'none';
            document.getElementById('metrcError').style.display = 'none';
            
            try {
                // METRC API endpoint for incoming transfers
                const url = `https://api-co.metrc.com/transfers/v1/incoming?licenseNumber=${licenseNumber}&lastModifiedStart=${startDate}&lastModifiedEnd=${endDate}`;
                
                // METRC requires: integratorKey:userKey
                const authString = `${integratorKey}:${userKey}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${btoa(authString)}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    let errorMsg = `METRC API returned ${response.status}`;
                    
                    if (response.status === 401) {
                        errorMsg = `Authentication failed (401).\n\nTroubleshooting:\n‚Ä¢ Verify your Integrator Key is from METRC Connect\n‚Ä¢ Verify your User API Key from Settings ‚Üí Integrations ‚Üí User API Keys\n‚Ä¢ Format must be integratorKey:userKey (done automatically)\n‚Ä¢ Check that user has permissions for license 404R-00016\n‚Ä¢ User must have access to view incoming transfers`;
                    } else if (response.status === 403) {
                        errorMsg = `Access forbidden (403).\n\nThe user may not have permission to access transfers for this license.`;
                    } else if (response.status === 404) {
                        errorMsg = `Endpoint not found (404).\n\nThe license number may be incorrect.`;
                    }
                    
                    // Try to get more details from response
                    try {
                        const errorData = await response.json();
                        if (errorData.Message) {
                            errorMsg += `\n\nMETRC says: ${errorData.Message}`;
                        }
                    } catch (e) {
                        // Response wasn't JSON
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                metrcManifests = data;
                
                if (metrcManifests.length === 0) {
                    showMetrcError('No incoming transfers found for the selected date range.');
                    return;
                }
                
                displayManifests();
                
            } catch (error) {
                console.error('METRC API Error:', error);
                
                // Check if it's a CORS error
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    showMetrcError(`‚ö†Ô∏è Browser Security Block Detected\n\nDirect API calls from browsers are often blocked by CORS.\n\nOptions:\n1. Use METRC's web interface to export manifests\n2. Set up a server-side proxy (recommended for production)\n3. Use a browser extension to disable CORS (development only)\n\nOriginal error: ${error.message}`);
                } else {
                    showMetrcError(error.message);
                }
            } finally {
                document.getElementById('metrcLoadingIndicator').style.display = 'none';
            }
        }

        function showMetrcError(message) {
            const errorEl = document.getElementById('metrcError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function displayManifests() {
            const container = document.getElementById('manifestsContainer');
            
            container.innerHTML = metrcManifests.map((manifest, index) => {
                const manifestDate = new Date(manifest.ReceivedDateTime || manifest.CreatedDate).toLocaleDateString();
                const packageCount = manifest.Deliveries ? manifest.Deliveries.reduce((sum, d) => sum + (d.Packages?.length || 0), 0) : 0;
                
                return `
                    <div onclick="selectManifest(${index})" style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; border: 2px solid var(--border); transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-purple); font-family: 'Space Mono', monospace; margin-bottom: 5px;">
                                    Manifest #${manifest.ManifestNumber || manifest.Id}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    ${manifestDate} ‚Ä¢ ${packageCount} packages
                                </div>
                            </div>
                            <div style="background: rgba(147, 51, 234, 0.2); color: var(--accent-purple); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                Click to View
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">Shipper</div>
                                <div style="font-weight: 600; font-size: 0.95rem;">${manifest.ShipperFacilityName || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">Shipper License</div>
                                <div style="font-weight: 600; font-size: 0.95rem; font-family: 'Space Mono', monospace;">${manifest.ShipperFacilityLicenseNumber || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('metrcManifestsList').style.display = 'block';
            document.getElementById('metrcError').style.display = 'none';
        }

        function selectManifest(index) {
            selectedManifest = metrcManifests[index];
            selectedTags = [];
            
            // Display manifest details
            const manifestInfo = document.getElementById('manifestInfo');
            const manifestDate = new Date(selectedManifest.ReceivedDateTime || selectedManifest.CreatedDate);
            
            manifestInfo.innerHTML = `
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Manifest Number</div>
                    <div style="font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700;">${selectedManifest.ManifestNumber || selectedManifest.Id}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Received Date</div>
                    <div style="font-weight: 600;">${manifestDate.toLocaleDateString()} ${manifestDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Shipper Name</div>
                    <div style="font-weight: 600;">${selectedManifest.ShipperFacilityName || 'N/A'}</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Shipper License (403R)</div>
                    <div style="font-family: 'Space Mono', monospace; font-weight: 700; color: var(--accent-blue);">${selectedManifest.ShipperFacilityLicenseNumber || 'N/A'}</div>
                </div>
            `;
            
            // Display packages/tags
            displayManifestTags();
            
            // Show details section, hide manifests list
            document.getElementById('metrcManifestsList').style.display = 'none';
            document.getElementById('manifestDetailsSection').style.display = 'block';
        }

        function displayManifestTags() {
            const container = document.getElementById('tagsContainer');
            
            // Extract all packages from all deliveries
            let allPackages = [];
            if (selectedManifest.Deliveries) {
                selectedManifest.Deliveries.forEach(delivery => {
                    if (delivery.Packages) {
                        allPackages = allPackages.concat(delivery.Packages);
                    }
                });
            }
            
            // Filter for trim/shake packages only
            const trimPackages = allPackages.filter(pkg => {
                const productName = (pkg.ProductName || '').toLowerCase();
                const productCategory = (pkg.ProductCategoryName || '').toLowerCase();
                return productName.includes('trim') || productName.includes('shake') || 
                       productCategory.includes('trim') || productCategory.includes('shake');
            });
            
            if (trimPackages.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; padding: 20px; text-align: center;">No trim or shake packages found in this manifest.</div>';
                return;
            }
            
            container.innerHTML = trimPackages.map((pkg, index) => {
                const tagNumber = pkg.PackageLabel || pkg.Label || 'N/A';
                const shortTag = tagNumber.length > 10 ? tagNumber.slice(-5) : tagNumber;
                const weight = parseFloat(pkg.Quantity || pkg.ShippedQuantity || 0);
                const unitWeight = pkg.UnitOfMeasureName || 'Grams';
                const strain = pkg.ProductName || 'Unknown Strain';
                
                return `
                    <label style="background: var(--bg-primary); padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 15px;" 
                           onmouseover="this.style.borderColor='var(--accent-purple)'" 
                           onmouseout="this.style.borderColor=document.getElementById('tagCheck${index}').checked ? 'var(--accent-purple)' : 'var(--border)'">
                        <input type="checkbox" id="tagCheck${index}" 
                               onchange="toggleTag(${index}, '${tagNumber}', ${weight}, '${strain}')"
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--accent-purple);">
                                        Tag: ...${shortTag}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 3px;">${tagNumber}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${weight.toFixed(1)}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.85rem;">${unitWeight}</div>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                <strong>Product:</strong> ${strain}
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
            
            updateSelectedSummary();
        }

        function toggleTag(index, tagNumber, weight, strain) {
            const checkbox = document.getElementById(`tagCheck${index}`);
            
            if (checkbox.checked) {
                selectedTags.push({ tagNumber, weight, strain });
            } else {
                selectedTags = selectedTags.filter(t => t.tagNumber !== tagNumber);
            }
            
            updateSelectedSummary();
        }

        function updateSelectedSummary() {
            const summary = document.getElementById('selectedTagsSummary');
            
            if (selectedTags.length === 0) {
                summary.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No tags selected. Select tags above to continue.</div>';
                return;
            }
            
            const totalWeight = selectedTags.reduce((sum, tag) => sum + tag.weight, 0);
            const uniqueStrains = [...new Set(selectedTags.map(t => t.strain))];
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: var(--bg-primary); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Tags Selected</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">${selectedTags.length}</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Total Weight</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${totalWeight.toFixed(1)}g</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Unique Strains</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${uniqueStrains.length}</div>
                    </div>
                </div>
                <div style="background: var(--bg-primary); padding: 15px; border-radius: 10px;">
                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">Selected Tags:</div>
                    ${selectedTags.map(tag => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="font-family: 'Space Mono', monospace; font-size: 0.9rem;">...${tag.tagNumber.slice(-5)}</span>
                            <span style="font-weight: 600; color: var(--accent-green);">${tag.weight.toFixed(1)}g</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function clearManifestSelection() {
            selectedManifest = null;
            selectedTags = [];
            document.getElementById('manifestDetailsSection').style.display = 'none';
            if (metrcManifests.length > 0) {
                document.getElementById('metrcManifestsList').style.display = 'block';
            }
        }

        function importManifestToBatch() {
            if (selectedTags.length === 0) {
                alert('Please select at least one tag to import.');
                return;
            }
            
            const totalWeight = selectedTags.reduce((sum, tag) => sum + tag.weight, 0);
            const uniqueStrains = [...new Set(selectedTags.map(t => t.strain))];
            const tagNumbers = selectedTags.map(t => t.tagNumber.slice(-5)).join(', ');
            
            // Determine strain name
            let strainName = uniqueStrains.length === 1 ? uniqueStrains[0] : 'Mixed Strains';
            
            // Pre-fill the intake form
            document.getElementById('trimWeight').value = totalWeight.toFixed(1);
            document.getElementById('cultivationLicense').value = selectedManifest.ShipperFacilityLicenseNumber || '';
            document.getElementById('growerName').value = selectedManifest.ShipperFacilityName || '';
            document.getElementById('metrcTags').value = tagNumbers;
            document.getElementById('strainName').value = strainName;
            document.getElementById('intakeDate').value = new Date(selectedManifest.ReceivedDateTime || selectedManifest.CreatedDate).toISOString().split('T')[0];
            
            // Close modal and switch to intake tab
            closeMetrcImport();
            
            // Switch to intake tab
            document.querySelectorAll('.station-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.station-content').forEach(content => content.classList.remove('active'));
            document.querySelector('[data-station="intake"]').classList.add('active');
            document.getElementById('intake').classList.add('active');
            
            alert(`‚úÖ Imported ${selectedTags.length} tags (${totalWeight.toFixed(1)}g total)\n\nPlease review and complete the intake form.`);
        }

        // Close METRC modal when clicking outside
        document.getElementById('metrcImportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMetrcImport();
            }
        });

        // Tab switching for METRC modal
        function switchMetrcTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.metrc-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.style.borderBottom = '3px solid var(--accent-purple)';
                    btn.style.color = 'var(--accent-purple)';
                    btn.classList.add('active');
                } else {
                    btn.style.borderBottom = '3px solid transparent';
                    btn.style.color = 'var(--text-secondary)';
                    btn.classList.remove('active');
                }
            });

            // Show/hide sections
            if (tab === 'api') {
                document.getElementById('metrcLoadSection').style.display = 'block';
                document.getElementById('metrcManualSection').style.display = 'none';
            } else {
                document.getElementById('metrcLoadSection').style.display = 'none';
                document.getElementById('metrcManualSection').style.display = 'block';
                updateManualSummary();
            }
        }

        // Manual package entry
        function addManualPackageRow() {
            const container = document.getElementById('manualPackagesContainer');
            const newRow = document.createElement('div');
            newRow.className = 'manual-package-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            newRow.innerHTML = `
                <div class="form-group" style="margin: 0;">
                    <input type="text" class="manual-tag-number" placeholder="1A4060300001234567890">
                </div>
                <div class="form-group" style="margin: 0;">
                    <input type="number" class="manual-tag-weight" step="0.1" placeholder="0">
                </div>
                <div class="form-group" style="margin: 0;">
                    <input type="text" class="manual-tag-strain" placeholder="Strain name">
                </div>
                <button onclick="this.parentElement.remove(); updateManualSummary();" 
                        style="padding: 10px 15px; background: var(--accent-red); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                    ‚úï
                </button>
            `;
            container.appendChild(newRow);

            // Add event listeners for auto-summary update
            newRow.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateManualSummary);
            });
        }

        function updateManualSummary() {
            const rows = document.querySelectorAll('.manual-package-row');
            const packages = [];
            
            rows.forEach(row => {
                const tag = row.querySelector('.manual-tag-number')?.value || '';
                const weight = parseFloat(row.querySelector('.manual-tag-weight')?.value) || 0;
                const strain = row.querySelector('.manual-tag-strain')?.value || '';
                
                if (tag && weight > 0) {
                    packages.push({ tag, weight, strain });
                }
            });

            const summaryEl = document.getElementById('manualSummary');
            
            if (packages.length === 0) {
                summaryEl.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">Enter package details above to see summary</div>';
                return;
            }

            const totalWeight = packages.reduce((sum, pkg) => sum + pkg.weight, 0);
            const uniqueStrains = [...new Set(packages.map(p => p.strain).filter(s => s))];

            summaryEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple);">${packages.length}</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Packages</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">${totalWeight.toFixed(1)}g</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Total Weight</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${uniqueStrains.length}</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Unique Strains</div>
                    </div>
                </div>
                <div style="font-size: 0.9rem;">
                    ${packages.map(pkg => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border);">
                            <span style="font-family: 'Space Mono', monospace; font-size: 0.85rem;">...${pkg.tag.slice(-5)}</span>
                            <span style="color: var(--text-secondary);">${pkg.strain || 'Unknown'}</span>
                            <span style="font-weight: 600; color: var(--accent-green);">${pkg.weight.toFixed(1)}g</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function importManualManifest() {
            const manifestNumber = document.getElementById('manualManifestNumber').value.trim();
            const receivedDate = document.getElementById('manualReceivedDate').value;
            const shipperName = document.getElementById('manualShipperName').value.trim();
            const shipperLicense = document.getElementById('manualShipperLicense').value.trim();

            if (!manifestNumber || !receivedDate) {
                alert('Please enter at least the manifest number and received date.');
                return;
            }

            const rows = document.querySelectorAll('.manual-package-row');
            const packages = [];
            
            rows.forEach(row => {
                const tag = row.querySelector('.manual-tag-number')?.value || '';
                const weight = parseFloat(row.querySelector('.manual-tag-weight')?.value) || 0;
                const strain = row.querySelector('.manual-tag-strain')?.value || '';
                
                if (tag && weight > 0) {
                    packages.push({ tag, weight, strain });
                }
            });

            if (packages.length === 0) {
                alert('Please add at least one package with tag and weight.');
                return;
            }

            const totalWeight = packages.reduce((sum, pkg) => sum + pkg.weight, 0);
            const uniqueStrains = [...new Set(packages.map(p => p.strain).filter(s => s))];
            const tagNumbers = packages.map(p => p.tag.slice(-5)).join(', ');
            const strainName = uniqueStrains.length === 1 ? uniqueStrains[0] : 'Mixed Strains';

            // Pre-fill the intake form
            document.getElementById('trimWeight').value = totalWeight.toFixed(1);
            document.getElementById('cultivationLicense').value = shipperLicense;
            document.getElementById('growerName').value = shipperName;
            document.getElementById('metrcTags').value = tagNumbers;
            document.getElementById('strainName').value = strainName;
            document.getElementById('intakeDate').value = receivedDate;
            
            // Add manifest number to notes
            const notesField = document.getElementById('intakeNotes');
            notesField.value = `METRC Manifest #${manifestNumber}${notesField.value ? '\n\n' + notesField.value : ''}`;

            // Close modal and switch to intake tab
            closeMetrcImport();
            
            document.querySelectorAll('.station-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.station-content').forEach(content => content.classList.remove('active'));
            document.querySelector('[data-station="intake"]').classList.add('active');
            document.getElementById('intake').classList.add('active');
            
            alert(`‚úÖ Imported ${packages.length} packages (${totalWeight.toFixed(1)}g total)\n\nPlease review and complete the intake form.`);
        }

        // Add event listener to first manual package row
        document.addEventListener('DOMContentLoaded', function() {
            const firstRow = document.querySelector('.manual-package-row');
            if (firstRow) {
                firstRow.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', updateManualSummary);
                });
            }
            
            // Load production targets
            loadTargets();
        });

    </script>
</body>
</html>
